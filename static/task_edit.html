<!DOCTYPE html>
<html class="dark-theme" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É - Task Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="auth-check.js?v=13"></script>
    <script src="webapp-navigation-loader.js"></script>
    <script src="webapp-user-resolver.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <link rel="stylesheet" href="webapp-styles.css?v=13">
</head>
<body>
    <div class="unified-page-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ —Å—Ç–∏–ª–µ dashboard -->
        <div class="unified-page-header">
            <button class="back-button" onclick="goBack()">
                <span class="back-button-icon">‚Üê</span>
            </button>
            <h1 class="unified-page-title">
                <span class="unified-page-title-icon">‚úèÔ∏è</span>
                <span class="unified-page-title-text">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</span>
            </h1>
            <div class="unified-action-group">
                <button class="hamburger-menu" onclick="toggleNavigationMenu()">
                    <span class="hamburger-icon">‚ò∞</span>
                </button>
            </div>
        </div>

        <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
        <div class="navigation-menu" id="navigation-menu">
            <div class="navigation-menu-header">
                <h3>üß≠ –ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
                <button class="close-menu" onclick="toggleNavigationMenu()">‚úï</button>
            </div>
            <div class="navigation-menu-content">
                <div class="navigation-sections">
                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>

        <!-- Overlay –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é -->
        <div class="menu-overlay" id="menu-overlay" onclick="toggleNavigationMenu()"></div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="unified-content-section">
            <div class="card">
                <form id="edit-form" class="form">
                    <div class="form-group">
                        <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                        <input type="text" id="title" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="description" class="form-control" rows="4" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="date">–î–∞—Ç–∞</label>
                        <input type="date" id="date" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="time">–í—Ä–µ–º—è</label>
                        <input type="time" id="time" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                        <select id="priority" class="form-control">
                            <option value="–æ–±—ã—á–Ω–∞—è">–û–±—ã—á–Ω–∞—è</option>
                            <option value="–≤–∞–∂–Ω–∞—è">–í–∞–∂–Ω–∞—è</option>
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="goBack()">
                            <span>‚Üê</span>
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <span>üíæ</span>
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }

        function toggleNavigationMenu() {
            const menu = document.getElementById('navigation-menu');
            const overlay = document.getElementById('menu-overlay');
            
            if (menu.classList.contains('open')) {
                menu.classList.remove('open');
                overlay.classList.remove('open');
            } else {
                menu.classList.add('open');
                overlay.classList.add('open');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø–æ Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const menu = document.getElementById('navigation-menu');
                if (menu.classList.contains('open')) {
                    toggleNavigationMenu();
                }
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            AuthCheck.initAuthCheck(
                // Callback –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                (userId) => {
                    console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
                    initializeTelegram();
                    loadTask();
                },
                // Callback –¥–ª—è –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                () => {
                    console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
                }
            );
        });

        function initializeTelegram() {
            if (window.Telegram?.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
            }
        }

        const params = new URLSearchParams(location.search);
        const taskId = params.get("id");

        async function loadTask() {
            try {
                console.log('üìù –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ID:', taskId);
                const userId = await getDbUserId();
                if (!userId) {
                    console.error('‚ùå User ID –Ω–µ –ø–æ–ª—É—á–µ–Ω');
                    alert('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                    return;
                }
                console.log('‚úÖ User ID –ø–æ–ª—É—á–µ–Ω:', userId);

                const res = await fetch(`/api/tasks/${taskId}?user_id=${userId}`);
                if (!res.ok) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', res.status);
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á–∏');
                }

                const task = await res.json();
                window.taskUserId = userId;
                
                if (!task) {
                    alert("–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
                    return;
                }

                document.getElementById("title").value = task.title;
                document.getElementById("description").value = task.description || "";
                
                if (task.due_date) {
                    const dt = luxon.DateTime.fromISO(task.due_date).toLocal();
                    document.getElementById("date").value = dt.toFormat("yyyy-MM-dd");
                    if (task.due_date.length > 10) {
                        document.getElementById("time").value = dt.toFormat("HH:mm");
                    }
                }
                
                document.getElementById("priority").value = task.priority;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á–∏:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á–∏');
            }
        }

        document.getElementById("edit-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            
            try {
                const userId = window.taskUserId || await getDbUserId();
                console.log('üìù –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞—á—É, user_id:', userId);
                
                const updated = {
                    title: document.getElementById("title").value,
                    description: document.getElementById("description").value,
                    due_date: document.getElementById("date").value,
                    priority: document.getElementById("priority").value,
                    user_id: userId
                };
                
                const res = await fetch(`/api/tasks/${taskId}?user_id=${userId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updated)
                });
                
                if (res.ok) {
                    console.log('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                    alert("‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
                    window.location.href = "tasks.html";
                } else {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', res.status);
                    const error = await res.json();
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
            }
        });
    </script>
</body>
</html>