<!DOCTYPE html>
<html class="dark-theme" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç - Task Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="auth-check.js?v=13"></script>
    <script src="webapp-navigation-loader.js"></script>
    <script src="webapp-user-resolver.js"></script>
    <link rel="stylesheet" href="webapp-styles.css?v=13">
</head>
<body>
    <div class="unified-page-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ —Å—Ç–∏–ª–µ dashboard -->
        <div class="unified-page-header">
            <button class="back-button" onclick="goBack()">
                <span class="back-button-icon">‚Üê</span>
            </button>
            <h1 class="unified-page-title">
                <span class="unified-page-title-icon">üÜï</span>
                <span class="unified-page-title-text">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</span>
            </h1>
            <div class="unified-action-group">
                <button class="hamburger-menu" onclick="toggleNavigationMenu()">
                    <span class="hamburger-icon">‚ò∞</span>
                </button>
            </div>
        </div>

        <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
        <div class="navigation-menu" id="navigation-menu">
            <div class="navigation-menu-header">
                <h3>üß≠ –ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
                <button class="close-menu" onclick="toggleNavigationMenu()">‚úï</button>
            </div>
            <div class="navigation-menu-content">
                <div class="navigation-sections">
                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>

        <!-- Overlay –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é -->
        <div class="menu-overlay" id="menu-overlay" onclick="toggleNavigationMenu()"></div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="unified-content-section">
            <div class="card">
                <form id="create-form" class="form">
                    <div class="form-group">
                        <label for="project-name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                        <input type="text" id="project-name" required class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –°–µ–º—å—è, –†–µ–º–æ–Ω—Ç, –ü—Ä–æ–µ–∫—Ç A" />
                    </div>

                    <div class="form-group">
                        <label for="project-color" class="form-label">–¶–≤–µ—Ç –ø—Ä–æ–µ–∫—Ç–∞</label>
                        <input type="color" id="project-color" value="#4f46e5" class="form-control" style="padding: 8px; height: 48px;" />
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="goBack()">
                            <span>‚Üê</span>
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <span>üÜï</span>
                            –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }

        function toggleNavigationMenu() {
            const menu = document.getElementById('navigation-menu');
            const overlay = document.getElementById('menu-overlay');
            
            if (menu.classList.contains('open')) {
                menu.classList.remove('open');
                overlay.classList.remove('open');
            } else {
                menu.classList.add('open');
                overlay.classList.add('open');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø–æ Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const menu = document.getElementById('navigation-menu');
                if (menu.classList.contains('open')) {
                    toggleNavigationMenu();
                }
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            AuthCheck.initAuthCheck(
                // Callback –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                (userId) => {
                    console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
                    initializeTelegram();
                    setupForm();
                },
                // Callback –¥–ª—è –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                () => {
                    console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
                }
            );
        });

        function initializeTelegram() {
            if (window.Telegram?.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
            }
        }

        function setupForm() {
            document.getElementById("create-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                
                const name = document.getElementById("project-name").value.trim();
                const color = document.getElementById("project-color").value;
                const userId = getUserId();

                if (!name || !userId) {
                    alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
                    return;
                }

                try {
                    const res = await fetch("/api/project/create", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ user_id: userId, name, color })
                    });

                    if (res.ok) {
                        if (window.Telegram?.WebApp) {
                            window.Telegram.WebApp.showAlert("–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω!");
                        } else {
                            alert("–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω!");
                        }
                        window.location.href = "project_select.html";
                    } else {
                        const error = await res.json();
                        if (window.Telegram?.WebApp) {
                            window.Telegram.WebApp.showAlert(`–û—à–∏–±–∫–∞: ${error.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç'}`);
                        } else {
                            alert(`–û—à–∏–±–∫–∞: ${error.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç'}`);
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞:', error);
                    if (window.Telegram?.WebApp) {
                        window.Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.");
                    } else {
                        alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.");
                    }
                }
            });
        }
    </script>
</body>
</html>