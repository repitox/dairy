<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>–ì–ª–∞–≤–Ω–∞—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="webapp-styles.css">
</head>

<body>
    <div class="tg-viewport">
        <div class="safe-area-content">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
            <header class="page-header">
                <h1 class="page-title">
                    <span class="page-title-icon">üìã</span>
                    –°–µ–≥–æ–¥–Ω—è
                </h1>
            </header>

            <!-- –°–µ–∫—Ü–∏—è –∑–∞–¥–∞—á -->
            <section class="dashboard-section">
                <div class="dashboard-header">
                    <h2>üìå –ó–∞–¥–∞—á–∏</h2>
                    <a href="tasks.html" class="dashboard-link">–í—Å–µ ‚Üí</a>
                </div>
                <div id="today-tasks" class="dashboard-block">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</div>
                    </div>
                </div>
            </section>

            <!-- –°–µ–∫—Ü–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π -->
            <section class="dashboard-section">
                <div class="dashboard-header">
                    <h2>üéâ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</h2>
                    <a href="events.html" class="dashboard-link">–í—Å–µ ‚Üí</a>
                </div>
                <div id="today-events" class="dashboard-block">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</div>
                    </div>
                </div>
            </section>

            <!-- –°–µ–∫—Ü–∏—è –ø–æ–∫—É–ø–æ–∫ -->
            <section class="dashboard-section">
                <div class="dashboard-header">
                    <h2>üõí –ü–æ–∫—É–ø–∫–∏</h2>
                    <a href="shopping.html" class="dashboard-link">–í—Å–µ ‚Üí</a>
                </div>
                <div id="today-shopping" class="dashboard-block">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∫—É–ø–æ–∫...</div>
                    </div>
                </div>
            </section>

            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
            <nav class="dashboard-navigation">
                <a href="settings.html" class="nav-item">
                    <span class="nav-item-icon">‚öôÔ∏è</span>
                    –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
                </a>
                <a href="project_select.html" class="nav-item">
                    <span class="nav-item-icon">üìÅ</span>
                    –í—ã–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
                </a>
            </nav>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            document.documentElement.classList.add("dark-theme");

            const projectId = new URLSearchParams(window.location.search).get("project_id");
            const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || "123456789";
            const taskRes = await fetch(`/api/tasks/today?user_id=${userId}`);
            const eventRes = await fetch(`/api/events/today?user_id=${userId}`);
            const shoppingRes = await fetch(`/api/shopping/today?user_id=${userId}`);

            const renderTasks = async (res, containerId) => {
                const container = document.getElementById(containerId);
                try {
                    if (!res.ok) {
                        container.innerHTML = `<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>`;
                        return;
                    }

                    const raw = await res.json();
                    //—Åonsole.log("–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç –∑–∞–¥–∞—á:", raw);
                    const overdue = Array.isArray(raw.overdue) ? raw.overdue : [];
                    const today = Array.isArray(raw.today) ? raw.today : [];
                    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: —É–±–∏—Ä–∞–µ–º –∏–∑ overdue –∑–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ today
                    const todayIds = new Set(today.map(t => t.id));
                    const filteredOverdue = overdue.filter(t => !todayIds.has(t.id));

                    if (!overdue.length && !today.length) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üìù</div>
                                <h3 class="empty-state-title">–ù–µ—Ç –∑–∞–¥–∞—á –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
                                <p class="empty-state-description">
                                    –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –∏–ª–∏ —É –≤–∞—Å —Å–≤–æ–±–æ–¥–Ω—ã–π –¥–µ–Ω—å.
                                </p>
                            </div>
                        `;
                        return;
                    }

                    const renderGroup = (items, label) => {
                        const group = items.map(item => {
                            const priorityClass = item.priority === "–≤–∞–∂–Ω–∞—è" ? "important" : "normal";
                            const hasTime = item.due_date && item.due_date.length > 10;
                            const formattedDueDate = item.due_date
                                ? (label === "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ"
                                    ? luxon.DateTime.fromISO(item.due_date).toFormat("dd.MM.yyyy HH:mm")
                                    : hasTime
                                        ? luxon.DateTime.fromISO(item.due_date).toFormat("HH:mm")
                                        : "")
                                : "";
                            const dueDateHTML = `<div style="font-size: 0.7rem; color: #aaa; display: flex; justify-content: space-between; align-items: center;">
  <span style="white-space: nowrap;">${formattedDueDate || "–±–µ–∑ —Å—Ä–æ–∫–∞"}</span>
  <span style="white-space: nowrap; text-align: right; display: flex; align-items: center;">
    ${item.project_name || "#–ª–∏—á–Ω–æ–µ"}
    ${item.project_color ? `<span style="display:inline-block;width:0.5rem;height:0.5rem;border-radius:50%;background:${item.project_color};margin-left:4px;"></span>` : ""}
  </span>
</div>`;
                            return `<div class="list-item ${priorityClass}">
                                        <div class="item-content">
                                            <div class="item-title">
                                                <a href="task.html?id=${item.id}">${item.title || item.name}</a>
                                            </div>
                                            <div class="item-meta">${dueDateHTML}</div>
                                        </div>
                                        <span class="badge ${item.priority === '–≤–∞–∂–Ω–∞—è' ? 'priority-high' : 'priority-medium'}">
                                            ${item.priority === '–≤–∞–∂–Ω–∞—è' ? 'üî•' : 'üìù'}
                                        </span>
                                    </div>`;
                        }).join("");
                        return `
                            <div class="list-container">
                                <div class="list-header">${label}</div>
                                ${group}
                            </div>
                        `;
                    };

                    container.innerHTML = "";
                    if (filteredOverdue.length) container.innerHTML += renderGroup(filteredOverdue, "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ");
                    if (today.length) container.innerHTML += renderGroup(today, "–ù–∞ —Å–µ–≥–æ–¥–Ω—è");
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ –∑–∞–¥–∞—á:", error);
                    container.innerHTML = `<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>`;
                }
            };

            const renderList = async (res, containerId) => {
                const container = document.getElementById(containerId);
                try {
                    if (!res.ok) {
                        container.innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>";
                        return;
                    }
                    const data = await res.json();
                    console.log(`–î–∞–Ω–Ω—ã–µ –¥–ª—è ${containerId}:`, data);

                    if (!data.length) {
                        const emptyIcon = containerId === "today-events" ? "üéâ" : "üõí";
                        const emptyTitle = containerId === "today-events" ? "–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π" : "–ù–µ—Ç –ø–æ–∫—É–ø–æ–∫";
                        const emptyDesc = containerId === "today-events" 
                            ? "–ù–∞ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π"
                            : "–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ø—É—Å—Ç";
                        
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">${emptyIcon}</div>
                                <h3 class="empty-state-title">${emptyTitle}</h3>
                                <p class="empty-state-description">${emptyDesc}</p>
                            </div>
                        `;
                        return;
                    }

                    if (containerId === "today-events") {
                        const eventsHTML = data.map(item => {
                            const time = item.start_at
                                ? luxon.DateTime.fromISO(item.start_at).toLocal().toFormat("HH:mm")
                                : "";
                            const projectName = item.project_name || "#–ª–∏—á–Ω–æ–µ";
                            const projectColor = item.project_color || null;
                            const pin = projectColor ? `<span style="display:inline-block;width:0.5rem;height:0.5rem;border-radius:50%;background:${projectColor};margin-left:4px;"></span>` : "";

                            return `<div class="list-item">
                            <div class="item-content">
                                    <div class="item-title">
                                        <a href="event.html?id=${item.id}">${item.title || item.name}${item.location ? `, ${item.location}` : ''}</a>
                                    </div>
                                    <div class="item-meta">
                                        <span>${time || "–í–µ—Å—å –¥–µ–Ω—å"}</span>
                                            <span>${projectName}${pin}</span>
                                    </div>
                                </div>
                                <span class="badge badge-info">üéâ</span>
                            </div>`;
                        }).join("");
                        
                        container.innerHTML = `
                            <div class="list-container">
                                ${eventsHTML}
                            </div>
                        `;
                    } else if (containerId === "today-shopping") {
                        const shoppingHTML = data.map(item => {
                            const text = item.quantity ? `${item.quantity} x ${item.item}` : item.item;
                            return `<div class="list-item">
                                <div class="item-content">
                                    <div class="item-title">
                                        <a href="shopping.html?id=${item.id}">${text}</a>
                                    </div>
                                </div>
                                <span class="badge badge-warning">üõí</span>
                            </div>`;
                        }).join("");
                        
                        container.innerHTML = `
                            <div class="list-container">
                                ${shoppingHTML}
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ —Å–ø–∏—Å–∫–∞:", error);
                    container.innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>";
                }
            };

            await renderTasks(taskRes, "today-tasks");
            const tasksContainer = document.getElementById("today-tasks");
            tasksContainer.insertAdjacentHTML('afterend', `
                <div class="dashboard-actions">
                    <button class="btn btn-primary btn-small add-task-btn">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
                    </button>
                </div>
            `);

            await renderList(eventRes, "today-events");
            const eventsContainer = document.getElementById("today-events");
            eventsContainer.insertAdjacentHTML('afterend', `
                <div class="dashboard-actions">
                    <a href="event_create.html" class="btn btn-secondary btn-small">
                        üéâ –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ
                    </a>
                </div>
            `);

            await renderList(shoppingRes, "today-shopping");
            const shoppingContainer = document.getElementById("today-shopping");
            shoppingContainer.insertAdjacentHTML('afterend', `
                <div class="dashboard-actions">
                    <a href="shopping.html" class="btn btn-secondary btn-small">
                        üõí –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É
                    </a>
                </div>
            `);

            const taskAddButton = document.querySelector(".add-task-btn");
            if (taskAddButton) {
                taskAddButton.addEventListener("click", (e) => {
                    e.preventDefault();
                    const modal = document.getElementById("taskModal");
                    if (modal) modal.style.display = "block";
                });
            }

            const saveTaskBtn = document.getElementById("save-task");
            if (saveTaskBtn) {
                saveTaskBtn.addEventListener("click", async () => {
                    const title = document.getElementById("task-title").value;
                    const description = document.getElementById("task-desc").value;
                    const dueDate = document.getElementById("task-date").value;
                    const priority = document.getElementById("task-priority").value;
                    const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || "123456789";

                    const body = {
                        title,
                        description,
                        due_date: dueDate ? new Date(dueDate).toISOString().split("T")[0] : null,
                        priority,
                        user_id: userId,
                        project_id: projectId
                    };

                    const res = await fetch("/api/tasks", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body)
                    });

                    if (res.ok) {
                        document.getElementById("taskModal").style.display = "none";
                        location.reload();
                    } else {
                        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
                    }
                });
            }

            window.onclick = function (event) {
                const modal = document.getElementById("taskModal");
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            };
        });
    </script>
    
</body>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á -->
    <div id="taskModal" class="modal">
        <div class="modal-content glass-container">
            <div class="modal-header">
                <h3 class="modal-title">‚ú® –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
                <button class="modal-close" onclick="document.getElementById('taskModal').style.display='none'">√ó</button>
            </div>
            
            <form class="modal-form">
                <div class="form-group">
                    <label class="form-label" for="task-title">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                    <input type="text" id="task-title" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="task-desc">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="task-desc" class="form-control" placeholder="–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="task-date">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                    <input type="date" id="task-date" class="form-control">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="task-priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                    <select id="task-priority" class="form-control">
                        <option value="–æ–±—ã—á–Ω–∞—è">üìù –û–±—ã—á–Ω–∞—è</option>
                        <option value="–≤–∞–∂–Ω–∞—è">üî• –í–∞–∂–Ω–∞—è</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('taskModal').style.display='none'">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="button" id="save-task" class="btn btn-primary">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>

</html>