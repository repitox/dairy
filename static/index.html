<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ì–ª–∞–≤–Ω–∞—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <link rel="stylesheet" href="styles.css"> -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');
        html, body {
            background-color: var(--background-color);
            color: var(--text-color);
        }
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0.5rem;
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 0.85rem;
        }

        .dashboard-section {
            margin-bottom: 0.8rem;
            background: var(--section-background, #f9f9f9);
            border-radius: 4px;
            padding: 0 0.5rem 0.1rem 0.5rem;
            /* —É–¥–∞–ª—è–µ–º —Ç–µ–Ω—å */
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.3rem;
        }
        .dashboard-header a {
            margin-top: 0.5rem;
        }

        .dashboard-header h2 {
            margin: 0;
            font-size: 0.9rem;
        }

        .dashboard-link {
            display: inline-block;
            /* margin-top: 0.5rem; */
            text-decoration: none;
            color: #007bff;
            font-weight: 500;
        }

        .dashboard-link:hover {
            text-decoration: underline;
        }

        .dashboard-settings {
            margin-top: 2rem;
            text-align: center;
        }

        /* Dark Theme Overrides */
        .dark-theme {
            --background-color: #0e0e0e;
            --text-color: #f1f1f1;
            --section-background: #1a1a1a;
        }

        .light-theme {
            --background-color: #ffffff;
            --text-color: #000000;
            --section-background: #f9f9f9;
        }

        .dashboard-item {
            font-size: 0.82rem;
            padding: 0.4rem 0;
            margin-top: 0.2rem;
            line-height: 1.3rem;
            display: flex;
            align-items: flex-start;
            position: relative;
            padding-left: 10px;
        }

        .dashboard-item a {
            text-decoration: none;
            color: var(--text-color);
            margin-top: 0;
        }

        .dashboard-item a:hover {
            color: #66b0ff;
        }

        .dashboard-item.important::before,
        .dashboard-item.normal::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 2px;
        }

        .dashboard-item.important::before {
            background-color: red;
        }

        .dashboard-item.normal::before {
            background-color: #007bff;
        }
        
        .dark-theme .dashboard-link {
            color: #3399ff;
        }
        .dark-theme .dashboard-item {
            border-bottom: 1px solid #333;
        }

        /* Modal styles */
        #modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 999;
            justify-content: center;
            align-items: center;
        }

        #modal > div {
            background: #1e1e1e;
            padding: 1rem;
            border-radius: 10px;
            max-width: 360px;
            width: 90%;
            color: #fff;
            box-shadow: 0 0 12px rgba(0,0,0,0.5);
        }

        #modal h3 {
            margin-top: 0;
            font-size: 1.2rem;
            text-align: center;
        }

        #modal input, #modal textarea, #modal select {
            width: 100%;
            margin-top: 0.4rem;
            padding: 0.4rem;
            border: none;
            border-radius: 4px;
            background: #2a2a2a;
            color: #fff;
            font-family: inherit;
            font-size: 0.9rem;
        }

        #modal input::placeholder,
        #modal textarea::placeholder {
            color: #888;
        }

        #modal textarea {
            resize: vertical;
        }

        #modal button {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            margin-left: 0.5rem;
            background: #3399ff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #modal button[type="button"] {
            background: #444;
        }

        #modal button:hover {
            background: #4ab1ff;
        }

        #modal button[type="button"]:hover {
            background: #666;
        }
    </style>
</head>
<body>
    <h1>üìã –°–µ–≥–æ–¥–Ω—è</h1>
    <div class="dashboard-section">
        <div class="dashboard-header">
            <h2>üìå –ó–∞–¥–∞—á–∏</h2>
            <a href="tasks.html" class="dashboard-link">–í—Å–µ ‚Üí</a>
        </div>
        <div id="today-tasks" class="dashboard-block">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <div class="dashboard-section">
        <div class="dashboard-header">
            <h2>üéâ –°–æ–±—ã—Ç–∏—è</h2>
            <a href="events.html" class="dashboard-link">–í—Å–µ ‚Üí</a>
        </div>
        <div id="today-events" class="dashboard-block">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <div class="dashboard-section">
        <div class="dashboard-header">
            <h2>üõí –ü–æ–∫—É–ø–∫–∏</h2>
            <a href="shopping.html" class="dashboard-link">–í—Å–µ ‚Üí</a>
        </div>
        <div id="today-shopping" class="dashboard-block">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <div class="dashboard-settings">
        <a href="settings.html" class="dashboard-link">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            document.documentElement.classList.add("dark-theme");

            const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || "88504731";
            const taskRes = await fetch("/api/tasks/today?user_id=" + userId);
            const eventRes = await fetch("/api/events/today?user_id=" + userId);
            const shoppingRes = await fetch("/api/shopping/today?user_id=" + userId);

            const renderTasks = async (res, containerId) => {
                const container = document.getElementById(containerId);
                if (!res.ok) {
                    container.innerHTML = `<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>`;
                    return;
                }
                const data = await res.json();
                const { overdue = [], today = [] } = data;

                if (!overdue.length && !today.length) {
                    container.innerHTML = "<p>–ù–µ—Ç –∑–∞–¥–∞—á</p>";
                    return;
                }

                const renderGroup = (items, label) => {
                    const group = items.map(item => {
                        const priorityClass = item.priority === "–≤–∞–∂–Ω–∞—è" ? "important" : "normal";
                        const hasTime = item.due_date && item.due_date.length > 10;
                        const formattedDueDate = item.due_date
                            ? (label === "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ"
                                ? luxon.DateTime.fromISO(item.due_date).toFormat("dd.MM.yyyy HH:mm")
                                : hasTime
                                    ? luxon.DateTime.fromISO(item.due_date).toFormat("HH:mm")
                                    : "")
                            : "";
                        const dueDateHTML = formattedDueDate ? `<div style="font-size: 0.7rem; color: #aaa;">${formattedDueDate}</div>` : "";
                        return `<div class="dashboard-item ${priorityClass}">
                                    <div>
                                        <a href="task.html?id=${item.id}">${item.title || item.name}</a>
                                        ${dueDateHTML}
                                    </div>
                                </div>`;
                    }).join("");
                    return `<p style="font-weight: 600;margin-top: 0.7rem;margin-bottom: 0.3rem;">${label}:</p>${group}`;
                };

                container.innerHTML = "";
                if (overdue.length) container.innerHTML += renderGroup(overdue, "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ");
                if (today.length) container.innerHTML += renderGroup(today, "–ù–∞ —Å–µ–≥–æ–¥–Ω—è");
            };

            const renderList = async (res, containerId) => {
                const container = document.getElementById(containerId);
                if (!res.ok) {
                    container.innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>";
                    return;
                }
                const data = await res.json();
                if (!data.length) {
                    container.innerHTML = "<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>";
                    return;
                }

                if (containerId === "today-events") {
                    container.innerHTML = data.map(item => {
                        const time = item.start_at?.slice(11, 16) || "";
                        return `<div class="dashboard-item">
                                    <span style="color: #aaa; font-size: 0.75rem; margin-right: 0.4rem;">${time}</span>
                                    <a href="event.html?id=${item.id}">${item.title || item.name}</a>
                                </div>`;
                    }).join("");
                } else if (containerId === "today-shopping") {
                    container.innerHTML = data.map(item => {
                        const text = item.quantity ? `${item.quantity} x ${item.item}` : item.item;
                        return `<div class="dashboard-item">
                                    <a href="shopping.html?id=${item.id}">${text}</a>
                                </div>`;
                    }).join("");
                }
            };

            await renderTasks(taskRes, "today-tasks");
            const tasksContainer = document.getElementById("today-tasks");
            tasksContainer.insertAdjacentHTML('afterend', `<p style="margin-top: 0.6rem;margin-bottom: 0.5rem;"><a href="#" class="dashboard-link" onclick="openModal('task')">+ –î–æ–±–∞–≤–∏—Ç—å</a></p>`);

            await renderList(eventRes, "today-events");
            const eventsContainer = document.getElementById("today-events");
            eventsContainer.insertAdjacentHTML('afterend', `<p style="margin-top: 0.6rem;margin-bottom: 0.5rem;"><a href="#" class="dashboard-link" onclick="openModal('event')">+ –î–æ–±–∞–≤–∏—Ç—å</a></p>`);

            await renderList(shoppingRes, "today-shopping");
            const shoppingContainer = document.getElementById("today-shopping");
            shoppingContainer.insertAdjacentHTML('afterend', `<p style="margin-top: 0.6rem;margin-bottom: 0.5rem;"><a href="#" class="dashboard-link" onclick="openModal('shopping')">+ –î–æ–±–∞–≤–∏—Ç—å</a></p>`);
        });

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –≤–∫–ª–∞–¥–∫–∞–º–∏
function openModal(type) {
  document.getElementById("modal").style.display = "flex";
  document.getElementById("modal-title").textContent = `–î–æ–±–∞–≤–∏—Ç—å`;
  ["task", "event", "shopping"].forEach(name => {
    document.getElementById("form-" + name).style.display = name === type ? "block" : "none";
  });
  document.getElementById("modal-form").dataset.type = type;
  document.getElementById("modal-form").reset();
}
function closeModal() {
  document.getElementById("modal").style.display = "none";
}

document.getElementById("modal-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const type = document.getElementById("modal-form").dataset.type;
  const user_id = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || "88504731";

  // –°–Ω–∏–º–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã required —Å–æ –≤—Å–µ—Ö —Ñ–æ—Ä–º
  ["form-task", "form-event", "form-shopping"].forEach(id => {
    const formEl = document.getElementById(id);
    formEl.querySelectorAll("[required]").forEach(el => el.removeAttribute("required"));
  });

  // –°—Ç–∞–≤–∏–º required —Ç–æ–ª—å–∫–æ –Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Ñ–æ—Ä–º–µ
  const activeForm = document.getElementById("form-" + type);
  activeForm.querySelectorAll("input[placeholder], textarea[placeholder]").forEach(el => {
    if (el.hasAttribute("name")) el.setAttribute("required", "required");
  });

  // –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π, —á—Ç–æ–±—ã –∏—Ö –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –º–µ—à–∞–ª–∞
  ["form-task", "form-event", "form-shopping"].forEach(id => {
    const formEl = document.getElementById(id);
    formEl.style.display = id === "form-" + type ? "block" : "none";
  });

  let data = {};
  let url = "";
  if (type === "task") {
    data = {
      title: document.getElementById("task-title").value,
      description: document.getElementById("task-description").value,
      due_date: document.getElementById("task-date").value || null,
      priority: document.getElementById("task-priority").value,
      user_id
    };
    url = "/api/tasks";
  } else if (type === "event") {
    data = {
      title: document.getElementById("event-title").value,
      location: document.getElementById("event-location").value,
      start_at: document.getElementById("event-start").value,
      end_at: document.getElementById("event-end").value,
      user_id
    };
    url = "/api/events";
  } else if (type === "shopping") {
    data = {
      item: document.getElementById("shop-item").value,
      quantity: parseInt(document.getElementById("shop-quantity").value),
      user_id
    };
    url = "/api/shopping";
  }

  if (!url) {
    alert("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Ñ–æ—Ä–º—ã");
    return;
  }

  try {
    const response = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:", errorText);
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏.");
      return;
    }

    closeModal();
    location.reload();
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞:", error);
    alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.");
  }
});
    </script>
</body>
<div id="modal" style="display:none;">
  <div>
    <h3 id="modal-title">–î–æ–±–∞–≤–∏—Ç—å</h3>
    <form id="modal-form" onsubmit="return false;">
      <div id="form-task" style="display:none;">
        <input type="text" id="task-title" name="task-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required><br>
        <textarea id="task-description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="2"></textarea><br>
        <input type="date" id="task-date"><br>
        <select id="task-priority">
          <option value="–æ–±—ã—á–Ω–∞—è">–û–±—ã—á–Ω–∞—è</option>
          <option value="–≤–∞–∂–Ω–∞—è">–í–∞–∂–Ω–∞—è</option>
        </select>
      </div>
      <div id="form-event" style="display:none;">
        <input type="text" id="event-title" name="event-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required><br>
        <input type="text" id="event-location" placeholder="–ú–µ—Å—Ç–æ"><br>
        <input type="datetime-local" id="event-start"><br>
        <input type="datetime-local" id="event-end"><br>
      </div>
      <div id="form-shopping" style="display:none;">
        <input type="text" id="shop-item" name="shop-item" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required><br>
        <input type="number" id="shop-quantity" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" min="1" value="1"><br>
      </div>
      <div style="text-align:right; margin-top:0.5rem;">
        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div>
</html>