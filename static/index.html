<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>–ì–ª–∞–≤–Ω–∞—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <h1>üìã –°–µ–≥–æ–¥–Ω—è</h1>
    <div class="dashboard-section">
        <div class="dashboard-header">
            <h2>üìå –ó–∞–¥–∞—á–∏</h2>
            <a href="tasks.html" class="dashboard-link">–í—Å–µ ‚Üí</a>
        </div>
        <div id="today-tasks" class="dashboard-block">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <div class="dashboard-section">
        <div class="dashboard-header">
            <h2>üéâ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</h2>
            <a href="events.html" class="dashboard-link">–í—Å–µ ‚Üí</a>
        </div>
        <div id="today-events" class="dashboard-block">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <div class="dashboard-section">
        <div class="dashboard-header">
            <h2>üõí –ü–æ–∫—É–ø–∫–∏</h2>
            <a href="shopping.html" class="dashboard-link">–í—Å–µ ‚Üí</a>
        </div>
        <div id="today-shopping" class="dashboard-block">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <div class="dashboard-settings">
        <a href="settings.html" class="dashboard-link">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
    </div>
    <div class="dashboard-settings">
        <a href="project_select.html" class="dashboard-link">üìÅ –í—ã–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</a>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            document.documentElement.classList.add("dark-theme");

            const projectId = new URLSearchParams(window.location.search).get("project_id");
            const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || "88504731";
            const taskRes = await fetch(`/api/tasks/today?user_id=${userId}`);
            const eventRes = await fetch(`/api/events/today?user_id=${userId}`);
            const shoppingRes = await fetch(`/api/shopping/today?user_id=${userId}`);

            const renderTasks = async (res, containerId) => {
                const container = document.getElementById(containerId);
                try {
                    if (!res.ok) {
                        container.innerHTML = `<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>`;
                        return;
                    }

                    const raw = await res.json();
                    console.log("–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç –∑–∞–¥–∞—á:", raw);
                    const overdue = Array.isArray(raw.overdue) ? raw.overdue : [];
                    const today = Array.isArray(raw.today) ? raw.today : [];
                    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: —É–±–∏—Ä–∞–µ–º –∏–∑ overdue –∑–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ today
                    const todayIds = new Set(today.map(t => t.id));
                    const filteredOverdue = overdue.filter(t => !todayIds.has(t.id));

                    if (!overdue.length && !today.length) {
                        container.innerHTML = "<p>–ù–µ—Ç –∑–∞–¥–∞—á</p>";
                        return;
                    }

                    const renderGroup = (items, label) => {
                        const group = items.map(item => {
                            const priorityClass = item.priority === "–≤–∞–∂–Ω–∞—è" ? "important" : "normal";
                            const hasTime = item.due_date && item.due_date.length > 10;
                            const formattedDueDate = item.due_date
                                ? (label === "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ"
                                    ? luxon.DateTime.fromISO(item.due_date).toFormat("dd.MM.yyyy HH:mm")
                                    : hasTime
                                        ? luxon.DateTime.fromISO(item.due_date).toFormat("HH:mm")
                                        : "")
                                : "";
                            const dueDateHTML = `<div style="font-size: 0.7rem; color: #aaa; display: flex; justify-content: space-between; align-items: center;">
  <span style="white-space: nowrap;">${formattedDueDate}</span>
  <span style="white-space: nowrap; text-align: right; display: flex; align-items: center;">
    ${item.project_name || "#–ª–∏—á–Ω–æ–µ"}
    ${item.project_color ? `<span style="display:inline-block;width:0.5rem;height:0.5rem;border-radius:50%;background:${item.project_color};margin-left:4px;"></span>` : ""}
  </span>
</div>`;
                            return `<div class="dashboard-item ${priorityClass}">
                                        <div style="flex-grow: 1;">
                                            <a href="task.html?id=${item.id}">${item.title || item.name}</a>
                                            ${dueDateHTML}
                                        </div>
                                    </div>`;
                        }).join("");
                        return `<p style="font-weight: 600;margin-top: 0.7rem;margin-bottom: 0.3rem;">${label}:</p>${group}`;
                    };

                    container.innerHTML = "";
                    if (filteredOverdue.length) container.innerHTML += renderGroup(filteredOverdue, "–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ");
                    if (today.length) container.innerHTML += renderGroup(today, "–ù–∞ —Å–µ–≥–æ–¥–Ω—è");
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ –∑–∞–¥–∞—á:", error);
                    container.innerHTML = `<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>`;
                }
            };

            const renderList = async (res, containerId) => {
                const container = document.getElementById(containerId);
                try {
                    if (!res.ok) {
                        container.innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>";
                        return;
                    }
                    const data = await res.json();
                    console.log(`–î–∞–Ω–Ω—ã–µ –¥–ª—è ${containerId}:`, data);

                    if (!data.length) {
                        container.innerHTML = "<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>";
                        return;
                    }

                    if (containerId === "today-events") {
                        container.innerHTML = data.map(item => {
                            const time = item.start_at
                                ? luxon.DateTime.fromISO(item.start_at).toLocal().toFormat("HH:mm")
                                : "";
                            return `<div class="dashboard-item">
                                        <span style="color: #aaa; font-size: 0.75rem; margin-right: 0.4rem;">${time}</span>
                                        <a href="event.html?id=${item.id}">${item.title || item.name}</a>
                                    </div>`;
                        }).join("");
                    } else if (containerId === "today-shopping") {
                        container.innerHTML = data.map(item => {
                            const text = item.quantity ? `${item.quantity} x ${item.item}` : item.item;
                            return `<div class="dashboard-item">
                                        <a href="shopping.html?id=${item.id}">${text}</a>
                                    </div>`;
                        }).join("");
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ —Å–ø–∏—Å–∫–∞:", error);
                    container.innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>";
                }
            };

            await renderTasks(taskRes, "today-tasks");
            const tasksContainer = document.getElementById("today-tasks");
            tasksContainer.insertAdjacentHTML('afterend', `<p style="margin-top: 0.6rem;margin-bottom: 0.5rem;"><a href="#" class="dashboard-link">+ –î–æ–±–∞–≤–∏—Ç—å</a></p>`);

            await renderList(eventRes, "today-events");
            const eventsContainer = document.getElementById("today-events");
            eventsContainer.insertAdjacentHTML('afterend', `<p style="margin-top: 0.6rem;margin-bottom: 0.5rem;"><a href="#" class="dashboard-link">+ –î–æ–±–∞–≤–∏—Ç—å</a></p>`);

            await renderList(shoppingRes, "today-shopping");
            const shoppingContainer = document.getElementById("today-shopping");
            shoppingContainer.insertAdjacentHTML('afterend', `<p style="margin-top: 0.6rem;margin-bottom: 0.5rem;"><a href="#" class="dashboard-link">+ –î–æ–±–∞–≤–∏—Ç—å</a></p>`);

            const taskAddButton = document.querySelector("#today-tasks + p a");
            if (taskAddButton) {
                taskAddButton.addEventListener("click", (e) => {
                    e.preventDefault();
                    const modal = document.getElementById("taskModal");
                    if (modal) modal.style.display = "block";
                });
            }

            const saveTaskBtn = document.getElementById("save-task");
            if (saveTaskBtn) {
                saveTaskBtn.addEventListener("click", async () => {
                    const title = document.getElementById("task-title").value;
                    const description = document.getElementById("task-desc").value;
                    const dueDate = document.getElementById("task-date").value;
                    const priority = document.getElementById("task-priority").value;
                    const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || "88504731";

                    const body = {
                        title,
                        description,
                        due_date: dueDate ? new Date(dueDate).toISOString().split("T")[0] : null,
                        priority,
                        user_id: userId,
                        project_id: projectId
                    };

                    const res = await fetch("/api/tasks", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body)
                    });

                    if (res.ok) {
                        document.getElementById("taskModal").style.display = "none";
                        location.reload();
                    } else {
                        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
                    }
                });
            }

            window.onclick = function (event) {
                const modal = document.getElementById("taskModal");
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            };
        });
    </script>
</body>
<div id="taskModal" class="modal">
    <div class="modal-content">
        <h3>–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
        <input type="text" id="task-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
        <textarea id="task-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
        <input type="date" id="task-date">
        <select id="task-priority">
            <option value="–æ–±—ã—á–Ω–∞—è">–û–±—ã—á–Ω–∞—è</option>
            <option value="–≤–∞–∂–Ω–∞—è">–í–∞–∂–Ω–∞—è</option>
        </select>
        <button id="save-task">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

</html>