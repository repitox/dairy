<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–¥–∞—á–∏ - Task Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="auth-check.js"></script>
    <link rel="stylesheet" href="webapp-styles.css?v=6">
    <style>
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Å—Ç–∏–ª–µ–π dashboard –¥–ª—è WebApp */
        .webapp-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px;
            margin: 10px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            min-height: calc(100vh - 40px);
        }
        
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–º —Ñ–æ–Ω–æ–º –≤ —Å—Ç–∏–ª–µ dashboard */
        .header {
            background: var(--accent-gradient);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .page-title {
            font-size: 24px;
            color: white;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            text-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }
        
        .page-title span {
            font-size: 28px;
            filter: drop-shadow(0 2px 10px rgba(0, 0, 0, 0.3));
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
        .add-task-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #2d3748;
            border: none;
            padding: 12px 20px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all var(--transition-medium);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            z-index: 1;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .add-task-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        /* –§–∏–ª—å—Ç—Ä—ã –≤ —Å—Ç–∏–ª–µ dashboard */
        .filter-container {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all var(--transition-fast);
        }
        
        .filter-btn.active,
        .filter-btn:hover {
            background: var(--accent-gradient);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å–ø–∏—Å–∫–æ–≤ –≤ —Å—Ç–∏–ª–µ dashboard */
        .list-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .list-header {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .list-header span:first-child {
            font-size: 16px;
        }
        
        .list-header span:nth-child(2) {
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            margin-left: 8px;
        }
        
        /* –≠–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–æ–≤ */
        .list-item {
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 12px 16px;
            transition: all var(--transition-fast);
        }
        
        .list-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        /* –ë–µ–π–¥–∂–∏ */
        .badge {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .badge-danger {
            background: rgba(245, 101, 101, 0.2);
            color: #f56565;
            border: 1px solid rgba(245, 101, 101, 0.3);
        }
        
        .badge-info {
            background: rgba(66, 153, 225, 0.2);
            color: #4299e1;
            border: 1px solid rgba(66, 153, 225, 0.3);
        }
        
        .badge-success {
            background: rgba(72, 187, 120, 0.2);
            color: #48bb78;
            border: 1px solid rgba(72, 187, 120, 0.3);
        }
        
        .badge-warning {
            background: rgba(237, 137, 54, 0.2);
            color: #ed8936;
            border: 1px solid rgba(237, 137, 54, 0.3);
        }
        
        /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.7;
        }
        
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .empty-state-description {
            font-size: 14px;
            opacity: 0.8;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="webapp-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ —Å—Ç–∏–ª–µ dashboard -->
        <header class="header">
            <h1 class="page-title">
                <span>üìã</span>
                –ó–∞–¥–∞—á–∏
            </h1>
            <a href="task_add.html" class="add-task-btn">
                <span>‚ûï</span>
                –î–æ–±–∞–≤–∏—Ç—å
            </a>
        </header>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filter-container">
            <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
            <button class="filter-btn" data-filter="today">–°–µ–≥–æ–¥–Ω—è</button>
            <button class="filter-btn" data-filter="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</button>
            <button class="filter-btn" data-filter="important">–í–∞–∂–Ω—ã–µ</button>
            <button class="filter-btn" data-filter="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</button>
        </div>

        <!-- –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ -->
        <div class="list-container" id="overdue-section" style="display: none;">
            <div class="list-header">
                <span>‚ö†Ô∏è</span>
                <span>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</span>
                <span class="badge badge-danger" id="overdue-count">0</span>
            </div>
            <div id="overdue-tasks"></div>
        </div>

        <!-- –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è -->
        <div class="list-container" id="today-section" style="display: none;">
            <div class="list-header">
                <span>üìÖ</span>
                <span>–ù–∞ —Å–µ–≥–æ–¥–Ω—è</span>
                <span class="badge badge-info" id="today-count">0</span>
            </div>
            <div id="today-tasks"></div>
        </div>

        <!-- –ë—É–¥—É—â–∏–µ –∑–∞–¥–∞—á–∏ -->
        <div class="list-container" id="future-section" style="display: none;">
            <div class="list-header">
                <span>üìã</span>
                <span>–ë—É–¥—É—â–∏–µ –∑–∞–¥–∞—á–∏</span>
                <span class="badge badge-info" id="future-count">0</span>
            </div>
            <div id="future-tasks"></div>
        </div>

        <!-- –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ -->
        <div class="list-container" id="completed-section" style="display: none;">
            <div class="list-header">
                <span>‚úÖ</span>
                <span>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</span>
                <span class="badge badge-success" id="completed-count">0</span>
            </div>
            <div id="completed-tasks"></div>
        </div>

        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
        <div class="empty-state" id="empty-state" style="display: none;">
            <div class="empty-state-icon">üìù</div>
            <div class="empty-state-title">–ù–µ—Ç –∑–∞–¥–∞—á</div>
            <div class="empty-state-description">
                –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É, –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å" –≤—ã—à–µ
            </div>
        </div>
        
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <nav class="dashboard-navigation" style="margin-top: 24px;">
            <a href="index.html" class="nav-item">
                <span class="nav-item-icon">üè†</span>
                –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
            </a>
        </nav>
    </div>

      <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
      <div class="loading-state" id="loading-state">
        <div class="loading-spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</div>
      </div>
    </div>
  </div>

  <script src="datetime-utils.js"></script>
  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let allTasks = [];
    let currentFilter = 'all';

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      initializeTelegram();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      AuthCheck.initAuthCheck(
        // Callback –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        (userId) => {
          console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏");
          setupFilters();
          loadTasks();
        },
        // Callback –¥–ª—è –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        () => {
          console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
          // –≠–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω –≤ AuthCheck.initAuthCheck
        }
      );
    });

    function initializeTelegram() {
      if (window.Telegram?.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
      }
    }

    function setupFilters() {
      const filterBtns = document.querySelectorAll('.filter-btn');
      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          filterBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          filterTasks();
        });
      });
    }

    async function loadTasks() {
      try {
        showLoading(true);
        const userId = getUserId();
        const response = await fetch(`/api/tasks?user_id=${userId}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        allTasks = await response.json();
        filterTasks();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á');
      } finally {
        showLoading(false);
      }
    }

    function filterTasks() {
      const now = luxon.DateTime.now();
      const today = now.startOf('day');
      
      const groups = {
        overdue: [],
        today: [],
        future: [],
        completed: []
      };

      allTasks.forEach(task => {
        if (task.completed) {
          groups.completed.push(task);
          return;
        }

        if (!task.due_date) {
          groups.future.push(task);
          return;
        }

        const dueDate = luxon.DateTime.fromISO(task.due_date);
        const dueDateStart = dueDate.startOf('day');

        if (dueDateStart < today) {
          groups.overdue.push(task);
        } else if (dueDateStart.equals(today)) {
          groups.today.push(task);
        } else {
          groups.future.push(task);
        }
      });

      let filteredGroups = {};
      
      switch (currentFilter) {
        case 'today':
          filteredGroups = { today: groups.today };
          break;
        case 'overdue':
          filteredGroups = { overdue: groups.overdue };
          break;
        case 'important':
          filteredGroups = {
            overdue: groups.overdue.filter(t => t.priority === '–≤–∞–∂–Ω–∞—è'),
            today: groups.today.filter(t => t.priority === '–≤–∞–∂–Ω–∞—è'),
            future: groups.future.filter(t => t.priority === '–≤–∞–∂–Ω–∞—è')
          };
          break;
        case 'completed':
          filteredGroups = { completed: groups.completed };
          break;
        default:
          filteredGroups = groups;
      }

      renderTasks(filteredGroups);
    }

    function renderTasks(groups) {
      document.querySelectorAll('.list-container').forEach(section => {
        section.style.display = 'none';
      });

      let hasAnyTasks = false;

      Object.entries(groups).forEach(([groupName, tasks]) => {
        if (tasks.length > 0) {
          hasAnyTasks = true;
          renderTaskGroup(groupName, tasks);
        }
      });

      document.getElementById('empty-state').style.display = hasAnyTasks ? 'none' : 'block';
    }

    function renderTaskGroup(groupName, tasks) {
      const section = document.getElementById(`${groupName}-section`);
      const container = document.getElementById(`${groupName}-tasks`);
      const countBadge = document.getElementById(`${groupName}-count`);

      if (!section || !container) return;

      if (countBadge) {
        countBadge.textContent = tasks.length;
      }

      container.innerHTML = '';

      tasks.forEach(task => {
        const taskElement = createTaskElement(task);
        container.appendChild(taskElement);
      });

      section.style.display = 'block';
    }

    function createTaskElement(task) {
      const div = document.createElement('div');
      div.className = `list-item ${task.completed ? 'completed' : ''} ${task.priority === '–≤–∞–∂–Ω–∞—è' ? 'important' : ''}`;
      
      const projectColor = task.project_color || '#6366f1';
      const projectName = task.project_name || '–õ–∏—á–Ω—ã–µ';
      
      div.innerHTML = `
        <div class="item-content">
          <div class="item-title">
            <a href="task.html?id=${task.id}">${escapeHtml(task.title)}</a>
          </div>
          <div class="item-meta">
            <span style="color: ${projectColor};">${projectName}</span>
            ${task.due_date ? `<span>${formatDate(task.due_date)}</span>` : ''}
            ${task.priority === '–≤–∞–∂–Ω–∞—è' ? '<span class="badge priority-high">–í–∞–∂–Ω–∞—è</span>' : ''}
          </div>
        </div>
        <div class="item-actions">
          <button class="btn btn-sm btn-success" onclick="toggleTask(${task.id}, ${!task.completed})">
            ${task.completed ? '‚Ü©Ô∏è' : '‚úÖ'}
          </button>
        </div>
      `;
      
      return div;
    }

    async function toggleTask(taskId, completed) {
      try {
        const response = await fetch(`/api/tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ completed })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const taskIndex = allTasks.findIndex(t => t.id === taskId);
        if (taskIndex !== -1) {
          allTasks[taskIndex].completed = completed;
        }

        filterTasks();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
      }
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      
      try {
        const date = luxon.DateTime.fromISO(dateString);
        const now = luxon.DateTime.now();
        
        if (date.hasSame(now, 'day')) {
          return '–°–µ–≥–æ–¥–Ω—è';
        } else if (date.hasSame(now.plus({ days: 1 }), 'day')) {
          return '–ó–∞–≤—Ç—Ä–∞';
        } else if (date.hasSame(now.minus({ days: 1 }), 'day')) {
          return '–í—á–µ—Ä–∞';
        } else {
          return date.toFormat('dd.MM.yyyy');
        }
      } catch (error) {
        return dateString;
      }
    }

    // –§—É–Ω–∫—Ü–∏—è getUserId —Ç–µ–ø–µ—Ä—å –≤ auth-check.js

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showLoading(show) {
      document.getElementById('loading-state').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
      console.error(message);
    }
  </script>
</body>
</html>