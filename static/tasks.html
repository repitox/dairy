<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ó–∞–¥–∞—á–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="styles.css"> <!-- –∏–ª–∏ "styles.css" –µ—Å–ª–∏ –≤ –∫–æ—Ä–Ω–µ -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
</head>
<body>
    <h1>üìå –ó–∞–¥–∞—á–∏</h1>

    <form id="task-form">
        <input type="text" id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required>
        <input type="datetime-local" id="due_date">
        <select id="priority">
            <option value="–æ–±—ã—á–Ω–∞—è">–û–±—ã—á–Ω–∞—è</option>
            <option value="–≤–∞–∂–Ω–∞—è">–í–∞–∂–Ω–∞—è</option>
        </select>
        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
    </form>

    <div id="tasks-container"></div>
    <a href="index.html">‚Üê –ù–∞–∑–∞–¥</a>

    <script>
        const tg = window.Telegram.WebApp;
        let userId = tg.initDataUnsafe.user?.id;
        const form = document.getElementById("task-form");
        const titleInput = document.getElementById("title");
        const dueDateInput = document.getElementById("due_date");
        const priorityInput = document.getElementById("priority");
        const container = document.getElementById("tasks-container");

        async function loadTasks() {
            const res = await fetch(`/api/tasks?user_id=${userId}`);
            const data = await res.json();
            container.innerHTML = "";
            if (data.length === 0) {
                container.textContent = "–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç.";
                return;
            }

            const now = luxon.DateTime.now();
            const grouped = {
                "–°–µ–≥–æ–¥–Ω—è": [],
                "–ó–∞–≤—Ç—Ä–∞": [],
                "–ù–∞ –Ω–µ–¥–µ–ª–µ": [],
                "–ü–æ–∑–∂–µ": [],
                "–ë–µ–∑ —Å—Ä–æ–∫–∞": []
            };

            data.forEach(task => {
                if (!task.due_date) {
                    grouped["–ë–µ–∑ —Å—Ä–æ–∫–∞"].push(task);
                    return;
                }
                const due = luxon.DateTime.fromISO(task.due_date);
                if (due.hasSame(now, 'day')) {
                    grouped["–°–µ–≥–æ–¥–Ω—è"].push(task);
                } else if (due.hasSame(now.plus({ days: 1 }), 'day')) {
                    grouped["–ó–∞–≤—Ç—Ä–∞"].push(task);
                } else if (due.weekNumber === now.weekNumber && due.year === now.year) {
                    grouped["–ù–∞ –Ω–µ–¥–µ–ª–µ"].push(task);
                } else {
                    grouped["–ü–æ–∑–∂–µ"].push(task);
                }
            });

            Object.entries(grouped).forEach(([label, tasks]) => {
                if (tasks.length === 0) return;
                const section = document.createElement("div");
                section.className = "task-section";

                const heading = document.createElement("h2");
                heading.textContent = label;
                section.appendChild(heading);

                tasks.forEach(task => {
                    const item = document.createElement("div");
                    item.className = "task-item";
                    if (task.priority === "–≤–∞–∂–Ω–∞—è") item.classList.add("important");
                    if (task.completed) item.classList.add("completed");

                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.checked = task.completed;
                    checkbox.onchange = async () => {
                        await fetch(`/api/tasks/${task.id}/complete`, { method: "PUT" });
                        loadTasks();
                    };

                    const labelEl = document.createElement("label");
                    labelEl.textContent = task.title + (task.due_date ? " (–¥–æ " + task.due_date.slice(0, 16).replace("T", " ") + ")" : "");

                    const link = document.createElement("a");
                    link.href = `task.html?id=${task.id}`;
                    link.appendChild(labelEl);

                    item.appendChild(checkbox);
                    item.appendChild(link);
                    section.appendChild(item);
                });

                container.appendChild(section);
            });
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const task = {
                user_id: userId,
                title: titleInput.value,
                due_date: dueDateInput.value || null,
                priority: priorityInput.value
            };

            await fetch("/api/tasks", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(task)
            });

            form.reset();
            loadTasks();
        });

        tg.expand();
        loadTasks();
    </script>
</body>
</html>