<!DOCTYPE html>
<html class="dark-theme" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–¥–∞—á–∏ - Task Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="auth-check.js?v=13"></script>
    <script src="webapp-navigation-loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="datetime-utils.js"></script>
    <link rel="stylesheet" href="webapp-styles.css?v=11">
</head>
<body>
    <div class="unified-page-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ —Å—Ç–∏–ª–µ dashboard -->
        <div class="unified-page-header">
            <div class="back-button" onclick="goBack()">
                <span class="back-button-icon">‚Üê</span>
                <span class="back-button-text">–ù–∞–∑–∞–¥</span>
            </div>
            <h1 class="unified-page-title">
                <span class="unified-page-title-icon">‚úÖ</span>
                <span class="unified-page-title-text">–ó–∞–¥–∞—á–∏</span>
            </h1>
            <div class="unified-action-group">
                <button class="hamburger-menu" onclick="toggleNavigationMenu()">
                    <span class="hamburger-icon">‚ò∞</span>
                </button>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
        <div class="page-actions-section">
            <a href="task_add.html" class="page-action-btn">
                <span class="page-action-btn-icon">+</span>
                –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
            </a>
        </div>

        <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
        <div class="navigation-menu" id="navigation-menu">
            <div class="navigation-menu-header">
                <h3>üß≠ –ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
                <button class="close-menu" onclick="toggleNavigationMenu()">‚úï</button>
            </div>
            <div class="navigation-menu-content">
                <div class="navigation-sections">
                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>

        <!-- Overlay –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é -->
        <div class="menu-overlay" id="menu-overlay" onclick="toggleNavigationMenu()"></div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filter-container">
            <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
            <button class="filter-btn" data-filter="today">–°–µ–≥–æ–¥–Ω—è</button>
            <button class="filter-btn" data-filter="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</button>
            <button class="filter-btn" data-filter="important">–í–∞–∂–Ω—ã–µ</button>
            <button class="filter-btn" data-filter="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</button>
        </div>

        <!-- –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ -->
        <div class="list-container" id="overdue-section" style="display: none;">
            
            <div id="overdue-tasks"></div>
        </div>

        <!-- –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è -->
        <div class="list-container" id="today-section" style="display: none;">
            
            <div id="today-tasks"></div>
        </div>

        <!-- –ë—É–¥—É—â–∏–µ –∑–∞–¥–∞—á–∏ -->
        <div class="list-container" id="future-section" style="display: none;">
            
            <div id="future-tasks"></div>
        </div>

        <!-- –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ -->
        <div class="list-container" id="completed-section" style="display: none;">
            
            <div id="completed-tasks"></div>
        </div>

        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
        <div class="empty-state" id="empty-state" style="display: none;">
            <div class="empty-state-icon">üìù</div>
            <div class="empty-state-title">–ù–µ—Ç –∑–∞–¥–∞—á</div>
            <div class="empty-state-description">
                –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É, –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å" –≤—ã—à–µ
            </div>
        </div>
        

    </div>

      <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
      <div class="loading-state" id="loading-state">
        <div class="loading-spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</div>
      </div>
    </div>
  </div>

  <script src="datetime-utils.js"></script>
  <script>
    // –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    function goBack() {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = 'index.html';
        }
    }

    function toggleNavigationMenu() {
        const menu = document.getElementById('navigation-menu');
        const overlay = document.getElementById('menu-overlay');
        
        if (menu.classList.contains('open')) {
            menu.classList.remove('open');
            overlay.classList.remove('open');
        } else {
            menu.classList.add('open');
            overlay.classList.add('open');
        }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø–æ Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const menu = document.getElementById('navigation-menu');
            if (menu.classList.contains('open')) {
                toggleNavigationMenu();
            }
        }
    });

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let allTasks = [];
    let currentFilter = 'all';

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      initializeTelegram();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      AuthCheck.initAuthCheck(
        // Callback –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        (userId) => {
          console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏");
          setupFilters();
          loadTasks();
        },
        // Callback –¥–ª—è –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        () => {
          console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
          // –≠–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω –≤ AuthCheck.initAuthCheck
        }
      );
    });

    function initializeTelegram() {
      if (window.Telegram?.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
      }
    }

    function setupFilters() {
      const filterBtns = document.querySelectorAll('.filter-btn');
      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          filterBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          filterTasks();
        });
      });
    }

    async function loadTasks() {
      try {
        showLoading(true);
        const userId = getUserId();
        const response = await fetch(`/api/tasks?user_id=${userId}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        allTasks = await response.json();
        filterTasks();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á');
      } finally {
        showLoading(false);
      }
    }

    function filterTasks() {
      const now = luxon.DateTime.now();
      const today = now.startOf('day');
      
      const groups = {
        overdue: [],
        today: [],
        future: [],
        completed: []
      };

      allTasks.forEach(task => {
        if (task.completed) {
          groups.completed.push(task);
          return;
        }

        if (!task.due_date) {
          groups.future.push(task);
          return;
        }

        const dueDate = luxon.DateTime.fromISO(task.due_date);
        const dueDateStart = dueDate.startOf('day');

        if (dueDateStart < today) {
          groups.overdue.push(task);
        } else if (dueDateStart.equals(today)) {
          groups.today.push(task);
        } else {
          groups.future.push(task);
        }
      });

      let filteredGroups = {};
      
      switch (currentFilter) {
        case 'today':
          filteredGroups = { today: groups.today };
          break;
        case 'overdue':
          filteredGroups = { overdue: groups.overdue };
          break;
        case 'important':
          filteredGroups = {
            overdue: groups.overdue.filter(t => t.priority === '–≤–∞–∂–Ω–∞—è'),
            today: groups.today.filter(t => t.priority === '–≤–∞–∂–Ω–∞—è'),
            future: groups.future.filter(t => t.priority === '–≤–∞–∂–Ω–∞—è')
          };
          break;
        case 'completed':
          filteredGroups = { completed: groups.completed };
          break;
        default:
          filteredGroups = groups;
      }

      renderTasks(filteredGroups);
    }

    function renderTasks(groups) {
      document.querySelectorAll('.list-container').forEach(section => {
        section.style.display = 'none';
      });

      let hasAnyTasks = false;

      Object.entries(groups).forEach(([groupName, tasks]) => {
        if (tasks.length > 0) {
          hasAnyTasks = true;
          renderTaskGroup(groupName, tasks);
        }
      });

      document.getElementById('empty-state').style.display = hasAnyTasks ? 'none' : 'block';
    }

    function renderTaskGroup(groupName, tasks) {
      const section = document.getElementById(`${groupName}-section`);
      const container = document.getElementById(`${groupName}-tasks`);
      const countBadge = document.getElementById(`${groupName}-count`);

      if (!section || !container) return;

      if (countBadge) {
        countBadge.textContent = tasks.length;
      }

      container.innerHTML = '';

      tasks.forEach(task => {
        const taskElement = createTaskElement(task);
        container.appendChild(taskElement);
      });

      section.style.display = 'block';
    }

    function createTaskElement(task) {
      const div = document.createElement('div');
      div.className = `list-item ${task.completed ? 'completed' : ''} ${task.priority === '–≤–∞–∂–Ω–∞—è' ? 'important' : ''}`;
      
      const projectColor = task.project_color || '#6366f1';
      const projectName = task.project_name || '–õ–∏—á–Ω—ã–µ';
      
      div.innerHTML = `
        <div class="item-content">
          <div class="item-title">
            <a href="task.html?id=${task.id}">${escapeHtml(task.title)}</a>
          </div>
          <div class="item-meta">
            <span style="color: ${projectColor};">${projectName}</span>
            ${task.due_date ? `<span>${formatDate(task.due_date)}</span>` : ''}
            ${task.priority === '–≤–∞–∂–Ω–∞—è' ? '<span class="badge priority-high">–í–∞–∂–Ω–∞—è</span>' : ''}
          </div>
        </div>
        <div class="item-actions">
          <button class="btn btn-sm btn-success" onclick="toggleTask(${task.id}, ${!task.completed})">
            ${task.completed ? '‚Ü©Ô∏è' : '‚úÖ'}
          </button>
        </div>
      `;
      
      return div;
    }

    async function toggleTask(taskId, completed) {
      try {
        const response = await fetch(`/api/tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ completed })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const taskIndex = allTasks.findIndex(t => t.id === taskId);
        if (taskIndex !== -1) {
          allTasks[taskIndex].completed = completed;
        }

        filterTasks();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
      }
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      
      try {
        const date = luxon.DateTime.fromISO(dateString);
        const now = luxon.DateTime.now();
        
        if (date.hasSame(now, 'day')) {
          return '–°–µ–≥–æ–¥–Ω—è';
        } else if (date.hasSame(now.plus({ days: 1 }), 'day')) {
          return '–ó–∞–≤—Ç—Ä–∞';
        } else if (date.hasSame(now.minus({ days: 1 }), 'day')) {
          return '–í—á–µ—Ä–∞';
        } else {
          return date.toFormat('dd.MM.yyyy');
        }
      } catch (error) {
        return dateString;
      }
    }

    // –§—É–Ω–∫—Ü–∏—è getUserId —Ç–µ–ø–µ—Ä—å –≤ auth-check.js

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showLoading(show) {
      document.getElementById('loading-state').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
      console.error(message);
    }
  </script>
</body>
</html>