

<!DOCTYPE html>
<html class="dark-theme" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–µ–∫—Ç - Task Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="auth-check.js?v=13"></script>
    <script src="webapp-navigation-loader.js"></script>
    
    <link rel="stylesheet" href="webapp-styles.css?v=13">
</head>
<body>
    <div class="unified-page-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ —Å—Ç–∏–ª–µ dashboard -->
        <div class="unified-page-header">
            <div class="back-button" onclick="goBack()">
                <span class="back-button-icon">‚Üê</span>
                <span class="back-button-text">–ù–∞–∑–∞–¥</span>
            </div>
            <h1 class="unified-page-title">
                <span class="unified-page-title-icon">üìÅ</span>
                <span class="unified-page-title-text">–ü—Ä–æ–µ–∫—Ç</span>
            </h1>
            <div class="unified-action-group">
                
                <button class="hamburger-menu" onclick="toggleNavigationMenu()">
                    <span class="hamburger-icon">‚ò∞</span>
                </button>
            </div>
        </div>

        <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
        <div class="navigation-menu" id="navigation-menu">
            <div class="navigation-menu-header">
                <h3>üß≠ –ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
                <button class="close-menu" onclick="toggleNavigationMenu()">‚úï</button>
            </div>
            <div class="navigation-menu-content">
                <div class="navigation-sections">
                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>

        <!-- Overlay –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é -->
        <div class="menu-overlay" id="menu-overlay" onclick="toggleNavigationMenu()"></div>

        <!-- –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞ -->
        <div class="form-container">
            <div class="project-detail-card">
                <div class="project-header">
                    <div class="project-icon">üìÅ</div>
                    <div class="project-info">
                        <h2 class="project-title" id="project-name">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞...</h2>
                        <div class="project-meta">
                            <span class="project-status">–ê–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–µ–∫—Ç</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ -->
            <div class="project-section">
                <h3 class="section-title">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞</h3>
                <div class="section-content">
                    <div id="members-list" class="members-list">
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
            <div class="project-section">
                <h3 class="section-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
                <div class="section-content">
                    <form id="invite-form">
                        <div class="form-group">
                            <label class="form-label" for="user-id">Telegram ID —É—á–∞—Å—Ç–Ω–∏–∫–∞</label>
                            <input type="text" id="user-id" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ Telegram ID" required />
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            –î–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

  <script>
    // –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    function goBack() {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = 'index.html';
        }
    }

    function toggleNavigationMenu() {
        const menu = document.getElementById('navigation-menu');
        const overlay = document.getElementById('menu-overlay');
        
        if (menu.classList.contains('open')) {
            menu.classList.remove('open');
            overlay.classList.remove('open');
        } else {
            menu.classList.add('open');
            overlay.classList.add('open');
        }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø–æ Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const menu = document.getElementById('navigation-menu');
            if (menu.classList.contains('open')) {
                toggleNavigationMenu();
            }
        }
    });
    const tg = window.Telegram.WebApp;
    tg.expand();

    const userId = tg.initDataUnsafe?.user?.id;
    // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    const projectId = new URLSearchParams(window.location.search).get("id") || 
                      new URLSearchParams(window.location.search).get("project_id");

    async function loadProject() {
      try {
        if (!projectId) {
          document.getElementById("project-name").textContent = "ID –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω";
          return;
        }
        
        const res = await fetch(`/api/project?id=${projectId}`);
        if (res.ok) {
          const data = await res.json();
          document.getElementById("project-name").textContent = data.name;
          console.log('‚úÖ –ü—Ä–æ–µ–∫—Ç –∑–∞–≥—Ä—É–∂–µ–Ω:', data);
        } else {
          document.getElementById("project-name").textContent = "–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω";
        }
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞:', error);
        document.getElementById("project-name").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞";
      }
    }

    document.getElementById("invite-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (!projectId) {
        alert("ID –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω");
        return;
      }
      
      const invitedId = document.getElementById("user-id").value;
      
      try {
        const res = await fetch(`/api/project/invite`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ project_id: projectId, user_id: invitedId })
        });
        
        if (res.ok) {
          alert("–£—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω");
          document.getElementById("user-id").value = "";
          loadMembers();
        } else {
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞");
        }
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞:', error);
        alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞");
      }
    });

    async function loadMembers() {
      try {
        if (!projectId) {
          document.getElementById("members-list").innerHTML = "<div class='loading-state'>ID –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω</div>";
          return;
        }
        
        const res = await fetch(`/api/project/members?id=${projectId}`);
        const list = document.getElementById("members-list");
        list.innerHTML = "";

        if (res.ok) {
          const members = await res.json();
          if (members.length === 0) {
            list.innerHTML = "<div class='empty-state'><p>–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p></div>";
          } else {
            const membersList = document.createElement('div');
            membersList.className = 'members-list-content';
            
            for (const member of members) {
              const memberDiv = document.createElement("div");
              memberDiv.className = 'member-item';
              memberDiv.textContent = `ID: ${member.user_id}`;
              membersList.appendChild(memberDiv);
            }
            list.appendChild(membersList);
          }
        } else {
          list.innerHTML = "<div class='error-state'><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p></div>";
        }
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:', error);
        document.getElementById("members-list").innerHTML = "<div class='error-state'><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p></div>";
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    if (projectId) {
      loadProject();
      loadMembers();
    } else {
      document.getElementById("project-name").textContent = "ID –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω";
    }
  </script>
  
</body>
</html>