<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="webapp-styles.css">
</head>
<body>
    <div class="tg-viewport">
        <div class="safe-area-content">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
            <header class="page-header">
                <h1 class="page-title">
                    <span class="page-title-icon">‚öôÔ∏è</span>
                    –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
                </h1>
            </header>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–º—ã -->
            <section class="card">
                <div class="card-header">
                    <h3 class="card-title">üé® –í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label" for="theme-select">–¢–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</label>
                        <select id="theme-select" class="form-control">
                            <option value="auto">üåì –ê–≤—Ç–æ (–∫–∞–∫ –≤ —Å–∏—Å—Ç–µ–º–µ)</option>
                            <option value="light">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</option>
                            <option value="dark">üåô –¢—ë–º–Ω–∞—è</option>
                        </select>
                    </div>

                    <div class="form-actions">
                        <button id="save-btn" class="btn btn-primary btn-full">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                        </button>
                    </div>
                    
                    <div id="status" class="text-center"></div>
                </div>
            </section>

            <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <section class="card">
                <div class="card-header">
                    <h3 class="card-title">üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</h3>
                </div>
                <div class="card-body">
                    <div class="nav-item">
                        <span class="nav-item-icon">üïê</span>
                        <a href="timezone-settings.html">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞</a>
                    </div>
                </div>
            </section>

            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
            <nav class="page-navigation">
                <a href="index.html" class="btn btn-secondary btn-full">
                    ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                </a>
            </nav>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const status = document.getElementById("status");
        const themeSelect = document.getElementById("theme-select");

        async function fetchSettings() {
            const userId = tg.initDataUnsafe.user?.id;
            if (userId) {
                const r = await fetch(`/api/user/settings?user_id=${userId}`);
                if (r.ok) {
                    const { theme } = await r.json();
                    if (theme !== null && theme !== undefined) {
                        themeSelect.value = theme;
                    }
                }
            }
        }

        document.getElementById("save-btn").addEventListener("click", async () => {
            const userId = tg.initDataUnsafe.user?.id;
            if (!userId) return;

            const theme = themeSelect.value;

            try {
                const res2 = await fetch("/api/user/setting", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId, key: "theme", value: theme })
                });

                if (res2.ok) {
                    status.textContent = "‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ";
                } else {
                    status.textContent = "‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è";
                }
            } catch (e) {
                status.textContent = "‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
            }
        });

        fetchSettings();
    </script>
    
</body>
</html>