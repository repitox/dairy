<!DOCTYPE html>
<html class="dark-theme" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ - Task Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="auth-check.js?v=13"></script>
    <script src="webapp-navigation-loader.js"></script>
    <script src="webapp-user-resolver.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <link rel="stylesheet" href="webapp-styles.css?v=11">
</head>

<body>
    <div class="unified-page-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ —Å—Ç–∏–ª–µ dashboard -->
        <div class="unified-page-header">
            <div class="back-button" onclick="goBack()">
                <span class="back-button-icon">‚Üê</span>
                <span class="back-button-text">–ù–∞–∑–∞–¥</span>
            </div>
            <h1 class="unified-page-title">
                <span class="unified-page-title-icon">‚ú®</span>
                <span class="unified-page-title-text">–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</span>
            </h1>
            <div class="unified-action-group">
                <button class="hamburger-menu" onclick="toggleNavigationMenu()">
                    <span class="hamburger-icon">‚ò∞</span>
                </button>
            </div>
        </div>

        <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
        <div class="navigation-menu" id="navigation-menu">
            <div class="navigation-menu-header">
                <h3>üß≠ –ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
                <button class="close-menu" onclick="toggleNavigationMenu()">‚úï</button>
            </div>
            <div class="navigation-menu-content">
                <div class="navigation-sections">
                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>

        <!-- Overlay –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é -->
        <div class="menu-overlay" id="menu-overlay" onclick="toggleNavigationMenu()"></div>

        <div class="form-container event-form-container">
        <form id="event-form" class="event-form">
            <div class="form-group">
                <label for="title" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text" id="title" name="title" required>
            </div>

            <div class="form-group">
                <label for="location" class="form-label">–ú–µ—Å—Ç–æ:</label>
                <input type="text" id="location" name="location">
            </div>

            <div class="form-group">
                <label class="form-label">–ù–∞—á–∞–ª–æ:</label>
                <div class="form-row">
                    <div class="form-half">
                        <input type="date" id="start_date" required>
                        <div class="date-buttons">
                            <button type="button" class="back-link" onclick="setToday('start_date')">–°–µ–≥–æ–¥–Ω—è</button>
                            <button type="button" class="back-link" onclick="setTomorrow('start_date')">–ó–∞–≤—Ç—Ä–∞</button>
                        </div>
                    </div>
                    <div class="form-half">
                        <input type="time" id="start_time">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">–û–∫–æ–Ω—á–∞–Ω–∏–µ:</label>
                <div class="form-row">
                    <div class="form-half">
                        <input type="date" id="end_date">
                        <div class="date-buttons">
                            <button type="button" class="back-link" onclick="setToday('end_date')">–°–µ–≥–æ–¥–Ω—è</button>
                            <button type="button" class="back-link" onclick="setTomorrow('end_date')">–ó–∞–≤—Ç—Ä–∞</button>
                        </div>
                    </div>
                    <div class="form-half">
                        <input type="time" id="end_time">
                    </div>
                </div>
            </div>

        </form>
        <div class="form-row"
            style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-top: 1rem;">
            <a href="events.html" class="back-link"
                style="margin: 0;height: 26px;align-items: center;display: flex;margin: 0;">‚Üê –ù–∞–∑–∞–¥</a>
            <button type="submit" class="btn btn-primary" form="event-form" style="margin: 0;">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'events.html';
            }
        }

        function toggleNavigationMenu() {
            const menu = document.getElementById('navigation-menu');
            const overlay = document.getElementById('menu-overlay');
            
            if (menu.classList.contains('open')) {
                menu.classList.remove('open');
                overlay.classList.remove('open');
            } else {
                menu.classList.add('open');
                overlay.classList.add('open');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø–æ Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const menu = document.getElementById('navigation-menu');
                if (menu.classList.contains('open')) {
                    toggleNavigationMenu();
                }
            }
        });

        function setToday(fieldId) {
            const today = new Date().toISOString().split("T")[0];
            document.getElementById(fieldId).value = today;
        }

        function setTomorrow(fieldId) {
            const tomorrow = new Date(Date.now() + 86400000).toISOString().split("T")[0];
            document.getElementById(fieldId).value = tomorrow;
        }

        document.getElementById('event-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π user_id
                const userId = await getUserId();
                
                const title = document.getElementById('title').value;
                const location = document.getElementById('location').value;

                const startDate = document.getElementById('start_date').value;
                const startTime = document.getElementById('start_time').value;
                const start = startDate ? `${startDate}${startTime ? 'T' + startTime : ''}` : null;

                const endDate = document.getElementById('end_date').value;
                const endTime = document.getElementById('end_time').value;
                const end = endDate ? `${endDate}${endTime ? 'T' + endTime : ''}` : null;

                const res = await fetch('/api/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, title, location, start_at: start, end_at: end }),
                });

                if (res.ok) {
                    window.location.href = 'events.html';
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è');
            }
        });
    </script>
    
</body>

</html>