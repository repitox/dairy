<!DOCTYPE html>
<html class="dark-theme" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á–∏ - Task Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="auth-check.js?v=13"></script>
    <script src="webapp-navigation-loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <link rel="stylesheet" href="webapp-styles.css?v=13">
</head>
<body>
    <div class="unified-page-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ —Å—Ç–∏–ª–µ dashboard -->
        <div class="unified-page-header">
            <button class="back-button" onclick="goBack()">
                <span class="back-button-icon">‚Üê</span>
            </button>
            <h1 class="unified-page-title">
                <span class="unified-page-title-icon">üìã</span>
                <span class="unified-page-title-text">–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á–∏</span>
            </h1>
            <div class="unified-action-group">
                <button class="hamburger-menu" onclick="toggleNavigationMenu()">
                    <span class="hamburger-icon">‚ò∞</span>
                </button>
            </div>
        </div>

        <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
        <div class="navigation-menu" id="navigation-menu">
            <div class="navigation-menu-header">
                <h3>üß≠ –ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
                <button class="close-menu" onclick="toggleNavigationMenu()">‚úï</button>
            </div>
            <div class="navigation-menu-content">
                <div class="navigation-sections">
                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>

        <!-- Overlay –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é -->
        <div class="menu-overlay" id="menu-overlay" onclick="toggleNavigationMenu()"></div>

        <!-- –î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏ -->
        <div class="form-container">
            <div id="task-detail" class="task-detail-card">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á–∏...</div>
                </div>
          </div>
            
            <!-- –î–µ–π—Å—Ç–≤–∏—è —Å –∑–∞–¥–∞—á–µ–π -->
            <div id="task-actions" class="task-actions" style="display: none;">
                <div class="action-buttons-grid">
                      <button id="complete-btn" class="btn btn-success btn-full">
                        <span>‚úÖ</span> –ó–∞–≤–µ—Ä—à–∏—Ç—å
                    </button>
                    <button id="postpone-btn" class="btn btn-secondary btn-full">
                        <span>üìÜ</span> –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
                    </button>
                    <button id="edit-btn" class="btn btn-primary btn-full">
                        <span>‚úèÔ∏è</span> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button id="delete-btn" class="btn btn-danger btn-full">
                        <span>üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

  <script>
    // –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    function goBack() {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = 'index.html';
        }
    }

    function toggleNavigationMenu() {
        const menu = document.getElementById('navigation-menu');
        const overlay = document.getElementById('menu-overlay');
        
        if (menu.classList.contains('open')) {
            menu.classList.remove('open');
            overlay.classList.remove('open');
        } else {
            menu.classList.add('open');
            overlay.classList.add('open');
        }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø–æ Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const menu = document.getElementById('navigation-menu');
            if (menu.classList.contains('open')) {
                toggleNavigationMenu();
            }
        }
    });
    const params = new URLSearchParams(location.search);
    const taskId = params.get("id");

    async function loadTask() {
      try {
        console.log('üìã –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á—É ID:', taskId);
        const userId = await getDbUserId();
        if (!userId) {
          console.error('‚ùå User ID –Ω–µ –ø–æ–ª—É—á–µ–Ω');
          document.getElementById("task-detail").innerHTML = "<p>‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>";
          return;
        }
        console.log('‚úÖ User ID –ø–æ–ª—É—á–µ–Ω:', userId);
        
        const res = await fetch(`/api/tasks/${taskId}?user_id=${userId}`);
        if (!res.ok) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', res.status);
          throw new Error(`HTTP ${res.status}`);
        }
        
        const task = await res.json();
        const container = document.getElementById("task-detail");

      if (!task) {
        container.innerHTML = "<p>–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.</p>";
        return;
      }

      container.innerHTML = `
        <div class="task-header">
            <div class="task-status ${task.completed ? 'completed' : 'pending'}">
                ${task.completed ? '‚úÖ' : '‚è≥'}
            </div>
            <div class="task-info">
                <h2 class="task-title">${escapeHtml(task.title)}</h2>
                <div class="task-meta">
                    <span class="task-priority priority-${task.priority?.toLowerCase() || 'medium'}">
                        ${getPriorityIcon(task.priority)} ${task.priority || '–°—Ä–µ–¥–Ω–∏–π'}
                    </span>
                    <span class="task-status-text">
                        ${task.completed ? '–í—ã–ø–æ–ª–Ω–µ–Ω–∞' : '–í –ø—Ä–æ—Ü–µ—Å—Å–µ'}
                    </span>
                </div>
            </div>
        </div>
        
        ${task.description ? `
        <div class="task-section">
            <h3 class="section-title">üìù –û–ø–∏—Å–∞–Ω–∏–µ</h3>
            <div class="section-content">${escapeHtml(task.description)}</div>
        </div>
        ` : ''}
        
        <div class="task-section">
            <h3 class="section-title">üìÖ –°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
            <div class="section-content">
                ${!task.due_date ? "–ù–µ —É–∫–∞–∑–∞–Ω" :
                  task.due_date.length <= 10
                    ? luxon.DateTime.fromISO(task.due_date).toFormat("dd.MM.yyyy")
                    : luxon.DateTime.fromISO(task.due_date).toFormat("dd.MM.yyyy HH:mm")
                }
            </div>
        </div>
        
        ${task.project_name ? `
        <div class="task-section">
            <h3 class="section-title">üìÅ –ü—Ä–æ–µ–∫—Ç</h3>
            <div class="section-content" style="color: ${task.project_color || '#6366f1'};">${escapeHtml(task.project_name)}</div>
        </div>
        ` : ''}
      `;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
      document.getElementById('task-actions').style.display = 'block';

      document.getElementById("complete-btn").onclick = async () => {
        try {
          const userId = await getDbUserId();
          const response = await fetch(`/api/tasks/${task.id}/toggle?user_id=${userId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: userId })
          });
          
          if (response.ok) {
            if (window.Telegram?.WebApp) {
              window.Telegram.WebApp.showAlert("–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ –∏–∑–º–µ–Ω–µ–Ω!");
            } else {
              alert("–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ –∏–∑–º–µ–Ω–µ–Ω!");
            }
            location.href = "tasks.html";
          } else {
            throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞:', error);
          if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏");
          } else {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏");
          }
        }
      };

      document.getElementById("delete-btn").onclick = async () => {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?")) {
          try {
            const userId = await getDbUserId();
            const res = await fetch(`/api/tasks/${task.id}?user_id=${userId}`, { 
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user_id: userId })
            });
            if (res.ok) {
              alert("‚úÖ –ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞");
              location.href = "tasks.html";
            } else {
              alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
            }
          } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', e);
            alert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
          }
        }
      };

      document.getElementById("edit-btn").onclick = () => {
        location.href = `task_edit.html?id=${task.id}`;
      };

      document.getElementById("postpone-btn").onclick = async () => {
        try {
          const userId = await getDbUserId();
          const tomorrow = luxon.DateTime.now().plus({ days: 1 }).toFormat("yyyy-MM-dd");
          const updated = {
            title: task.title,
            description: task.description,
            due_date: tomorrow,
            priority: task.priority,
            user_id: userId
          };
          const res = await fetch(`/api/tasks/${task.id}?user_id=${userId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updated)
          });
          if (res.ok) {
            alert("‚úÖ –ó–∞–¥–∞—á–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞ –∑–∞–≤—Ç—Ä–∞");
            location.href = "tasks.html";
          } else {
            alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ");
          }
        } catch (e) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞:', e);
          alert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
        }
      };
    }

    Telegram.WebApp.expand();
    loadTask().catch(err => {
      console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', err);
      document.getElementById("task-detail").innerHTML = `<p>‚ùå –û—à–∏–±–∫–∞: ${err.message}</p>`;
    });
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text ? text.replace(/[&<>"']/g, m => map[m]) : '';
    }
    
    function getPriorityIcon(priority) {
        switch(priority?.toLowerCase()) {
            case 'high': return 'üî¥';
            case 'medium': return 'üü°';
            case 'low': return 'üü¢';
            default: return 'üü°';
        }
    }
  </script>
  
</body>
</html>
