<!DOCTYPE html>
<html class="dark-theme" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–∫—É–ø–∫–∏ - Task Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="auth-check.js?v=13"></script>
    <script src="webapp-navigation-loader.js"></script>
    <script src="webapp-user-resolver.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <link rel="stylesheet" href="webapp-styles.css?v=13">
</head>
<body>
    <div class="unified-page-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
        <div class="unified-page-header">
            <div class="back-button" onclick="goBack()">
                <span class="back-button-icon">‚Üê</span>
                <span class="back-button-text">–ù–∞–∑–∞–¥</span>
            </div>
            <h1 class="unified-page-title">
                <span class="unified-page-title-icon">üõí</span>
                <span class="unified-page-title-text">–ü–æ–∫—É–ø–∫–∏</span>
            </h1>
            <div class="unified-action-group">
                <button class="hamburger-menu" onclick="toggleNavigationMenu()">
                    <span class="hamburger-icon">‚ò∞</span>
                </button>
            </div>
        </div>

        <!-- –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
        <div class="navigation-menu" id="navigation-menu">
            <div class="navigation-menu-header">
                <h3>üß≠ –ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
                <button class="close-menu" onclick="toggleNavigationMenu()">‚úï</button>
            </div>
            <div class="navigation-menu-content">
                <div class="navigation-sections">
                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>

        <!-- Overlay –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é -->
        <div class="menu-overlay" id="menu-overlay" onclick="toggleNavigationMenu()"></div>

       <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
        <div class="page-actions-section">
            <button class="page-action-btn" onclick="showAddItemModal()">
                <span class="page-action-btn-icon">+</span>
                –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É
            </button>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filter-container">
             <button class="filter-btn active" data-filter="need">üõí –ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å</button>
            <button class="filter-btn" data-filter="bought">‚úÖ –ö—É–ø–ª–µ–Ω–æ</button>
            <button class="filter-btn" data-filter="all">üìã –í—Å–µ</button>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ -->
        <div id="shopping-list" class="list-container">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫...</div>
            </div>
        </div>

        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
        <div class="empty-state" id="empty-state" style="display: none;">
            <div class="empty-state-icon">üõí</div>
            <div class="empty-state-title">–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ø—É—Å—Ç</div>
            <div class="empty-state-description">
                –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –ø–æ–∫—É–ø–∫—É, –Ω–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å" –≤—ã—à–µ
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏ -->
    <div class="modal-overlay" id="add-item-modal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫—É</h3>
                <button class="modal-close" onclick="hideAddItemModal()">‚úï</button>
            </div>
            <form id="purchase-form" class="modal-form">
                <div class="form-group">
                    <label class="form-label" for="item">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                    <input type="text" id="item" class="form-control" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ –∫—É–ø–∏—Ç—å?" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" id="quantity" class="form-control" placeholder="1" min="1" value="1" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideAddItemModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    function goBack() {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = 'index.html';
        }
    }

    function toggleNavigationMenu() {
        const menu = document.getElementById('navigation-menu');
        const overlay = document.getElementById('menu-overlay');
        
        if (menu.classList.contains('open')) {
            menu.classList.remove('open');
            overlay.classList.remove('open');
        } else {
            menu.classList.add('open');
            overlay.classList.add('open');
        }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø–æ Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const menu = document.getElementById('navigation-menu');
            const modal = document.getElementById('add-item-modal');
            
            if (menu.classList.contains('open')) {
                toggleNavigationMenu();
            } else if (modal.style.display !== 'none') {
                hideAddItemModal();
            }
        }
    });

    // –§—É–Ω–∫—Ü–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function showAddItemModal() {
        document.getElementById('add-item-modal').style.display = 'flex';
        document.getElementById('item').focus();
    }

    function hideAddItemModal() {
        document.getElementById('add-item-modal').style.display = 'none';
        document.getElementById('purchase-form').reset();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        if (window.Telegram?.WebApp) {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
        }

        loadShoppingList();
        setupFilters();
        setupForm();
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫
    async function loadShoppingList() {
        try {
            const userId = getUserId() || "123456789";
            const response = await fetch(`/api/shopping?user_id=${userId}`);
            
            if (response.ok) {
                const data = await response.json();
                displayShoppingList(data.items || []);
            } else {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫');
                showEmptyState();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showEmptyState();
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–∫—É–ø–æ–∫
    function displayShoppingList(items) {
        const container = document.getElementById('shopping-list');
        const emptyState = document.getElementById('empty-state');
        
        if (!items || items.length === 0) {
            showEmptyState();
            return;
        }

        emptyState.style.display = 'none';
        
        const html = items.map(item => `
            <div class="list-item ${item.bought ? 'completed' : ''}" data-id="${item.id}">
                <div class="checkbox ${item.bought ? 'checked' : ''}" onclick="toggleItem(${item.id})"></div>
                <div class="item-content">
                    <div class="item-title">${escapeHtml(item.name)}</div>
                    <div class="item-meta">
                        <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity}</span>
                        ${item.bought ? '<span class="badge badge-success">–ö—É–ø–ª–µ–Ω–æ</span>' : '<span class="badge badge-info">–ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å</span>'}
                    </div>
                </div>
                <div class="item-actions">
                    <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = html;
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    function showEmptyState() {
        document.getElementById('shopping-list').innerHTML = '';
        document.getElementById('empty-state').style.display = 'block';
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function setupFilters() {
        const filterButtons = document.querySelectorAll('.filter-btn');
        filterButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                filterButtons.forEach(b => b.classList.remove('active'));
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ
                this.classList.add('active');
                
                const filter = this.dataset.filter;
                filterItems(filter);
            });
        });
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    function filterItems(filter) {
        const items = document.querySelectorAll('.list-item');
        items.forEach(item => {
            const isBought = item.classList.contains('completed');
            let show = false;
            
            switch(filter) {
                case 'all':
                    show = true;
                    break;
                case 'need':
                    show = !isBought;
                    break;
                case 'bought':
                    show = isBought;
                    break;
            }
            
            item.style.display = show ? 'flex' : 'none';
        });
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º—ã
    function setupForm() {
        document.getElementById('purchase-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('item').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            if (!name) return;
            
            try {
                const userId = getUserId() || "123456789";
                const response = await fetch('/api/shopping', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        name: name,
                        quantity: quantity
                    })
                });
                
                if (response.ok) {
                    hideAddItemModal();
                    loadShoppingList(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–∫—É–ø–∫–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–æ–∫—É–ø–∫–∏');
            }
        });
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–∫—É–ø–∫–∏
    async function toggleItem(itemId) {
        try {
            const userId = getUserId() || "123456789";
            const response = await fetch(`/api/shopping/${itemId}/toggle`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ user_id: userId })
            });
            
            if (response.ok) {
                loadShoppingList(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
        }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏
    async function deleteItem(itemId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–∫—É–ø–∫—É?')) return;
        
        try {
            const userId = getUserId() || "123456789";
            const response = await fetch(`/api/shopping/${itemId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ user_id: userId })
            });
            
            if (response.ok) {
                loadShoppingList(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text ? text.replace(/[&<>"']/g, m => map[m]) : '';
    }
    </script>
</body>
</html>