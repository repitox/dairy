<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç—á–µ—Ç—ã - Dashboard</title>
    <link rel="preload" href="/api/navigation?category=main" as="fetch" crossorigin>
    <link rel="stylesheet" href="ui-components.css">
    <link rel="stylesheet" href="navigation-api.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ===== –°–¢–ò–õ–ò –î–õ–Ø –°–¢–†–ê–ù–ò–¶–´ –û–¢–ß–ï–¢–û–í ===== */



        /* –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
        .filters-panel {
            background: var(--glass-light);
            backdrop-filter: var(--blur-medium);
            -webkit-backdrop-filter: var(--blur-medium);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-large);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-light);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .filter-select, .filter-input {
            padding: 12px 16px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-medium);
            background: var(--glass-light);
            color: var(--text-primary);
            font-size: 14px;
            transition: all var(--transition-fast);
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .apply-filters-btn {
            background: var(--accent-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius-medium);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all var(--transition-medium);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-medium);
        }

        .apply-filters-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-heavy);
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ */
        .grouping-toggle {
            display: flex;
            background: var(--glass-light);
            border-radius: var(--radius-medium);
            padding: 4px;
            border: 1px solid var(--border-light);
        }

        .grouping-option {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-small);
            font-size: 14px;
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        .grouping-option.active {
            background: var(--accent-primary);
            color: white;
            box-shadow: var(--shadow-small);
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--glass-light);
            backdrop-filter: var(--blur-medium);
            -webkit-backdrop-filter: var(--blur-medium);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-large);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-light);
            transition: all var(--transition-medium);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */
        .results-container {
            background: var(--glass-light);
            backdrop-filter: var(--blur-medium);
            -webkit-backdrop-filter: var(--blur-medium);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-large);
            overflow: hidden;
            box-shadow: var(--shadow-light);
        }

        .results-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
            background: var(--glass-medium);
        }

        .results-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .results-content {
            padding: 24px;
        }

        /* –ì—Ä—É–ø–ø—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π */
        .activity-group {
            margin-bottom: 32px;
        }

        .group-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-light);
        }

        .group-icon {
            font-size: 24px;
        }

        .group-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .group-count {
            background: var(--accent-primary);
            color: white;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
        .activity-item {
            background: var(--glass-light);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-medium);
            padding: 16px;
            margin-bottom: 12px;
            transition: all var(--transition-medium);
        }

        .activity-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .activity-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 8px;
        }

        .activity-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            flex: 1;
        }

        .activity-type {
            padding: 4px 8px;
            border-radius: var(--radius-small);
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .activity-type.task {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }

        .activity-type.meeting {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }

        .activity-type.purchase {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        .activity-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .activity-project {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .project-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .activity-date {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state-text {
            font-size: 16px;
            line-height: 1.5;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .header {
                padding: 20px;
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }



            .filters-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .activity-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .activity-meta {
                flex-wrap: wrap;
            }

            .interval-panel {
                flex-direction: column;
                gap: 12px;
            }

            .interval-nav-btn {
                position: static;
                margin: 0 auto;
                width: 40px;
                height: 40px;
            }

            .interval-container {
                flex-direction: column;
                gap: 8px;
            }

            .interval-item {
                width: 100%;
                text-align: center;
            }


        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ */
        .interval-panel {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 24px 0;
            /* padding: 20px;
            background: var(--glass-medium);
            border: 1px solid var(--border-light); */
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-light);
        }

        .interval-nav-btn {
            background: var(--glass-light);
            border: 1px solid var(--border-light);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-medium);
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            flex-shrink: 0;
        }

        .interval-nav-btn:hover {
            background: var(--accent-gradient);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(79, 172, 254, 0.3);
        }

        .interval-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .interval-container {
            display: flex;
            gap: 12px;
            flex: 1;
            overflow-x: auto;
            padding: 8px 0;
            scroll-behavior: smooth;
        }

        .interval-item {
            background: var(--glass-light);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 12px 16px;
            cursor: pointer;
            transition: all var(--transition-medium);
            white-space: nowrap;
            flex-shrink: 0;
            text-align: center;
            min-width: 100px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 14px;
        }

        .interval-item:hover {
            background: var(--glass-medium);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .interval-item.active {
            background: var(--accent-gradient);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 20px rgba(79, 172, 254, 0.3);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç–∞ */
        .custom-multiselect {
            position: relative;
            width: 100%;
        }

        .multiselect-trigger {
            background: var(--glass-light);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 12px 16px;
            cursor: pointer;
            transition: all var(--transition-medium);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 20px;
        }

        .multiselect-trigger:hover {
            background: var(--glass-medium);
            border-color: var(--accent-primary);
        }

        .multiselect-trigger.active {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .multiselect-label {
            color: var(--text-primary);
            font-weight: 500;
            flex: 1;
            text-align: left;
        }

        .multiselect-arrow {
            color: var(--text-secondary);
            transition: transform var(--transition-medium);
            font-size: 12px;
            margin-left: 8px;
        }

        .multiselect-trigger.active .multiselect-arrow {
            transform: rotate(180deg);
        }

        .multiselect-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--glass-medium);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            max-height: 300px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-medium);
            margin-top: 4px;
        }

        .multiselect-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .multiselect-search {
            padding: 12px;
            border-bottom: 1px solid var(--border-light);
        }

        .multiselect-search input {
            width: 100%;
            background: var(--glass-light);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border-color var(--transition-medium);
        }

        .multiselect-search input:focus {
            border-color: var(--accent-primary);
        }

        .multiselect-options {
            max-height: 200px;
            overflow-y: auto;
        }

        .multiselect-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color var(--transition-medium);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .multiselect-option:last-child {
            border-bottom: none;
        }

        .multiselect-option:hover {
            background: var(--glass-light);
        }

        .multiselect-option.selected {
            background: rgba(79, 172, 254, 0.1);
        }

        .option-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-light);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-medium);
            flex-shrink: 0;
        }

        .multiselect-option.selected .option-checkbox {
            background: var(--accent-gradient);
            border-color: transparent;
        }

        .option-checkbox .checkmark {
            color: white;
            font-size: 12px;
            opacity: 0;
            transition: opacity var(--transition-medium);
        }

        .multiselect-option.selected .option-checkbox .checkmark {
            opacity: 1;
        }

        .option-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .option-text {
            color: var(--text-primary);
            font-weight: 500;
            flex: 1;
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div id="navigation-container"></div>

    <div class="unified-page-container">
        <div class="unified-page-header">
            <h1 class="unified-page-title">
                <span class="unified-page-title-icon">üìä</span>
                <span class="unified-page-title-text">–û—Ç—á–µ—Ç—ã –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</span>
            </h1>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
        <div class="filters-panel">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">–ü–µ—Ä–∏–æ–¥ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏</label>
                    <select id="periodFilter" class="filter-select">
                        <option value="day">–ü–æ –¥–Ω—è–º</option>
                        <option value="week">–ü–æ –Ω–µ–¥–µ–ª—è–º</option>
                        <option value="month">–ü–æ –º–µ—Å—è—Ü–∞–º</option>
                        <option value="custom">–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥</option>
                    </select>
                </div>



                <div class="filter-group" id="customDateGroup" style="display: none;">
                    <label class="filter-label">–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞</label>
                    <input type="date" id="startDate" class="filter-input">
                </div>

                <div class="filter-group" id="customDateGroup2" style="display: none;">
                    <label class="filter-label">–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞</label>
                    <input type="date" id="endDate" class="filter-input">
                </div>

                <div class="filter-group">
                    <label class="filter-label">–ü—Ä–æ–µ–∫—Ç—ã</label>
                    <div class="custom-multiselect" id="projectMultiselect">
                        <div class="multiselect-trigger" id="projectTrigger">
                            <span class="multiselect-label" id="projectLabel">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</span>
                            <span class="multiselect-arrow">‚ñº</span>
                        </div>
                        <div class="multiselect-dropdown" id="projectDropdown">
                            <div class="multiselect-search">
                                <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤..." id="projectSearch">
                            </div>
                            <div class="multiselect-options" id="projectOptions">
                                <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞</label>
                    <div class="grouping-toggle">
                        <button class="grouping-option active" data-group="entity">–ü–æ —Ç–∏–ø–∞–º</button>
                        <button class="grouping-option" data-group="project">–ü–æ –ø—Ä–æ–µ–∫—Ç–∞–º</button>
                    </div>
                </div>


            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ -->
        <div class="interval-panel" id="intervalPanel" style="display: flex;">
            <button class="interval-nav-btn" id="prevInterval">‚Äπ</button>
            <div class="interval-container" id="intervalContainer">
                <!-- –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <button class="interval-nav-btn" id="nextInterval">‚Ä∫</button>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalTasks">0</div>
                <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalMeetings">0</div>
                <div class="stat-label">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ –≤—Å—Ç—Ä–µ—á</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalPurchases">0</div>
                <div class="stat-label">–°–æ–≤–µ—Ä—à–µ–Ω–æ –ø–æ–∫—É–ø–æ–∫</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalActivities">0</div>
                <div class="stat-label">–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</div>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div class="results-container">
            <div class="results-header">
                <h2 class="results-title">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
            </div>
            <div class="results-content" id="resultsContent">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script src="auth.js"></script>
    <script src="navigation-api-loader.js"></script>
    <script src="datetime-utils.js"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUserId = null;
        let currentGroupBy = 'entity';
        let userProjects = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onUserLoaded = async function(user) {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
                currentUserId = user.id;

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
                await loadUserProjects();

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                setupEventListeners();

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–µ–Ω—å)
                updateIntervalOptions('day');

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                await loadReportsData();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        Auth.initAuthenticatedPage();

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –§–∏–ª—å—Ç—Ä –ø–µ—Ä–∏–æ–¥–∞
            document.getElementById('periodFilter').addEventListener('change', function() {
                const customGroups = document.querySelectorAll('#customDateGroup, #customDateGroup2');
                const intervalPanel = document.getElementById('intervalPanel');
                
                if (this.value === 'custom') {
                    customGroups.forEach(group => group.style.display = 'block');
                    intervalPanel.style.display = 'none';
                } else {
                    customGroups.forEach(group => group.style.display = 'none');
                    intervalPanel.style.display = 'flex';
                    updateIntervalOptions(this.value);
                }
                loadReportsData();
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
            document.querySelectorAll('.grouping-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.grouping-option').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentGroupBy = this.dataset.group;
                    loadReportsData();
                });
            });

            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º
            document.getElementById('prevInterval').addEventListener('click', () => navigateInterval(-1));
            document.getElementById('nextInterval').addEventListener('click', () => navigateInterval(1));

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç
            document.getElementById('startDate').addEventListener('change', loadReportsData);
            document.getElementById('endDate').addEventListener('change', loadReportsData);

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            window.addEventListener('resize', () => {
                if (currentIntervals.length > 0) {
                    renderIntervals();
                }
            });

            // –ú—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤
            setupProjectMultiselect();
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
        let currentIntervals = [];
        let currentIntervalIndex = 0;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø—Ü–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
        function updateIntervalOptions(period) {
            const intervalContainer = document.getElementById('intervalContainer');
            
            switch (period) {
                case 'day':
                    currentIntervals = generateDayIntervals();
                    break;
                case 'week':
                    currentIntervals = generateWeekIntervals();
                    break;
                case 'month':
                    currentIntervals = generateMonthIntervals();
                    break;
            }
            
            currentIntervalIndex = currentIntervals.length - 1; // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ (—Å–∞–º–æ–≥–æ —Å–≤–µ–∂–µ–≥–æ) –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
            renderIntervals();
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –¥–ª—è –¥–Ω–µ–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)
        function generateDayIntervals() {
            const intervals = [];
            const today = new Date();
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º)
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                let label;
                if (i === 0) {
                    label = '–°–µ–≥–æ–¥–Ω—è';
                } else if (i === 1) {
                    label = '–í—á–µ—Ä–∞';
                } else {
                    label = formatDateForDisplay(date);
                }
                
                intervals.push({
                    value: date.toISOString().split('T')[0],
                    label: label,
                    startDate: date.toISOString().split('T')[0] + 'T00:00:00',
                    endDate: date.toISOString().split('T')[0] + 'T23:59:59'
                });
            }
            
            return intervals;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –¥–ª—è –Ω–µ–¥–µ–ª—å (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –Ω–µ–¥–µ–ª—å)
        function generateWeekIntervals() {
            const intervals = [];
            const today = new Date();
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º)
            for (let i = 11; i >= 0; i--) {
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay() - (i * 7));
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                let label;
                if (i === 0) {
                    label = '–≠—Ç–∞ –Ω–µ–¥–µ–ª—è';
                } else if (i === 1) {
                    label = '–ü—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è';
                } else {
                    label = `${formatDateForDisplay(weekStart)} - ${formatDateForDisplay(weekEnd)}`;
                }
                
                intervals.push({
                    value: `${weekStart.toISOString().split('T')[0]}_${weekEnd.toISOString().split('T')[0]}`,
                    label: label,
                    startDate: weekStart.toISOString().split('T')[0] + 'T00:00:00',
                    endDate: weekEnd.toISOString().split('T')[0] + 'T23:59:59'
                });
            }
            
            return intervals;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –¥–ª—è –º–µ—Å—è—Ü–µ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤)
        function generateMonthIntervals() {
            const intervals = [];
            const today = new Date();
            const monthNames = [
                '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
            ];
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º)
            for (let i = 11; i >= 0; i--) {
                const monthDate = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
                const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
                
                let label;
                if (i === 0) {
                    label = '–≠—Ç–æ—Ç –º–µ—Å—è—Ü';
                } else if (i === 1) {
                    label = '–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü';
                } else {
                    label = `${monthNames[monthDate.getMonth()]} ${monthDate.getFullYear()}`;
                }
                
                intervals.push({
                    value: `${monthStart.toISOString().split('T')[0]}_${monthEnd.toISOString().split('T')[0]}`,
                    label: label,
                    startDate: monthStart.toISOString().split('T')[0] + 'T00:00:00',
                    endDate: monthEnd.toISOString().split('T')[0] + 'T23:59:59'
                });
            }
            
            return intervals;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function formatDateForDisplay(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞—Ç –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        function getIntervalDates(period, selectedInterval) {
            // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
            if (currentIntervals.length > 0 && currentIntervalIndex >= 0) {
                const interval = currentIntervals[currentIntervalIndex];
                return {
                    start: interval.startDate,
                    end: interval.endDate
                };
            }
            
            // Fallback –¥–ª—è —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã
            switch (period) {
                case 'day':
                    return {
                        start: selectedInterval + 'T00:00:00',
                        end: selectedInterval + 'T23:59:59'
                    };
                    
                case 'week':
                case 'month':
                    const [start, end] = selectedInterval.split('_');
                    return {
                        start: start + 'T00:00:00',
                        end: end + 'T23:59:59'
                    };
                    
                default:
                    return { start: null, end: null };
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
        function renderIntervals() {
            const container = document.getElementById('intervalContainer');
            container.innerHTML = '';
            
            // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
            const containerWidth = container.offsetWidth || 800;
            let visibleCount;
            
            if (containerWidth > 1200) {
                visibleCount = 9; // –ë–æ–ª—å—à–∏–µ —ç–∫—Ä–∞–Ω—ã
            } else if (containerWidth > 800) {
                visibleCount = 8; // –°—Ä–µ–¥–Ω–∏–µ —ç–∫—Ä–∞–Ω—ã
            } else if (containerWidth > 600) {
                visibleCount = 5; // –ú–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã
            } else {
                visibleCount = 3; // –ú–æ–±–∏–ª—å–Ω—ã–µ
            }
            
            const halfVisible = Math.floor(visibleCount / 2);
            
            let startIndex = Math.max(0, currentIntervalIndex - halfVisible);
            let endIndex = Math.min(currentIntervals.length - 1, startIndex + visibleCount - 1);
            
            // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å, –µ—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ –∫–æ–Ω—Ü–∞
            if (endIndex - startIndex < visibleCount - 1) {
                startIndex = Math.max(0, endIndex - visibleCount + 1);
            }
            
            for (let i = startIndex; i <= endIndex; i++) {
                const interval = currentIntervals[i];
                const item = document.createElement('div');
                item.className = `interval-item ${i === currentIntervalIndex ? 'active' : ''}`;
                item.textContent = interval.label;
                item.addEventListener('click', () => selectInterval(i));
                container.appendChild(item);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            document.getElementById('prevInterval').disabled = currentIntervalIndex <= 0;
            document.getElementById('nextInterval').disabled = currentIntervalIndex >= currentIntervals.length - 1;
        }

        // –í—ã–±–æ—Ä –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
        function selectInterval(index) {
            currentIntervalIndex = index;
            renderIntervals();
            loadReportsData();
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º
        function navigateInterval(direction) {
            const newIndex = currentIntervalIndex + direction; // –¢–µ–ø–µ—Ä—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä—è–º–æ–µ
            if (newIndex >= 0 && newIndex < currentIntervals.length) {
                selectInterval(newIndex);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserProjects() {
            try {
                const response = await fetch(`/api/reports/projects?user_id=${currentUserId}`);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤');
                
                const data = await response.json();
                userProjects = data.projects;

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤
                populateProjectMultiselect();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:', error);
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç–∞
        let selectedProjects = [];
        let isMultiselectOpen = false;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
        function setupProjectMultiselect() {
            const trigger = document.getElementById('projectTrigger');
            const dropdown = document.getElementById('projectDropdown');
            const searchInput = document.getElementById('projectSearch');

            // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ dropdown
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMultiselect();
            });

            // –ü–æ–∏—Å–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤
            searchInput.addEventListener('input', (e) => {
                filterProjects(e.target.value);
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —ç–ª–µ–º–µ–Ω—Ç–∞
            document.addEventListener('click', (e) => {
                if (!document.getElementById('projectMultiselect').contains(e.target)) {
                    closeMultiselect();
                }
            });
        }

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞–º–∏
        function populateProjectMultiselect() {
            const optionsContainer = document.getElementById('projectOptions');
            optionsContainer.innerHTML = '';

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã"
            const allOption = createProjectOption({
                id: '',
                name: '–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã',
                color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
            });
            optionsContainer.appendChild(allOption);

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
            userProjects.forEach(project => {
                const option = createProjectOption(project);
                optionsContainer.appendChild(option);
            });

            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–±–∏—Ä–∞–µ–º "–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã"
            selectedProjects = [''];
            updateMultiselectLabel();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
        function createProjectOption(project) {
            const option = document.createElement('div');
            option.className = 'multiselect-option';
            option.dataset.projectId = project.id;
            option.innerHTML = `
                <div class="option-checkbox">
                    <span class="checkmark">‚úì</span>
                </div>
                <div class="option-color" style="background: ${project.color};"></div>
                <div class="option-text">${project.name}</div>
            `;

            option.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleProjectSelection(project.id);
            });

            return option;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
        function toggleProjectSelection(projectId) {
            if (projectId === '') {
                // –í—ã–±—Ä–∞–ª–∏ "–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã"
                selectedProjects = [''];
            } else {
                // –£–±–∏—Ä–∞–µ–º "–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã" –µ—Å–ª–∏ –≤—ã–±–∏—Ä–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç
                if (selectedProjects.includes('')) {
                    selectedProjects = [];
                }

                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤—ã–±–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞
                const index = selectedProjects.indexOf(projectId);
                if (index > -1) {
                    selectedProjects.splice(index, 1);
                } else {
                    selectedProjects.push(projectId);
                }

                // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, –≤—ã–±–∏—Ä–∞–µ–º "–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã"
                if (selectedProjects.length === 0) {
                    selectedProjects = [''];
                }
            }

            updateMultiselectUI();
            updateMultiselectLabel();
            loadReportsData();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç–∞
        function updateMultiselectUI() {
            const options = document.querySelectorAll('.multiselect-option');
            options.forEach(option => {
                const projectId = option.dataset.projectId;
                if (selectedProjects.includes(projectId)) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ trigger
        function updateMultiselectLabel() {
            const label = document.getElementById('projectLabel');
            
            if (selectedProjects.includes('')) {
                label.textContent = '–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã';
            } else if (selectedProjects.length === 1) {
                const project = userProjects.find(p => p.id === selectedProjects[0]);
                label.textContent = project ? project.name : '–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω';
            } else {
                label.textContent = `–í—ã–±—Ä–∞–Ω–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: ${selectedProjects.length}`;
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç–∞
        function toggleMultiselect() {
            if (isMultiselectOpen) {
                closeMultiselect();
            } else {
                openMultiselect();
            }
        }

        function openMultiselect() {
            const trigger = document.getElementById('projectTrigger');
            const dropdown = document.getElementById('projectDropdown');
            
            trigger.classList.add('active');
            dropdown.classList.add('show');
            isMultiselectOpen = true;
            
            // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫
            document.getElementById('projectSearch').value = '';
            filterProjects('');
        }

        function closeMultiselect() {
            const trigger = document.getElementById('projectTrigger');
            const dropdown = document.getElementById('projectDropdown');
            
            trigger.classList.remove('active');
            dropdown.classList.remove('show');
            isMultiselectOpen = false;
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ –ø–æ–∏—Å–∫—É
        function filterProjects(searchTerm) {
            const options = document.querySelectorAll('.multiselect-option');
            const term = searchTerm.toLowerCase();

            options.forEach(option => {
                const text = option.querySelector('.option-text').textContent.toLowerCase();
                if (text.includes(term)) {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤
        async function loadReportsData() {
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                </div>
            `;

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (!currentUserId) {
                    throw new Error('ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                }

                // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤
                const params = new URLSearchParams({
                    user_id: currentUserId,
                    group_by: currentGroupBy
                });

                // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                const period = document.getElementById('periodFilter').value;
                if (period === 'custom') {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    if (startDate) params.append('start_date', startDate + 'T00:00:00');
                    if (endDate) params.append('end_date', endDate + 'T23:59:59');
                } else {
                    // –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—ã –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
                    const dates = getIntervalDates(period, null);
                    if (dates.start) params.append('start_date', dates.start);
                    if (dates.end) params.append('end_date', dates.end);
                }

                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø—Ä–æ–µ–∫—Ç–æ–≤
                if (selectedProjects.length > 0 && !selectedProjects.includes('')) {
                    params.append('project_ids', selectedProjects.join(','));
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const response = await fetch(`/api/reports/activities?${params}`);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                
                const data = await response.json();

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateStatistics(data);

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                displayResults(data);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                resultsContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <div class="empty-state-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                        <div class="empty-state-text">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞</div>
                    </div>
                `;
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞—Ç –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞
        function getPeriodDates(period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch (period) {
                case 'day':
                    return {
                        start: today.toISOString(),
                        end: new Date(today.getTime() + 24 * 60 * 60 * 1000 - 1).toISOString()
                    };
                case 'week':
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 7);
                    return {
                        start: weekStart.toISOString(),
                        end: new Date(weekEnd.getTime() - 1).toISOString()
                    };
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59);
                    return {
                        start: monthStart.toISOString(),
                        end: monthEnd.toISOString()
                    };
                default:
                    return { start: null, end: null };
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStatistics(data) {
            let totalTasks = 0;
            let totalMeetings = 0;
            let totalPurchases = 0;

            if (data.group_by === 'entity') {
                totalTasks = data.tasks?.length || 0;
                totalMeetings = data.meetings?.length || 0;
                totalPurchases = data.purchases?.length || 0;
            } else {
                data.projects?.forEach(project => {
                    totalTasks += project.tasks?.length || 0;
                    totalMeetings += project.meetings?.length || 0;
                    totalPurchases += project.purchases?.length || 0;
                });
            }

            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('totalMeetings').textContent = totalMeetings;
            document.getElementById('totalPurchases').textContent = totalPurchases;
            document.getElementById('totalActivities').textContent = totalTasks + totalMeetings + totalPurchases;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function displayResults(data) {
            const resultsContent = document.getElementById('resultsContent');

            if (data.group_by === 'entity') {
                displayByEntity(data, resultsContent);
            } else {
                displayByProject(data, resultsContent);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º —Å—É—â–Ω–æ—Å—Ç–µ–π
        function displayByEntity(data, container) {
            const totalItems = (data.tasks?.length || 0) + (data.meetings?.length || 0) + (data.purchases?.length || 0);
            
            if (totalItems === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div class="empty-state-title">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                        <div class="empty-state-text">–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</div>
                    </div>
                `;
                return;
            }

            let html = '';

            // –ó–∞–¥–∞—á–∏
            if (data.tasks && data.tasks.length > 0) {
                html += createActivityGroup('‚úÖ', '–ó–∞–¥–∞—á–∏', data.tasks, 'task');
            }

            // –í—Å—Ç—Ä–µ—á–∏
            if (data.meetings && data.meetings.length > 0) {
                html += createActivityGroup('üìÖ', '–í—Å—Ç—Ä–µ—á–∏', data.meetings, 'meeting');
            }

            // –ü–æ–∫—É–ø–∫–∏
            if (data.purchases && data.purchases.length > 0) {
                html += createActivityGroup('üõí', '–ü–æ–∫—É–ø–∫–∏', data.purchases, 'purchase');
            }

            container.innerHTML = html;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º
        function displayByProject(data, container) {
            if (!data.projects || data.projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div class="empty-state-title">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                        <div class="empty-state-text">–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</div>
                    </div>
                `;
                return;
            }

            let html = '';
            data.projects.forEach(project => {
                const totalItems = (project.tasks?.length || 0) + (project.meetings?.length || 0) + (project.purchases?.length || 0);
                if (totalItems > 0) {
                    html += `<div class="activity-group">`;
                    html += `
                        <div class="group-header">
                            <div class="project-color" style="background-color: ${project.color || '#6366f1'}; width: 20px; height: 20px;"></div>
                            <h3 class="group-title">${escapeHtml(project.name)}</h3>
                            <span class="group-count">${totalItems}</span>
                        </div>
                    `;

                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
                    if (project.tasks && project.tasks.length > 0) {
                        project.tasks.forEach(task => {
                            html += createActivityItem(task, 'task');
                        });
                    }
                    if (project.meetings && project.meetings.length > 0) {
                        project.meetings.forEach(meeting => {
                            html += createActivityItem(meeting, 'meeting');
                        });
                    }
                    if (project.purchases && project.purchases.length > 0) {
                        project.purchases.forEach(purchase => {
                            html += createActivityItem(purchase, 'purchase');
                        });
                    }

                    html += `</div>`;
                }
            });

            container.innerHTML = html || `
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <div class="empty-state-title">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                    <div class="empty-state-text">–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</div>
                </div>
            `;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
        function createActivityGroup(icon, title, items, type) {
            let html = `
                <div class="activity-group">
                    <div class="group-header">
                        <span class="group-icon">${icon}</span>
                        <h3 class="group-title">${title}</h3>
                        <span class="group-count">${items.length}</span>
                    </div>
            `;

            items.forEach(item => {
                html += createActivityItem(item, type);
            });

            html += `</div>`;
            return html;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        function createActivityItem(item, type) {
            const typeLabels = {
                task: '–ó–∞–¥–∞—á–∞',
                meeting: '–í—Å—Ç—Ä–µ—á–∞',
                purchase: '–ü–æ–∫—É–ø–∫–∞'
            };

            const date = item.completed_at || item.end_at || item.created_at;
            const formattedDate = date ? formatDate(new Date(date)) : '–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';

            return `
                <div class="activity-item">
                    <div class="activity-header">
                        <h4 class="activity-title">${escapeHtml(item.title)}</h4>
                        <span class="activity-type ${type}">${typeLabels[type]}</span>
                    </div>
                    ${item.description ? `<div class="activity-description">${escapeHtml(item.description)}</div>` : ''}
                    <div class="activity-meta">
                        ${item.project_name ? `
                            <div class="activity-project">
                                <div class="project-color" style="background-color: ${item.project_color || '#6366f1'}"></div>
                                <span>${escapeHtml(item.project_name)}</span>
                            </div>
                        ` : ''}
                        <div class="activity-date">
                            <span>üìÖ</span>
                            <span>${formattedDate}</span>
                        </div>
                        ${type === 'purchase' && item.quantity ? `
                            <div class="activity-quantity">
                                <span>üì¶</span>
                                <span>${item.quantity} —à—Ç.</span>
                            </div>
                        ` : ''}
                        ${type === 'purchase' && item.price ? `
                            <div class="activity-price">
                                <span>üí∞</span>
                                <span>${item.price} ‚ÇΩ</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(date) {
            return date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
        function showError(message) {
            console.error(message);
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        }
    </script>
</body>
</html>