<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Å—Ç—Ä–µ—á–∏ - Dashboard</title>
        <link rel="preload" href="/api/navigation?category=main" as="fetch" crossorigin>
    <link rel="stylesheet" href="ui-components.css">
    <link rel="stylesheet" href="navigation-api.css">
    <style>
        .meetings-container {
            max-width: 1000px;
        }
        .meetings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .add-meeting-btn {
            background: var(--tg-blue);
            color: var(--text-inverse);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .add-meeting-btn:hover {
            background: var(--tg-blue-dark);
            transform: translateY(-1px);
        }
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all var(--transition-fast);
        }
        .filter-btn:hover,
        .filter-btn.active {
            background: var(--tg-blue);
            color: var(--text-inverse);
            border-color: var(--tg-blue);
        }
        .meetings-grid {
            display: grid;
            gap: 20px;
        }
        .meeting-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            transition: all var(--transition-medium);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .meeting-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity var(--transition-medium);
        }
        .meeting-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        .meeting-card:hover::before {
            opacity: 1;
        }
        .meeting-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .meeting-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            margin-right: 12px;
        }
        .meeting-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }
        .meeting-status.upcoming {
            background: rgba(0, 122, 255, 0.15);
            color: var(--tg-blue);
        }
        .meeting-status.today {
            background: rgba(255, 149, 0, 0.15);
            color: #ff9500;
        }
        .meeting-status.past {
            background: rgba(142, 142, 147, 0.15);
            color: var(--text-secondary);
        }
        .meeting-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .meeting-time,
        .meeting-location,
        .meeting-project {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .meeting-time span,
        .meeting-location span,
        .meeting-project span {
            font-size: 16px;
        }
        .meeting-description {
            margin-top: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        @media (max-width: 768px) {
            .meetings-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
        <!-- API –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    <div class="unified-page-container">
        <div class="unified-page-header">
            <h1 class="unified-page-title">
                <span class="unified-page-title-icon">üìÖ</span>
                <span class="unified-page-title-text">–í—Å—Ç—Ä–µ—á–∏</span>
            </h1>
            <div class="unified-action-group">
                <button class="unified-action-btn" onclick="addMeeting()">
                    <span class="unified-action-btn-icon">+</span>
                    –î–æ–±–∞–≤–∏—Ç—å –≤—Å—Ç—Ä–µ—á—É
                </button>
            </div>
        </div>
        <div class="filter-bar">
            <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
            <button class="filter-btn" data-filter="upcoming">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</button>
            <button class="filter-btn" data-filter="today">–°–µ–≥–æ–¥–Ω—è</button>
            <button class="filter-btn" data-filter="past">–ü—Ä–æ—à–µ–¥—à–∏–µ</button>
            <button class="filter-btn" data-filter="work">–†–∞–±–æ—á–∏–µ</button>
            <button class="filter-btn" data-filter="personal">–õ–∏—á–Ω—ã–µ</button>
        </div>
        <div id="meetings-container">
            <div class="loading">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å—Ç—Ä–µ—á...</p>
            </div>
        </div>
    </div>
    <script src="auth.js"></script>
    <script src="datetime-utils.js"></script>
    <script>
        // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä DateTimeUtils
        window.DateTimeUtils = new DateTimeUtils();
    </script>
        <script src="navigation-api-loader.js"></script>
<script>


        // üìÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ callback
        let currentUserId = null;
        let allMeetings = [];
        
        console.log('üìÖ meetings.html script block started');
        
        // Callback –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å—Ç—Ä–µ—á –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        window.onUserLoaded = function(user) {
            console.log('üë§ onUserLoaded callback INVOKED for meetings with user:', user);
            if (user) {
                currentUserId = user.id;
                console.log('üë§ onUserLoaded: Setting currentUserId =', currentUserId);
                console.log('üë§ onUserLoaded: Calling loadMeetings()...');
                loadMeetings(currentUserId);
            } else {
                console.warn('‚ö†Ô∏è onUserLoaded called with null/undefined user');
            }
        };
        console.log('‚úì window.onUserLoaded callback defined for meetings');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        console.log('üìÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—Å—Ç—Ä–µ—á...');
        console.log('Auth –æ–±—ä–µ–∫—Ç:', window.Auth);
        console.log('‚Üí Calling Auth.initAuthenticatedPage() for meetings...');
        Auth.initAuthenticatedPage();
        function addMeeting() {
            window.location.href = '/dashboard/add-meeting.html';
        }
        async function loadMeetings(userId) {
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å—Ç—Ä–µ—á –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userId);
            currentUserId = userId;
            try {
                const response = await fetch(`/api/events?user_id=${userId}&filter=–í—Å–µ`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const meetings = await response.json();
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –≤—Å—Ç—Ä–µ—á–∏:', meetings);
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –≤—Å—Ç—Ä–µ—á–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                allMeetings = meetings || [];
                displayMeetings(allMeetings);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å—Ç—Ä–µ—á:', error);
                document.getElementById('meetings-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <div class="empty-state-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                        <div>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å—Ç—Ä–µ—á–∏</div>
                    </div>
                `;
            }
        }
        function displayMeetings(meetings) {
            const container = document.getElementById('meetings-container');
            if (!meetings || meetings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <div class="empty-state-title">–ù–µ—Ç –≤—Å—Ç—Ä–µ—á</div>
                        <div>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –≤—Å—Ç—Ä–µ—á—É</div>
                    </div>
                `;
                return;
            }
            const meetingsHTML = meetings.map(meeting => {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã –∏–∑ API, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
                let startDate = null;
                let endDate = null;
                
                if (meeting.start_at_display) {
                    startDate = new Date(meeting.start_at_display);
                } else if (meeting.start_at) {
                    // Fallback: –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º UTC –¥–∞—Ç—É –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
                    if (window.DateTimeUtils && window.DateTimeUtils.utcToUserTime) {
                        startDate = window.DateTimeUtils.utcToUserTime(meeting.start_at);
                    } else {
                        startDate = new Date(meeting.start_at);
                    }
                }
                
                if (meeting.end_at_display) {
                    endDate = new Date(meeting.end_at_display);
                } else if (meeting.end_at) {
                    // Fallback: –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º UTC –¥–∞—Ç—É –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
                    if (window.DateTimeUtils && window.DateTimeUtils.utcToUserTime) {
                        endDate = window.DateTimeUtils.utcToUserTime(meeting.end_at);
                    } else {
                        endDate = new Date(meeting.end_at);
                    }
                }
                
                const now = new Date();
                const isToday = startDate ? isDateToday(startDate) : false;
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ—Å—Ç–∏
                let isPast = false;
                if (endDate) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                    isPast = endDate < now;
                } else if (startDate) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
                    isPast = startDate < now;
                }
                return `
                    <div class="meeting-card" onclick="viewMeeting(${meeting.id})">
                        <div class="meeting-header">
                            <h3 class="meeting-title">${meeting.title}</h3>
                            <div class="meeting-status ${isPast ? 'past' : isToday ? 'today' : 'upcoming'}">
                                ${isPast ? '–ü—Ä–æ—à–µ–¥—à–∞—è' : isToday ? '–°–µ–≥–æ–¥–Ω—è' : '–ü—Ä–µ–¥—Å—Ç–æ—è—â–∞—è'}
                            </div>
                        </div>
                        <div class="meeting-details">
                            ${startDate || endDate ? `
                                <div class="meeting-time">
                                    <span>üïê</span>
                                    ${startDate ? formatDateTime(startDate) : '–í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}${endDate ? ` - ${formatTime(endDate)}` : ''}
                                </div>
                            ` : ''}
                            ${meeting.location ? `
                                <div class="meeting-location">
                                    <span>üìç</span>
                                    ${meeting.location}
                                </div>
                            ` : ''}
                            ${meeting.project_name ? `
                                <div class="meeting-project">
                                    <span>üìÅ</span>
                                    <span style="color: ${meeting.project_color || '#6366f1'};">${meeting.project_name}</span>
                                </div>
                            ` : ''}
                            ${meeting.description ? `
                                <div class="meeting-description">
                                    ${meeting.description}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = `<div class="meetings-grid">${meetingsHTML}</div>`;
        }
        function formatDateTime(date) {
            return date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        function formatTime(date) {
            return date.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        function isDateToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }
        function viewMeeting(meetingId) {
            window.location.href = `/dashboard/view-meeting.html?id=${meetingId}`;
        }
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤—Å—Ç—Ä–µ—á
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('filter-btn')) {
                // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ
                e.target.classList.add('active');
                const filter = e.target.dataset.filter;
                console.log('–§–∏–ª—å—Ç—Ä:', filter);
                filterMeetings(filter);
            }
        });
        function filterMeetings(filter) {
            let filteredMeetings = [...allMeetings];
            const now = new Date();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            switch (filter) {
                case 'upcoming':
                    filteredMeetings = filteredMeetings.filter(meeting => 
                        meeting.start_at && new Date(meeting.start_at) > now
                    );
                    break;
                case 'today':
                    filteredMeetings = filteredMeetings.filter(meeting => {
                        if (!meeting.start_at) return false;
                        const meetingDate = new Date(meeting.start_at);
                        return meetingDate >= today && meetingDate < tomorrow;
                    });
                    break;
                case 'past':
                    filteredMeetings = filteredMeetings.filter(meeting => 
                        meeting.start_at && new Date(meeting.start_at) < now
                    );
                    break;
                case 'work':
                    filteredMeetings = filteredMeetings.filter(meeting => 
                        meeting.type === 'work' || meeting.project_name !== '–õ–∏—á–Ω—ã–π'
                    );
                    break;
                case 'personal':
                    filteredMeetings = filteredMeetings.filter(meeting => 
                        meeting.type === 'personal' || meeting.project_name === '–õ–∏—á–Ω—ã–π'
                    );
                    break;
                case 'all':
                default:
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –≤—Å—Ç—Ä–µ—á–∏
                    break;
            }
            displayMeetings(filteredMeetings);
        }
    </script>
</body>
</html>
