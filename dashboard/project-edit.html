<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç - Dashboard</title>
        <link rel="preload" href="/api/navigation?category=main" as="fetch" crossorigin>
    <link rel="stylesheet" href="dashboard-styles.css">
        <link rel="stylesheet" href="navigation-api-simple.css">
<link rel="stylesheet" href="ui-components.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        .project-edit-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
        }
        .project-edit-header {
            margin-bottom: 30px;
        }
        .project-edit-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }
        .project-edit-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            margin: 0;
        }
        .project-section {
            margin-bottom: 30px;
        }
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 16px;
            transition: all var(--transition-fast);
            box-sizing: border-box;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--tg-blue);
            box-shadow: 0 0 0 2px rgba(84, 169, 235, 0.2);
        }
        .color-picker {
            width: 60px;
            height: 40px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 4px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
        }
        .color-picker input[type="color"] {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .members-section {
            margin-top: 30px;
        }
        .member-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 12px;
        }
        .member-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .member-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--tg-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        .member-details {
            display: flex;
            flex-direction: column;
        }
        .member-name {
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        .member-role {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 0;
        }
        .member-actions {
            display: flex;
            gap: 8px;
        }
        .member-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all var(--transition-fast);
        }
        .member-action-btn.remove {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }
        .member-action-btn.remove:hover {
            background: rgba(220, 53, 69, 0.3);
        }
        .add-member-section {
            margin-top: 20px;
        }
        .add-member-form {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        .add-member-input {
            flex: 1;
        }
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .notification.success {
            background: #28a745;
        }
        .notification.error {
            background: #dc3545;
        }
        .notification.show {
            transform: translateX(0);
        }
        .empty-members {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        .empty-members-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        @media (max-width: 768px) {
            .project-edit-container {
                padding: 20px;
            }
            .add-member-form {
                flex-direction: column;
                align-items: stretch;
            }
            .form-actions {
                flex-direction: column;
            }
            .member-item {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            .member-actions {
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
        <!-- API –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
<div class="project-edit-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="project-edit-header">
            <h1 class="project-edit-title" id="page-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</h1>
            <p class="project-edit-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –ø—Ä–æ–µ–∫—Ç–∞</p>
        </div>
        <!-- –†–∞–∑–¥–µ–ª "–û–±—â–µ–µ" -->
        <div class="project-section">
            <div class="glass-container">
                <div style="padding: 24px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                    <h2 class="section-title">
                        <span>‚öôÔ∏è</span>
                        –û–±—â–µ–µ
                    </h2>
                </div>
                <div style="padding: 24px;">
                    <form id="project-form">
                        <div class="form-group">
                            <label for="project-name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ *</label>
                            <input type="text" id="project-name" class="form-input" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞">
                        </div>
                        <div class="form-group">
                            <label for="project-color" class="form-label">–¶–≤–µ—Ç –ø—Ä–æ–µ–∫—Ç–∞</label>
                            <div class="color-picker">
                                <input type="color" id="project-color" value="#4facfe">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- –†–∞–∑–¥–µ–ª "–£—á–∞—Å—Ç–Ω–∏–∫–∏" -->
        <div class="project-section">
            <div class="glass-container">
                <div style="padding: 24px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                    <h2 class="section-title">
                        <span>üë•</span>
                        –£—á–∞—Å—Ç–Ω–∏–∫–∏
                    </h2>
                </div>
                <div style="padding: 24px;">
                    <!-- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
                    <div id="members-list">
                        <div class="empty-members">
                            <div class="empty-members-icon">üë•</div>
                            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...</p>
                        </div>
                    </div>
                    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
                    <div class="add-member-section">
                        <div class="add-member-form">
                            <div class="add-member-input">
                                <label for="member-user-id" class="form-label">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</label>
                                <input type="number" id="member-user-id" class="form-input" 
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" min="1">
                            </div>
                            <button type="button" class="btn btn-primary" onclick="addMember()">
                                –î–æ–±–∞–≤–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="goBack()">
                –û—Ç–º–µ–Ω–∞
            </button>
            <button type="button" class="btn btn-primary" onclick="saveProject()">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            </button>
        </div>
    </div>
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="notification" class="notification"></div>
    <script src="auth.js"></script>
    <script src="datetime-utils.js"></script>
    <script>
        window.DateTimeUtils = new DateTimeUtils();
    </script>        <script src="navigation-api-loader.js"></script>
<script>
        let currentProject = null;
        let projectMembers = [];
        // Callback –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.onUserLoaded = function(user) {
            loadProjectData();
        };

        // –ü–æ–ª—É—á–µ–Ω–∏–µ ID –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ URL
        function getProjectId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞
        async function loadProjectData() {
            const projectId = getProjectId();
            if (!projectId) {
                showNotification('ID –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }
            try {
                const user = Auth.getCurrentUser();
                if (!user) return;
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
                const response = await fetch(`/api/projects/${projectId}?user_id=${user.id}`);
                if (!response.ok) {
                    throw new Error('–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
                currentProject = await response.json();
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('project-name').value = currentProject.name;
                document.getElementById('project-color').value = currentProject.color || '#4facfe';
                document.getElementById('page-title').textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç "${currentProject.name}"`;
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                await loadProjectMembers();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞', 'error');
            }
        }
        // –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
        async function loadProjectMembers() {
            const projectId = getProjectId();
            if (!projectId) return;
            try {
                const user = Auth.getCurrentUser();
                if (!user) return;
                const response = await fetch(`/api/projects/${projectId}/members?user_id=${user.id}`);
                if (response.ok) {
                    projectMembers = await response.json();
                    renderMembers();
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:', error);
                document.getElementById('members-list').innerHTML = `
                    <div class="empty-members">
                        <div class="empty-members-icon">‚ùå</div>
                        <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                    </div>
                `;
            }
        }
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        function renderMembers() {
            const container = document.getElementById('members-list');
            if (projectMembers.length === 0) {
                container.innerHTML = `
                    <div class="empty-members">
                        <div class="empty-members-icon">üë•</div>
                        <p>–í –ø—Ä–æ–µ–∫—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                        <p style="font-size: 14px; margin-top: 8px;">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –Ω–∏–∂–µ</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = projectMembers.map(member => `
                <div class="member-item" data-member-id="${member.user_id}">
                    <div class="member-info">
                        <div class="member-avatar">
                            ${member.first_name ? member.first_name.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="member-details">
                            <div class="member-name">
                                ${member.first_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'} ${member.last_name || ''}
                            </div>
                            <div class="member-role">
                                ${member.role === 'owner' ? '–í–ª–∞–¥–µ–ª–µ—Ü' : '–£—á–∞—Å—Ç–Ω–∏–∫'} ‚Ä¢ ID: ${member.user_id}
                            </div>
                        </div>
                    </div>
                    <div class="member-actions">
                        ${member.role !== 'owner' ? `
                            <button class="member-action-btn remove" onclick="removeMember(${member.user_id})">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        async function addMember() {
            const userIdInput = document.getElementById('member-user-id');
            const userId = parseInt(userIdInput.value);
            if (!userId || userId <= 0) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
                return;
            }
            const projectId = getProjectId();
            if (!projectId) return;
            try {
                const user = Auth.getCurrentUser();
                if (!user) return;
                const response = await fetch(`/api/projects/${projectId}/members`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: user.id,
                        member_user_id: userId
                    })
                });
                if (response.ok) {
                    showNotification('–£—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                    userIdInput.value = '';
                    await loadProjectMembers();
                } else {
                    const error = await response.text();
                    if (response.status === 404) {
                        showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    } else {
                        showNotification(`–û—à–∏–±–∫–∞: ${error}`, 'error');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞', 'error');
            }
        }
        // –£–¥–∞–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        async function removeMember(memberId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞?')) {
                return;
            }
            const projectId = getProjectId();
            if (!projectId) return;
            try {
                const user = Auth.getCurrentUser();
                if (!user) return;
                const response = await fetch(`/api/projects/${projectId}/members/${memberId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: user.id
                    })
                });
                if (response.ok) {
                    showNotification('–£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª–µ–Ω', 'success');
                    await loadProjectMembers();
                } else {
                    const error = await response.text();
                    showNotification(`–û—à–∏–±–∫–∞: ${error}`, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞', 'error');
            }
        }
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
        async function saveProject() {
            const projectId = getProjectId();
            if (!projectId) return;
            const name = document.getElementById('project-name').value.trim();
            const color = document.getElementById('project-color').value;
            if (!name) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞', 'error');
                return;
            }
            try {
                const user = Auth.getCurrentUser();
                if (!user) return;
                const response = await fetch(`/api/projects/${projectId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        color: color,
                        owner_id: user.id
                    })
                });
                if (response.ok) {
                    showNotification('–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
                    setTimeout(() => {
                        window.location.href = 'settings.html';
                    }, 1000);
                } else {
                    const error = await response.text();
                    showNotification(`–û—à–∏–±–∫–∞: ${error}`, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞', 'error');
            }
        }
        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        // –í–æ–∑–≤—Ä–∞—Ç –Ω–∞–∑–∞–¥
        function goBack() {
            window.location.href = 'settings.html';
        }
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞
        document.getElementById('member-user-id').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addMember();
            }
        });
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        Auth.initAuthenticatedPage();
    </script>
</body>
</html>