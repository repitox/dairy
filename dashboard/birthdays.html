<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–î–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è - Dashboard</title>
  <link rel="preload" href="/api/navigation?category=main" as="fetch" crossorigin>
  <link rel="stylesheet" href="ui-components.css" />
  <link rel="stylesheet" href="navigation-api.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <div class="page-container">
    <div id="navigation-placeholder"></div>
    <div class="unified-page-container">
      <div class="unified-page-header">
        <h1 class="unified-page-title">
          <span class="unified-page-title-icon">üéÇ</span>
          <span class="unified-page-title-text">–î–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è</span>
        </h1>
        <div class="unified-action-group">
          <button class="unified-action-btn" onclick="window.location.href='/dashboard/birthday-add.html'">
            <span class="unified-action-btn-icon">+</span>
            –î–æ–±–∞–≤–∏—Ç—å –∏–º–µ–Ω–∏–Ω–Ω–∏–∫–∞
          </button>
        </div>
      </div>

      <div class="dashboard-section">
        <div class="section-content">
          <div id="list" class="list-container"></div>
          <div class="pagination" id="pagination" style="margin-top:12px; display:flex; gap:8px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/dashboard/auth.js"></script>
  <script src="/dashboard/navigation-api-loader.js"></script>
  <script src="/dashboard/datetime-utils.js"></script>
  <script>
    const state = { page: 1, limit: 20, total_pages: 1 };
    window.onUserLoaded = function(user) { loadPage(1); };
    Auth.initAuthenticatedPage();

    async function loadPage(page){
      state.page = page;
      const userId = Auth.getCurrentUserId();
      const res = await fetch(`/api/birthdays?user_id=${userId}&page=${page}&limit=${state.limit}`);
      if(!res.ok){ document.getElementById('list').innerHTML = '<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; return; }
      const data = await res.json();
      state.total_pages = data.total_pages || 1;
      renderList(data.items || []);
      renderPagination();
    }

    function renderList(items){
      const container = document.getElementById('list');
      if(!items.length){
        container.innerHTML = '<div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
        return;
      }
      container.innerHTML = items.map(it => {
        const dateText = `${String(it.day).padStart(2,'0')}.${String(it.month).padStart(2,'0')}` + (it.year ? `.${it.year}` : '');
        const badge = `<span class="badge badge-info">—á–µ—Ä–µ–∑ ${it.days_until} –¥–Ω.</span>`;
        return `
          <div class="list-item" style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
            <a class="item-content" href="/dashboard/birthday-edit.html?id=${it.id}" style="text-decoration:none; color:inherit;">
              <div class="item-title">${escapeHtml(it.full_name)} ${badge}</div>
              <div class="item-meta">${dateText}${it.description ? ' ‚Ä¢ ' + escapeHtml(it.description) : ''}</div>
            </a>
            <div class="item-actions" style="opacity:1;">
              <a class="btn btn-secondary btn-sm" href="/dashboard/birthday-edit.html?id=${it.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
              <button class="btn btn-danger btn-sm" onclick="deleteBirthday(${it.id})">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderPagination(){
      const p = document.getElementById('pagination');
      if(state.total_pages <= 1){ p.innerHTML = ''; return; }
      const prev = `<button class="btn" ${state.page<=1?'disabled':''} onclick="loadPage(${state.page-1})">‚Üê –ù–∞–∑–∞–¥</button>`;
      const next = `<button class="btn" ${state.page>=state.total_pages?'disabled':''} onclick="loadPage(${state.page+1})">–í–ø–µ—Ä—ë–¥ ‚Üí</button>`;
      p.innerHTML = `${prev}<span class="item-meta" style="align-self:center">–°—Ç—Ä. ${state.page} / ${state.total_pages}</span>${next}`;
    }

    async function deleteBirthday(id){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
      try{
        const res = await fetch(`/api/birthdays/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: Auth.getCurrentUserId() })
        });
        if(res.ok){
          loadPage(state.page);
        }else{
          const t = await res.text();
          alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + t);
        }
      }catch(e){
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + e);
      }
    }

    function escapeHtml(text){
      const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'};
      return String(text||'').replace(/[&<>"']/g, m => map[m]);
    }
  </script>
</body>
</html>

