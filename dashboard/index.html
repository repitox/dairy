<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dialist ‚Äî –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram</title>
    
    <!-- UI Kit styles -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* UI Kit –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
            --tg-purple: #6a11cb;
            --tg-blue: #2575fc;
            --bg-card: rgba(255, 255, 255, 0.08);
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.8);
            --text-inverse: #ffffff;
            --border-light: rgba(255,255,255,0.15);
            --shadow-dark: rgba(0,0,0,0.25);
            --success: #4dff88;
            --error: #ff6b6b;
            --warning: #ffb347;
            --transition-fast: 0.2s ease;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--tg-purple) 0%, var(--tg-blue) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        }

        .auth-container {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px var(--shadow-dark);
            text-align: center;
            max-width: 420px;
            width: 92%;
            border: 1px solid var(--border-light);
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 48px;
            margin-bottom: 20px;
            display: block;
        }

        h1 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 700;
            margin-top: 0;
        }

        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.5;
        }

        .telegram-login {
            margin: 20px 0;
        }

        .loading, .error, .success {
            display: none;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            font-weight: 600;
        }

        .loading {
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
        }

        .error {
            background: rgba(255, 107, 122, 0.1);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .success {
            background: rgba(77, 255, 136, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .local-dev {
            background: rgba(255, 179, 71, 0.1);
            border: 1px solid var(--warning);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .local-dev p {
            color: var(--warning);
            font-weight: 600;
            margin-bottom: 15px;
            margin-top: 0;
        }

        .local-dev button {
            background: var(--tg-purple);
            color: var(--text-inverse);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all var(--transition-fast);
            font-family: inherit;
        }

        .local-dev button:hover {
            background: var(--tg-blue);
            transform: translateY(-1px);
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        .navigation-container,
        .nav-container,
        nav {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- –û—Ç–∫–ª—é—á–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <script>window.__DISABLE_DASHBOARD_NAV__ = true;</script>
    
    <div class="auth-container">
        <div class="logo">üöÄ</div>
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
        <p class="subtitle">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</p>
        
        <div class="telegram-login" id="telegram-login">
            <script async src="https://telegram.org/js/telegram-widget.js?22" 
                    data-telegram-login="rptx_bot" 
                    data-size="large" 
                    data-onauth="onTelegramAuth(user)" 
                    data-request-access="write">
            </script>
        </div>
        
        <div class="local-dev" id="local-dev">
            <p>‚ö†Ô∏è –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏</p>
            <button onclick="window.location.href='/local-auth'">
                –í–æ–π—Ç–∏ –∫–∞–∫ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            </button>
        </div>
        
        <div class="loading" id="loading">
            ‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...
        </div>
        
        <div class="error" id="error">
            <span id="error-message">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</span>
        </div>
        
        <div class="success" id="success">
            ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...
        </div>
    </div>

    <script>
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
        function checkDevMode() {
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1';
            if (isLocalhost) {
                document.getElementById('telegram-login').style.display = 'none';
                document.getElementById('local-dev').style.display = 'block';
                console.log('üîß –†–µ–∂–∏–º –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        document.addEventListener("DOMContentLoaded", () => {
            checkDevMode();
            const savedUser = localStorage.getItem("telegram_user");
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    console.log("üîÅ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:", user.first_name);
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É dashboard
                    window.location.href = '/dashboard/main.html';
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", e);
                    localStorage.removeItem("telegram_user");
                }
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –¥–ª—è Telegram Login Widget
        function onTelegramAuth(user) {
            console.log("üì± –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram:", user);
            showLoading();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            fetch('/api/auth/telegram', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(user)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞:", data);
                if (!data.user || !data.user.id) {
                    throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
                }
                if (!data.user.personal_project_id) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω—ã–π –ø—Ä–æ–µ–∫—Ç");
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                const userData = {
                    ...data.user,
                    auth_time: Date.now() // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                };
                localStorage.setItem("telegram_user", JSON.stringify(userData));
                console.log("üíæ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω:", userData);
                showSuccess();
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                setTimeout(() => {
                    window.location.href = '/dashboard/main.html';
                }, 1000);
            })
            .catch(error => {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", error);
                showError(error.message);
            });
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('success').style.display = 'none';
            document.getElementById('error-message').textContent = message;
        }

        function showSuccess() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'block';
        }
    </script>
</body>
</html>