<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram</title>
    <link rel="stylesheet" href="dashboard-styles.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--tg-purple) 0%, var(--tg-blue) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .auth-container {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px var(--shadow-dark);
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 1px solid var(--border-light);
        }
        .logo {
            font-size: 48px;
            margin-bottom: 20px;
        }
        h1 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 16px;
        }
        .telegram-login {
            margin: 20px 0;
        }
        .loading {
            display: none;
            color: var(--text-secondary);
            margin-top: 20px;
        }
        .error {
            background: rgba(255, 107, 122, 0.1);
            color: var(--error);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            border: 1px solid var(--error);
        }
        .success {
            background: rgba(77, 255, 136, 0.1);
            color: var(--success);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            border: 1px solid var(--success);
        }
        .local-dev {
            background: rgba(255, 179, 71, 0.1);
            border: 1px solid var(--warning);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .local-dev button {
            background: var(--tg-purple);
            color: var(--text-inverse);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all var(--transition-fast);
        }
        .local-dev button:hover {
            background: var(--tg-blue);
            transform: translateY(-1px);
        }
        .local-dev p {
            color: var(--warning);
            font-weight: bold;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="logo">üöÄ</div>
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
        <p class="subtitle">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</p>
        
        <div class="telegram-login" id="telegram-login">
            <script async src="https://telegram.org/js/telegram-widget.js?22" 
                    data-telegram-login="rptx_bot" 
                    data-size="large" 
                    data-onauth="onTelegramAuth(user)" 
                    data-request-access="write">
            </script>
        </div>
        
        <div class="local-dev" id="local-dev" style="display: none;">
            <p style="color: #ff6b6b; font-weight: bold; margin-bottom: 15px;">
                üîß –†–µ–∂–∏–º –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
            </p>
            <button onclick="window.location.href='/local-auth'" 
                    style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px;">
                –í–æ–π—Ç–∏ –∫–∞–∫ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            </button>
        </div>
        
        <div class="loading" id="loading">
            <p>‚è≥ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...</p>
        </div>
        
        <div class="error" id="error">
            <p id="error-message">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>
        </div>
        
        <div class="success" id="success">
            <p>‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...</p>
        </div>
    </div>

    <script>
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
        function checkDevMode() {
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1';
            
            if (isLocalhost) {
                document.getElementById('telegram-login').style.display = 'none';
                document.getElementById('local-dev').style.display = 'block';
                console.log('üîß –†–µ–∂–∏–º –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        document.addEventListener("DOMContentLoaded", () => {
            checkDevMode();
            
            const savedUser = localStorage.getItem("telegram_user");
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    console.log("üîÅ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:", user.first_name);
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –±–µ–∑ user_id –≤ URL
                    window.location.href = '/dashboard/main.html';
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", e);
                    localStorage.removeItem("telegram_user");
                }
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –¥–ª—è Telegram Login Widget
        function onTelegramAuth(user) {
            console.log("üì± –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram:", user);
            
            showLoading();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            fetch('/api/auth/telegram', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(user)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞:", data);
                
                if (!data.user || !data.user.id) {
                    throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞");
                }
                
                if (!data.user.internal_id) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö");
                }
                
                if (!data.user.personal_project_id) {
                    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω—ã–π –ø—Ä–æ–µ–∫—Ç");
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                const userData = {
                    ...data.user,
                    auth_time: Date.now() // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                };
                
                localStorage.setItem("telegram_user", JSON.stringify(userData));
                console.log("üíæ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω:", userData);
                
                showSuccess();
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                setTimeout(() => {
                    window.location.href = '/dashboard/main.html';
                }, 1000);
            })
            .catch(error => {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", error);
                showError(error.message);
            });
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('success').style.display = 'none';
            document.getElementById('error-message').textContent = message;
        }

        function showSuccess() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'block';
        }
    </script>
    
</body>
</html>