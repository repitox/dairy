<body>
    <h2>Вход через Telegram</h2>
    <a href="https://oauth.telegram.org/auth?bot_id=7105955108&origin=https://rptx.na4u.ru&embed=1&request_access=write">
        <img src="https://telegram.org/img/oauth/tg_button.png" alt="Войти через Telegram">
    </a>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const getParamsFromHash = (hash) => {
                const hashParams = new URLSearchParams(hash.slice(1)); // удаляем #
                const user = hashParams.get("user");
                const hashValue = hashParams.get("hash");
                return { user, hash: hashValue };
            };

            const { user, hash } = getParamsFromHash(window.location.hash);

            if (user && hash) {
                try {
                    const decodedUser = JSON.parse(decodeURIComponent(user));
                    localStorage.setItem("telegram_user", JSON.stringify(decodedUser));
                    window.location.href = `/dashboard/main.html?user_id=${decodedUser.id}`;
                } catch (e) {
                    console.error("Ошибка обработки user:", e);
                }
            } else {
                const savedUser = localStorage.getItem("telegram_user");
                if (savedUser) {
                    const user = JSON.parse(savedUser);
                    console.log("🔁 Пользователь уже авторизован:", user);
                    window.location.href = `/dashboard/main.html?user_id=${user.id}`;
                }
            }
        });
    </script>
</body>