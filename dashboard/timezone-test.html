<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤ - Dashboard</title>
    <link rel="stylesheet" href="dashboard-styles.css">
    <script src="auth.js"></script>
    <script src="datetime-utils.js"></script>
    <style>
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-result {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid var(--accent-color);
        }
        .test-input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        .test-button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="page-header">
            <h1 class="page-title">
                <span class="page-title-icon">üß™</span>
                –¢–µ—Å—Ç —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤
            </h1>
        </div>

        <div class="test-section">
            <h3>1. –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ —Å –¥–∞—Ç–æ–π</h3>
            <p>–°–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞—á—É —Å –¥–∞—Ç–æ–π –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ UTC –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ.</p>
            
            <input type="text" id="task-title" class="test-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" value="–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞">
            <input type="datetime-local" id="task-due-date" class="test-input">
            <button class="test-button" onclick="createTestTask()">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
            
            <div id="task-result" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>2. –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è —Å –¥–∞—Ç–æ–π</h3>
            <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–æ–±—ã—Ç–∏–µ —Å –¥–∞—Ç–æ–π –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é –≤—Ä–µ–º–µ–Ω–∏.</p>
            
            <input type="text" id="event-title" class="test-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è" value="–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ">
            <input type="text" id="event-location" class="test-input" placeholder="–ú–µ—Å—Ç–æ" value="–¢–µ—Å—Ç–æ–≤–æ–µ –º–µ—Å—Ç–æ">
            <input type="datetime-local" id="event-start" class="test-input" placeholder="–ù–∞—á–∞–ª–æ">
            <input type="datetime-local" id="event-end" class="test-input" placeholder="–ö–æ–Ω–µ—Ü">
            <button class="test-button" onclick="createTestEvent()">–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
            
            <div id="event-result" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>3. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ</h3>
            <div id="timezone-info" class="test-result">
                <p><strong>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ...</strong></p>
            </div>
            <button class="test-button" onclick="updateTimezoneInfo()">–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</button>
        </div>

        <div class="test-section">
            <h3>4. –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á</h3>
            <button class="test-button" onclick="loadTestTasks()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á–∏</button>
            <div id="tasks-result" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>5. –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π</h3>
            <button class="test-button" onclick="loadTestEvents()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–±—ã—Ç–∏—è</button>
            <div id="events-result" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let currentUser = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onUserLoaded = async function(user) {
            currentUser = user;
            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω:', user);
            
            // –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ DateTimeUtils
            setTimeout(async () => {
                if (window.DateTimeUtils && typeof window.DateTimeUtils.init === 'function') {
                    await window.DateTimeUtils.init();
                }
                updateTimezoneInfo();
            }, 100);
        };

        Auth.initAuthenticatedPage();

        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –ø–æ–ª—è
        function setCurrentTime() {
            const now = new Date();
            const localDateTime = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            
            document.getElementById('task-due-date').value = localDateTime;
            document.getElementById('event-start').value = localDateTime;
            
            const endTime = new Date(now.getTime() + 60*60*1000); // +1 —á–∞—Å
            const endDateTime = new Date(endTime.getTime() - (endTime.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('event-end').value = endDateTime;
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
        function updateTimezoneInfo() {
            const info = document.getElementById('timezone-info');
            
            let html = '<p><strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ:</strong></p>';
            
            if (window.DateTimeUtils) {
                const userTz = window.DateTimeUtils.getUserTimezone();
                const detectedTz = window.DateTimeUtils.detectUserTimezone();
                const currentTime = window.DateTimeUtils.getUserCurrentTime();
                
                html += `<p>‚Ä¢ –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: UTC${userTz >= 0 ? '+' : ''}${userTz}</p>`;
                html += `<p>‚Ä¢ –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å: UTC${detectedTz >= 0 ? '+' : ''}${detectedTz}</p>`;
                html += `<p>‚Ä¢ –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${currentTime ? currentTime.toLocaleString('ru-RU') : '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'}</p>`;
            } else {
                html += '<p>‚ùå DateTimeUtils –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>';
            }
            
            const browserTz = -new Date().getTimezoneOffset() / 60;
            html += `<p>‚Ä¢ –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –±—Ä–∞—É–∑–µ—Ä–∞: UTC${browserTz >= 0 ? '+' : ''}${browserTz}</p>`;
            html += `<p>‚Ä¢ –í—Ä–µ–º—è –±—Ä–∞—É–∑–µ—Ä–∞: ${new Date().toLocaleString('ru-RU')}</p>`;
            
            info.innerHTML = html;
        }

        // –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–¥–∞—á—É
        async function createTestTask() {
            if (!currentUser) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                return;
            }

            const title = document.getElementById('task-title').value;
            const dueDate = document.getElementById('task-due-date').value;

            if (!title || !dueDate) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            const taskData = {
                user_id: currentUser.id,
                title: title,
                due_date: dueDate,
                priority: '–æ–±—ã—á–Ω–∞—è'
            };

            try {
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É:', taskData);
                
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskData)
                });

                const result = await response.json();
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏:', result);

                const resultDiv = document.getElementById('task-result');
                resultDiv.style.display = 'block';
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <p><strong>‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!</strong></p>
                        <p>‚Ä¢ ID: ${result.id}</p>
                        <p>‚Ä¢ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –¥–∞—Ç–∞: ${dueDate}</p>
                        <p>‚Ä¢ –°—Ç–∞—Ç—É—Å: ${result.status}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <p><strong>‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏</strong></p>
                        <p>${JSON.stringify(result)}</p>
                    `;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                const resultDiv = document.getElementById('task-result');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<p><strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${error.message}</p>`;
            }
        }

        // –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
        async function createTestEvent() {
            if (!currentUser) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                return;
            }

            const title = document.getElementById('event-title').value;
            const location = document.getElementById('event-location').value;
            const startAt = document.getElementById('event-start').value;
            const endAt = document.getElementById('event-end').value;

            if (!title || !location || !startAt || !endAt) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            const eventData = {
                user_id: currentUser.id,
                title: title,
                location: location,
                start_at: startAt,
                end_at: endAt
            };

            try {
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ:', eventData);
                
                const response = await fetch('/api/events', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventData)
                });

                const result = await response.json();
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', result);

                const resultDiv = document.getElementById('event-result');
                resultDiv.style.display = 'block';
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <p><strong>‚úÖ –°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ!</strong></p>
                        <p>‚Ä¢ ID: ${result.id}</p>
                        <p>‚Ä¢ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: ${startAt}</p>
                        <p>‚Ä¢ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è: ${endAt}</p>
                        <p>‚Ä¢ –°—Ç–∞—Ç—É—Å: ${result.status}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <p><strong>‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è</strong></p>
                        <p>${JSON.stringify(result)}</p>
                    `;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                const resultDiv = document.getElementById('event-result');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<p><strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${error.message}</p>`;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–¥–∞—á–∏
        async function loadTestTasks() {
            if (!currentUser) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                return;
            }

            try {
                const response = await fetch(`/api/tasks?user_id=${currentUser.id}`);
                const tasks = await response.json();
                
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:', tasks);

                const resultDiv = document.getElementById('tasks-result');
                resultDiv.style.display = 'block';
                
                if (response.ok && tasks.length > 0) {
                    let html = '<p><strong>üìã –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:</strong></p>';
                    
                    tasks.slice(0, 3).forEach(task => {
                        html += `
                            <div style="border: 1px solid var(--border-light); padding: 10px; margin: 5px 0; border-radius: 4px;">
                                <p><strong>${task.title}</strong></p>
                                <p>‚Ä¢ –ò—Å—Ö–æ–¥–Ω–∞—è –¥–∞—Ç–∞ (UTC): ${task.due_date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                                <p>‚Ä¢ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–∞—è –¥–∞—Ç–∞: ${task.due_date_display || '–ù–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞'}</p>
                                <p>‚Ä¢ –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è –¥–∞—Ç–∞: ${task.due_date_relative || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}</p>
                            </div>
                        `;
                    });
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<p>–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                const resultDiv = document.getElementById('tasks-result');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<p><strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${error.message}</p>`;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
        async function loadTestEvents() {
            if (!currentUser) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                return;
            }

            try {
                const response = await fetch(`/api/events?user_id=${currentUser.id}`);
                const events = await response.json();
                
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:', events);

                const resultDiv = document.getElementById('events-result');
                resultDiv.style.display = 'block';
                
                if (response.ok && events.length > 0) {
                    let html = '<p><strong>üìÖ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:</strong></p>';
                    
                    events.slice(0, 3).forEach(event => {
                        html += `
                            <div style="border: 1px solid var(--border-light); padding: 10px; margin: 5px 0; border-radius: 4px;">
                                <p><strong>${event.title}</strong></p>
                                <p>‚Ä¢ –ò—Å—Ö–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ (UTC): ${event.start_at || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                                <p>‚Ä¢ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: ${event.start_at_display || '–ù–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ'}</p>
                                <p>‚Ä¢ –ò—Å—Ö–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è (UTC): ${event.end_at || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                                <p>‚Ä¢ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è: ${event.end_at_display || '–ù–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ'}</p>
                            </div>
                        `;
                    });
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<p>–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                const resultDiv = document.getElementById('events-result');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<p><strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${error.message}</p>`;
            }
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            setCurrentTime();
        });
    </script>
</body>
</html>