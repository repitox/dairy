<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–µ–∫—Ç—ã - Dashboard</title>
        <link rel="preload" href="/api/navigation?category=main" as="fetch" crossorigin>
    <link rel="stylesheet" href="ui-components.css">
    <link rel="stylesheet" href="navigation-api.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–∫—É–ø–æ–∫ –≤ –ø—Ä–æ–µ–∫—Ç–∞—Ö */
        .shopping-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }
        
        .shopping-item:last-child {
            border-bottom: none;
        }
        
        .shopping-item.completed {
            opacity: 0.6;
        }
        
        .shopping-item.completed .item-name {
            text-decoration: line-through;
        }
        
        .item-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-top: 2px;
            position: relative;
        }
        
        .item-checkbox:hover {
            border-color: var(--accent-color, #6366f1);
            background: rgba(99, 102, 241, 0.1);
        }
        
        .item-checkbox.checked {
            background: var(--accent-color, #6366f1);
            border-color: var(--accent-color, #6366f1);
        }
        
        .item-checkbox.checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .item-content {
            flex: 1;
            min-width: 0;
        }
        
        .item-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            word-wrap: break-word;
        }
        
        .item-details {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .item-quantity {
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent-color, #6366f1);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .item-price {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .item-list {
            background: rgba(156, 163, 175, 0.1);
            color: var(--text-secondary);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 400;
        }
        
        .item-comment {
            margin-top: 6px;
            font-size: 11px;
            color: var(--text-secondary);
            font-style: italic;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 4px;
            border-left: 2px solid rgba(99, 102, 241, 0.3);
        }
        
        .items-divider {
            margin: 16px 0 8px 0;
            padding: 8px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-state p {
            margin-bottom: 0;
            font-size: 14px;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-width: 768px) {
            .shopping-item {
                padding: 10px 0;
            }
            
            .item-details {
                font-size: 11px;
                gap: 6px;
            }
            
            .item-checkbox {
                width: 18px;
                height: 18px;
            }
            
            .empty-state {
                padding: 30px 15px;
            }
            
            .empty-state-icon {
                font-size: 36px;
            }
        }
    </style>
</head>
<body>
        <!-- API –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav id="navigation-container"></nav>
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="main-content">
        <div class="unified-page-container">
            <div class="unified-page-header">
                <h1 class="unified-page-title">
                    <span class="unified-page-title-icon">üìÅ</span>
                    <span class="unified-page-title-text">–ü—Ä–æ–µ–∫—Ç—ã</span>
                </h1>
                <div class="unified-action-group">
                    <a href="/dashboard/create-project.html" class="unified-action-btn">
                        <span class="unified-action-btn-icon">+</span>
                        –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
                    </a>
                </div>
            </div>
            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å —Ç–∞–±–∞–º–∏ -->
            <div class="content-wrapper">
                <div class="tabs-container" id="projects-tabs">
                    <div class="tabs-header" id="tabs-header">
                        <!-- –¢–∞–±—ã –ø—Ä–æ–µ–∫—Ç–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                    <div class="tabs-content" id="tabs-content">
                        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–æ–≤ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>
        </div>
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤ -->
    <script src="auth.js"></script>
    <script src="datetime-utils.js"></script>
    <script>
        window.DateTimeUtils = new DateTimeUtils();
    </script>        <script src="navigation-api-loader.js"></script>
<script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = null;
        let projects = [];
        let currentProjectId = null;
        
        // Callback –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.onUserLoaded = function(user) {
            if (user && user.id) {
                currentUser = user;
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ callback:', user);
                loadProjects();
            }
        };
        // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç—ã —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å
        function initPage() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–µ–∫—Ç–æ–≤...');
            
            if (currentUser && currentUser.id) {
                console.log('CurrentUser —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω:', currentUser);
                loadProjects();
                return;
            }
            
            const user = Auth.getCurrentUser();
            if (user && user.id) {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–µ–Ω –æ—Ç Auth:', user);
                currentUser = user;
                loadProjects();
            } else {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ Auth');
                showEmptyState();
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤
        async function loadProjects() {
            if (!currentUser) {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
                showEmptyState();
                return;
            }
            try {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', currentUser.id);
                const response = await fetch(`/api/projects?user_id=${currentUser.id}`);
                if (response.ok) {
                    const data = await response.json();
                    projects = data.projects || data;
                    console.log('–ü—Ä–æ–µ–∫—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', projects);
                    renderTabs();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:', response.status);
                    showEmptyState();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:', error);
                showEmptyState();
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–æ–≤
        function renderTabs() {
            console.log('–û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–æ–≤, –ø—Ä–æ–µ–∫—Ç—ã:', projects);
            const tabsHeader = document.getElementById('tabs-header');
            const tabsContent = document.getElementById('tabs-content');
            if (!projects || projects.length === 0) {
                console.log('–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                showEmptyState();
                return;
            }
            console.log('–û—Ç—Ä–∏—Å–æ–≤–∫–∞', projects.length, '–ø—Ä–æ–µ–∫—Ç–æ–≤');
            // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            tabsHeader.innerHTML = '';
            tabsContent.innerHTML = '';
            // –°–æ–∑–¥–∞–µ–º —Ç–∞–±—ã
            projects.forEach((project, index) => {
                // –°–æ–∑–¥–∞–µ–º —Ç–∞–±
                const tabItem = document.createElement('div');
                tabItem.className = `tab-item ${index === 0 ? 'active' : ''}`;
                tabItem.setAttribute('data-tab', `project-${project.id}`);
                tabItem.onclick = () => switchTab(project.id);
                tabItem.innerHTML = `
                    <div class="tab-color" style="background-color: ${project.color || '#4facfe'}"></div>
                    <span class="tab-title">${project.name}</span>
                    <span class="tab-count" id="count-${project.id}">0</span>
                `;
                tabsHeader.appendChild(tabItem);
                // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–∞
                const tabContent = document.createElement('div');
                tabContent.className = `tab-content ${index === 0 ? 'active' : ''}`;
                tabContent.id = `project-${project.id}`;
                tabContent.innerHTML = `
                    <div class="project-content">
                        <div class="project-column">
                            <div class="project-section">
                                <h4>
                                    üìù –ó–∞–¥–∞—á–∏
                                    <span class="section-count" id="tasks-count-${project.id}">0</span>
                                    <a href="/dashboard/tasks.html?create=true&project_id=${project.id}" class="btn btn-small btn-primary" style="margin-left: auto;">
                                        <span>+</span>
                                        –î–æ–±–∞–≤–∏—Ç—å
                                    </a>
                                </h4>
                                <div id="tasks-container-${project.id}">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                        </div>
                        <div class="project-column">
                            <div class="project-section">
                                <h4>
                                    üìÖ –í—Å—Ç—Ä–µ—á–∏
                                    <span class="section-count" id="events-count-${project.id}">0</span>
                                </h4>
                                <div id="events-container-${project.id}">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                            <div class="project-section">
                                <h4>
                                    üõí –ü–æ–∫—É–ø–∫–∏
                                    <span class="section-count" id="shopping-count-${project.id}">0</span>
                                </h4>
                                <div id="shopping-container-${project.id}">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                            <div class="project-section">
                                <h4>
                                    üìÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç–∞—Ç—å–∏
                                    <span class="section-count" id="articles-count-${project.id}">0</span>
                                </h4>
                                <div id="articles-container-${project.id}">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                tabsContent.appendChild(tabContent);
            });
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
            if (projects.length > 0) {
                currentProjectId = projects[0].id;
                loadProjectData(currentProjectId);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤
        function switchTab(projectId) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —Ç–∞–±–æ–≤
            document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–∞–±—É
            document.querySelector(`[data-tab="project-${projectId}"]`).classList.add('active');
            document.getElementById(`project-${projectId}`).classList.add('active');
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
            if (currentProjectId !== projectId) {
                currentProjectId = projectId;
                loadProjectData(projectId);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞
        async function loadProjectData(projectId) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏
                await loadProjectTasks(projectId);
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å—Ç—Ä–µ—á–∏
                await loadProjectEvents(projectId);
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–∫—É–ø–∫–∏
                await loadProjectShopping(projectId);
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—å–∏ (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞)
                loadProjectArticles(projectId);
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                updateProjectCounts(projectId);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞:', error);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á –ø—Ä–æ–µ–∫—Ç–∞
        async function loadProjectTasks(projectId) {
            try {
                const response = await fetch(`/api/tasks?user_id=${currentUser.id}`);
                if (response.ok) {
                    const allTasks = await response.json();
                    const projectTasks = allTasks.filter(task => task.project_id === projectId);
                    renderProjectTasks(projectId, projectTasks);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', response.status);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–¥–∞—á –ø—Ä–æ–µ–∫—Ç–∞
        function renderProjectTasks(projectId, tasks) {
            const container = document.getElementById(`tasks-container-${projectId}`);
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">–ù–µ—Ç –∑–∞–¥–∞—á –≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ</p>';
                return;
            }
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
            const grouped = {
                overdue: [],
                today: [],
                tomorrow: [],
                later: [],
                noDate: []
            };
            tasks.forEach(task => {
                if (!task.due_date) {
                    grouped.noDate.push(task);
                } else {
                    const dueDate = new Date(task.due_date);
                    if (dueDate < today) {
                        grouped.overdue.push(task);
                    } else if (dueDate.toDateString() === today.toDateString()) {
                        grouped.today.push(task);
                    } else if (dueDate.toDateString() === tomorrow.toDateString()) {
                        grouped.tomorrow.push(task);
                    } else {
                        grouped.later.push(task);
                    }
                }
            });
            let html = '';
            // –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            if (grouped.overdue.length > 0) {
                html += '<div class="task-group overdue"><h5>‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</h5>';
                grouped.overdue.forEach(task => {
                    html += renderTaskItem(task);
                });
                html += '</div>';
            }
            // –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
            if (grouped.today.length > 0) {
                html += '<div class="task-group today"><h5>üî• –ù–∞ —Å–µ–≥–æ–¥–Ω—è</h5>';
                grouped.today.forEach(task => {
                    html += renderTaskItem(task);
                });
                html += '</div>';
            }
            // –ó–∞–¥–∞—á–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
            if (grouped.tomorrow.length > 0) {
                html += '<div class="task-group tomorrow"><h5>‚è∞ –ù–∞ –∑–∞–≤—Ç—Ä–∞</h5>';
                grouped.tomorrow.forEach(task => {
                    html += renderTaskItem(task);
                });
                html += '</div>';
            }
            // –ó–∞–¥–∞—á–∏ –Ω–∞ –ø–æ—Ç–æ–º
            if (grouped.later.length > 0) {
                html += '<div class="task-group later"><h5>üìÖ –ü–æ–∑–∂–µ</h5>';
                grouped.later.forEach(task => {
                    html += renderTaskItem(task);
                });
                html += '</div>';
            }
            // –ó–∞–¥–∞—á–∏ –±–µ–∑ –¥–∞—Ç—ã
            if (grouped.noDate.length > 0) {
                html += '<div class="task-group no-date"><h5>üìã –ë–µ–∑ –¥–∞—Ç—ã</h5>';
                grouped.noDate.forEach(task => {
                    html += renderTaskItem(task);
                });
                html += '</div>';
            }
            container.innerHTML = html;
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –∑–∞–¥–∞—á–∏
        function renderTaskItem(task) {
            const priorityClass = task.priority === 'high' ? 'high-priority' : 
                                  task.priority === 'medium' ? 'medium-priority' : 'low-priority';
            const completedClass = task.completed ? 'completed' : '';
            return `
                <div class="task-item ${priorityClass} ${completedClass}">
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})"></div>
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                        ${task.due_date ? `<div class="task-due-date">${formatDate(task.due_date)}</div>` : ''}
                    </div>
                </div>
            `;
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å—Ç—Ä–µ—á –ø—Ä–æ–µ–∫—Ç–∞
        async function loadProjectEvents(projectId) {
            try {
                const response = await fetch(`/api/events?user_id=${currentUser.id}`);
                if (response.ok) {
                    const allEvents = await response.json();
                    const projectEvents = allEvents.filter(event => event.project_id === projectId);
                    renderProjectEvents(projectId, projectEvents);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å—Ç—Ä–µ—á:', response.status);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å—Ç—Ä–µ—á:', error);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å—Ç—Ä–µ—á –ø—Ä–æ–µ–∫—Ç–∞
        function renderProjectEvents(projectId, events) {
            const container = document.getElementById(`events-container-${projectId}`);
            if (!events || events.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">–ù–µ—Ç –≤—Å—Ç—Ä–µ—á –≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ</p>';
                return;
            }
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å—Ç—Ä–µ—á–∏ –ø–æ –¥–∞—Ç–µ
            events.sort((a, b) => new Date(a.start_at) - new Date(b.start_at));
            let html = '';
            events.forEach(event => {
                html += `
                    <div class="event-item">
                        <div class="event-time">${formatDateTime(event.start_at)}</div>
                        <div class="event-title">${event.title}</div>
                        ${event.location ? `<div class="event-location">üìç ${event.location}</div>` : ''}
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞
        async function loadProjectShopping(projectId) {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º API shopping-by-lists –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–æ–µ–∫—Ç–∞—Ö
                const response = await fetch(`/api/shopping-by-lists?user_id=${currentUser.id}`);
                if (response.ok) {
                    const allShopping = await response.json();
                    console.log('–í—Å–µ –ø–æ–∫—É–ø–∫–∏:', allShopping);
                    console.log('–ò—â–µ–º –ø–æ–∫—É–ø–∫–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞:', projectId);
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–∫—É–ø–∫–∏ –ø–æ project_id
                    const projectShopping = [];
                    const processedItems = new Set();
                    
                    allShopping.forEach(item => {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –ø–æ–∫—É–ø–∫–∞ (–Ω–µ —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫) –∏ –æ–Ω–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –Ω—É–∂–Ω–æ–º—É –ø—Ä–æ–µ–∫—Ç—É
                        if (item.id && !processedItems.has(item.id) && item.project_id == projectId) {
                            projectShopping.push({
                                id: item.id,
                                name: item.name,
                                quantity: item.quantity || 1,
                                price: item.price,
                                completed: item.completed,
                                purchased: item.completed, // –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                                category: item.category,
                                list_name: item.list_name,
                                project_name: item.project_name,
                                url: item.url,
                                comment: item.comment
                            });
                            processedItems.add(item.id);
                        }
                    });
                    
                    console.log('–ü–æ–∫—É–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞:', projectShopping);
                    renderProjectShopping(projectId, projectShopping);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫:', response.status);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    const container = document.getElementById(`shopping-container-${projectId}`);
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫</p>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                const container = document.getElementById(`shopping-container-${projectId}`);
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫</p>';
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–∫—É–ø–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞
        function renderProjectShopping(projectId, shopping) {
            const container = document.getElementById(`shopping-container-${projectId}`);
            if (!shopping || shopping.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üõí</div>
                        <p>–ù–µ—Ç –ø–æ–∫—É–ø–æ–∫ –≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ</p>
                        <a href="/dashboard/shopping.html" class="btn btn-primary btn-sm" style="margin-top: 10px;">
                            –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫—É–ø–∫–∏
                        </a>
                    </div>
                `;
                return;
            }
            
            // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
            const activeShopping = shopping.filter(item => !item.completed);
            const completedShopping = shopping.filter(item => item.completed);
            
            let html = '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏
            if (activeShopping.length > 0) {
                activeShopping.forEach(item => {
                    html += `
                        <div class="shopping-item" data-item-id="${item.id}">
                            <div class="item-checkbox" onclick="toggleShoppingItem(${item.id})"></div>
                            <div class="item-content">
                                <div class="item-name">${escapeHtml(item.name)}</div>
                                <div class="item-details">
                                    <span class="item-quantity">${item.quantity || 1} —à—Ç.</span>
                                    ${item.price ? `<span class="item-price">${item.price}‚ÇΩ</span>` : ''}
                                    ${item.list_name ? `<span class="item-list">üìã ${escapeHtml(item.list_name)}</span>` : ''}
                                </div>
                                ${item.comment ? `<div class="item-comment">${escapeHtml(item.comment)}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if (completedShopping.length > 0) {
                if (activeShopping.length > 0) {
                    html += '<div class="items-divider">–ö—É–ø–ª–µ–Ω–æ</div>';
                }
                completedShopping.forEach(item => {
                    html += `
                        <div class="shopping-item completed" data-item-id="${item.id}">
                            <div class="item-checkbox checked" onclick="toggleShoppingItem(${item.id})"></div>
                            <div class="item-content">
                                <div class="item-name">${escapeHtml(item.name)}</div>
                                <div class="item-details">
                                    <span class="item-quantity">${item.quantity || 1} —à—Ç.</span>
                                    ${item.price ? `<span class="item-price">${item.price}‚ÇΩ</span>` : ''}
                                    ${item.list_name ? `<span class="item-list">üìã ${escapeHtml(item.list_name)}</span>` : ''}
                                </div>
                                ${item.comment ? `<div class="item-comment">${escapeHtml(item.comment)}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞ (–∑–∞–≥–ª—É—à–∫–∞)
        function loadProjectArticles(projectId) {
            const container = document.getElementById(`articles-container-${projectId}`);
            container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">–°—Ç–∞—Ç—å–∏ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã</p>';
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
        function updateProjectCounts(projectId) {
            const tasksCount = document.getElementById(`tasks-container-${projectId}`).querySelectorAll('.task-item').length;
            const eventsCount = document.getElementById(`events-container-${projectId}`).querySelectorAll('.event-item').length;
            const shoppingCount = document.getElementById(`shopping-container-${projectId}`).querySelectorAll('.shopping-item').length;
            document.getElementById(`tasks-count-${projectId}`).textContent = tasksCount;
            document.getElementById(`events-count-${projectId}`).textContent = eventsCount;
            document.getElementById(`shopping-count-${projectId}`).textContent = shoppingCount;
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫ –≤ —Ç–∞–±–µ
            const totalCount = tasksCount + eventsCount + shoppingCount;
            document.getElementById(`count-${projectId}`).textContent = totalCount;
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        function showEmptyState() {
            const tabsHeader = document.getElementById('tabs-header');
            const tabsContent = document.getElementById('tabs-content');
            tabsHeader.innerHTML = `
                <div class="tab-item empty-tab">
                    <div class="tab-color" style="background-color: #95a5a6;"></div>
                    <span class="tab-title">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</span>
                </div>
            `;
            tabsContent.innerHTML = `
                <div class="tab-content active">
                    <div class="empty-state">
                        <div class="empty-icon">üìÅ</div>
                        <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</h3>
                        <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –∑–∞–¥–∞—á–∞–º–∏, –≤—Å—Ç—Ä–µ—á–∞–º–∏ –∏ –ø–æ–∫—É–ø–∫–∞–º–∏</p>
                        <a href="/dashboard/create-project.html" class="btn btn-primary">
                            <span>+</span>
                            –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
                        </a>
                    </div>
                </div>
            `;
        }
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
        async function toggleTask(taskId) {
            try {
                // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç –∑–∞–¥–∞—á–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                const checkbox = taskElement?.querySelector('.task-checkbox');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                if (checkbox) {
                    checkbox.style.transform = 'scale(0.85)';
                    checkbox.style.transition = 'transform 0.15s ease';
                    
                    setTimeout(() => {
                        checkbox.style.transform = 'scale(1)';
                    }, 150);
                }
                
                const response = await fetch(`/api/tasks/${taskId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
                    if (checkbox) {
                        if (result.completed) {
                            checkbox.classList.add('checked');
                            taskElement?.classList.add('completed');
                        } else {
                            checkbox.classList.remove('checked');
                            taskElement?.classList.remove('completed');
                        }
                    }
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
                    setTimeout(() => {
                        loadProjectData(currentProjectId);
                    }, 300);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∑–∞–¥–∞—á–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏
        async function toggleShoppingItem(itemId) {
            try {
                // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ–∫—É–ø–∫–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
                const checkbox = itemElement?.querySelector('.item-checkbox');
                
                // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
                if (checkbox) {
                    checkbox.style.opacity = '0.5';
                }

                const response = await fetch(`/api/shopping/${itemId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id
                    })
                });
                
                if (response.ok) {
                    // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI
                    if (itemElement && checkbox) {
                        const isCompleted = checkbox.classList.contains('checked');
                        
                        if (isCompleted) {
                            // –°–Ω–∏–º–∞–µ–º –æ—Ç–º–µ—Ç–∫—É
                            checkbox.classList.remove('checked');
                            itemElement.classList.remove('completed');
                        } else {
                            // –°—Ç–∞–≤–∏–º –æ—Ç–º–µ—Ç–∫—É
                            checkbox.classList.add('checked');
                            itemElement.classList.add('completed');
                        }
                        
                        checkbox.style.opacity = '1';
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                    updateProjectCounts(currentProjectId);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    const isNowCompleted = checkbox?.classList.contains('checked');
                    showNotification(
                        isNowCompleted ? '–¢–æ–≤–∞—Ä –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –∫—É–ø–ª–µ–Ω–Ω—ã–π!' : '–¢–æ–≤–∞—Ä –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫',
                        'success'
                    );
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏:', response.status);
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    if (checkbox) {
                        checkbox.style.opacity = '1';
                    }
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–∫—É–ø–∫–∏', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏:', error);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const checkbox = document.querySelector(`[data-item-id="${itemId}"] .item-checkbox`);
                if (checkbox) {
                    checkbox.style.opacity = '1';
                }
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–∫—É–ø–∫–∏', 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'info') {
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#6366f1'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                font-weight: 500;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;

            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);

            // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU');
        }
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        Auth.initAuthenticatedPage();
        // –¢–∞–∫–∂–µ –ø–æ–ø—Ä–æ–±—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM –≥–æ—Ç–æ–≤, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É');
            setTimeout(initPage, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è Auth
        });
    </script>
</body>
</html>
