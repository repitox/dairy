<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–µ–∫—Ç—ã - Dashboard</title>
        <link rel="preload" href="/api/navigation?category=main" as="fetch" crossorigin>
    <link rel="stylesheet" href="ui-components.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
        <!-- API –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav id="navigation-container"></nav>
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="main-content">
        <div class="unified-page-container">
            <div class="unified-page-header">
                <h1 class="unified-page-title">
                    <span class="unified-page-title-icon">üìÅ</span>
                    <span class="unified-page-title-text">–ü—Ä–æ–µ–∫—Ç—ã</span>
                </h1>
                <div class="unified-action-group">
                    <a href="/dashboard/create-project.html" class="unified-action-btn">
                        <span class="unified-action-btn-icon">+</span>
                        –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
                    </a>
                </div>
            </div>
            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å —Ç–∞–±–∞–º–∏ -->
            <div class="content-wrapper">
                <div class="tabs-container" id="projects-tabs">
                    <div class="tabs-header" id="tabs-header">
                        <!-- –¢–∞–±—ã –ø—Ä–æ–µ–∫—Ç–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                    <div class="tabs-content" id="tabs-content">
                        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–æ–≤ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>
        </div>
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤ -->
    <script src="auth.js"></script>
        <script src="navigation-api-loader.js"></script>
<script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = null;
        let projects = [];
        let currentProjectId = null;
        // Callback –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.onUserLoaded = function(user) {
            currentUser = user;
            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ onUserLoaded:', user);
            updateUserInfo(user);
            loadProjects();
        };
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —Å fallback
        function updateUserInfo(user) {
            if (window.NavigationComponent && window.NavigationComponent.updateUserInfo) {
                window.NavigationComponent.updateUserInfo(user);
            } else {
                // Fallback –¥–ª—è —Å–ª—É—á–∞—è, –µ—Å–ª–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
                console.log('NavigationComponent –Ω–µ –≥–æ—Ç–æ–≤, –∂–¥–µ–º...');
                setTimeout(() => updateUserInfo(user), 100);
            }
        }
        // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç—ã —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å
        function initPage() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–µ–∫—Ç–æ–≤...');
            console.log('localStorage —Å–æ–¥–µ—Ä–∂–∏—Ç:', localStorage);
            console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–ª—é—á–∏ –≤ localStorage:', Object.keys(localStorage));
            const user = Auth.getCurrentUser();
            if (user) {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ Auth:', user);
                currentUser = {
                    user_id: user.id || user.user_id,
                    first_name: user.first_name,
                    last_name: user.last_name,
                    username: user.username
                };
                loadProjects();
            } else {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ Auth, –ø–æ–ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å...');
                // –ü–æ–ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–ø—Ä—è–º—É—é
                loadUserDirectly();
            }
        }
        // –ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserDirectly() {
            try {
                // –ü–æ–ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ localStorage
                const userDataString = localStorage.getItem('telegram_user');
                if (userDataString) {
                    const userData = JSON.parse(userDataString);
                    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –≤ localStorage:', userData);
                    // –ü—Ä–∏–≤–æ–¥–∏–º –∫ –Ω—É–∂–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É (–≤ auth.js –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è id, –∞ –≤ API user_id)
                    currentUser = {
                        user_id: userData.id || userData.user_id,
                        first_name: userData.first_name,
                        last_name: userData.last_name,
                        username: userData.username
                    };
                    loadProjects();
                    return;
                }
                // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –∫—É–∫–∏
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'telegram_user_id') {
                        console.log('–ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∫—É–∫–∏:', value);
                        currentUser = { user_id: parseInt(value) };
                        loadProjects();
                        return;
                    }
                }
                // –ï—Å–ª–∏ –Ω–µ—Ç –≤ localStorage –∏ –∫—É–∫–∏, –ø–æ–ø—Ä–æ–±—É–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                currentUser = { user_id: 123456789 };
                loadProjects();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                showEmptyState();
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤
        async function loadProjects() {
            if (!currentUser) {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
                showEmptyState();
                return;
            }
            try {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', currentUser.user_id);
                const response = await fetch(`/api/user-projects?user_id=${currentUser.user_id}`);
                if (response.ok) {
                    projects = await response.json();
                    console.log('–ü—Ä–æ–µ–∫—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', projects);
                    renderTabs();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:', response.status);
                    showEmptyState();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:', error);
                showEmptyState();
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–æ–≤
        function renderTabs() {
            console.log('–û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–∞–±–æ–≤, –ø—Ä–æ–µ–∫—Ç—ã:', projects);
            const tabsHeader = document.getElementById('tabs-header');
            const tabsContent = document.getElementById('tabs-content');
            if (!projects || projects.length === 0) {
                console.log('–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                showEmptyState();
                return;
            }
            console.log('–û—Ç—Ä–∏—Å–æ–≤–∫–∞', projects.length, '–ø—Ä–æ–µ–∫—Ç–æ–≤');
            // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            tabsHeader.innerHTML = '';
            tabsContent.innerHTML = '';
            // –°–æ–∑–¥–∞–µ–º —Ç–∞–±—ã
            projects.forEach((project, index) => {
                // –°–æ–∑–¥–∞–µ–º —Ç–∞–±
                const tabItem = document.createElement('div');
                tabItem.className = `tab-item ${index === 0 ? 'active' : ''}`;
                tabItem.setAttribute('data-tab', `project-${project.id}`);
                tabItem.onclick = () => switchTab(project.id);
                tabItem.innerHTML = `
                    <div class="tab-color" style="background-color: ${project.color || '#4facfe'}"></div>
                    <span class="tab-title">${project.name}</span>
                    <span class="tab-count" id="count-${project.id}">0</span>
                `;
                tabsHeader.appendChild(tabItem);
                // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–∞
                const tabContent = document.createElement('div');
                tabContent.className = `tab-content ${index === 0 ? 'active' : ''}`;
                tabContent.id = `project-${project.id}`;
                tabContent.innerHTML = `
                    <div class="project-content">
                        <div class="project-column">
                            <div class="project-section">
                                <h4>
                                    üìù –ó–∞–¥–∞—á–∏
                                    <span class="section-count" id="tasks-count-${project.id}">0</span>
                                    <a href="/dashboard/tasks.html?create=true&project_id=${project.id}" class="btn btn-small btn-primary" style="margin-left: auto;">
                                        <span>+</span>
                                        –î–æ–±–∞–≤–∏—Ç—å
                                    </a>
                                </h4>
                                <div id="tasks-container-${project.id}">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                        </div>
                        <div class="project-column">
                            <div class="project-section">
                                <h4>
                                    üìÖ –í—Å—Ç—Ä–µ—á–∏
                                    <span class="section-count" id="events-count-${project.id}">0</span>
                                </h4>
                                <div id="events-container-${project.id}">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                            <div class="project-section">
                                <h4>
                                    üõí –ü–æ–∫—É–ø–∫–∏
                                    <span class="section-count" id="shopping-count-${project.id}">0</span>
                                </h4>
                                <div id="shopping-container-${project.id}">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                            <div class="project-section">
                                <h4>
                                    üìÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç–∞—Ç—å–∏
                                    <span class="section-count" id="articles-count-${project.id}">0</span>
                                </h4>
                                <div id="articles-container-${project.id}">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                tabsContent.appendChild(tabContent);
            });
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
            if (projects.length > 0) {
                currentProjectId = projects[0].id;
                loadProjectData(currentProjectId);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤
        function switchTab(projectId) {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —Ç–∞–±–æ–≤
            document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–∞–±—É
            document.querySelector(`[data-tab="project-${projectId}"]`).classList.add('active');
            document.getElementById(`project-${projectId}`).classList.add('active');
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
            if (currentProjectId !== projectId) {
                currentProjectId = projectId;
                loadProjectData(projectId);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞
        async function loadProjectData(projectId) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏
                await loadProjectTasks(projectId);
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å—Ç—Ä–µ—á–∏
                await loadProjectEvents(projectId);
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–∫—É–ø–∫–∏
                await loadProjectShopping(projectId);
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—å–∏ (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞)
                loadProjectArticles(projectId);
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                updateProjectCounts(projectId);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞:', error);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á –ø—Ä–æ–µ–∫—Ç–∞
        async function loadProjectTasks(projectId) {
            try {
                const response = await fetch(`/api/tasks?user_id=${currentUser.user_id}`);
                if (response.ok) {
                    const allTasks = await response.json();
                    const projectTasks = allTasks.filter(task => task.project_id === projectId);
                    renderProjectTasks(projectId, projectTasks);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', response.status);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á:', error);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–¥–∞—á –ø—Ä–æ–µ–∫—Ç–∞
        function renderProjectTasks(projectId, tasks) {
            const container = document.getElementById(`tasks-container-${projectId}`);
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">–ù–µ—Ç –∑–∞–¥–∞—á –≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ</p>';
                return;
            }
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
            const grouped = {
                overdue: [],
                today: [],
                tomorrow: [],
                later: [],
                noDate: []
            };
            tasks.forEach(task => {
                if (!task.due_date) {
                    grouped.noDate.push(task);
                } else {
                    const dueDate = new Date(task.due_date);
                    if (dueDate < today) {
                        grouped.overdue.push(task);
                    } else if (dueDate.toDateString() === today.toDateString()) {
                        grouped.today.push(task);
                    } else if (dueDate.toDateString() === tomorrow.toDateString()) {
                        grouped.tomorrow.push(task);
                    } else {
                        grouped.later.push(task);
                    }
                }
            });
            let html = '';
            // –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
            if (grouped.overdue.length > 0) {
                html += '<div class="task-group overdue"><h5>‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ</h5>';
                grouped.overdue.forEach(task => {
                    html += renderTaskItem(task);
                });
                html += '</div>';
            }
            // –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
            if (grouped.today.length > 0) {
                html += '<div class="task-group today"><h5>üî• –ù–∞ —Å–µ–≥–æ–¥–Ω—è</h5>';
                grouped.today.forEach(task => {
                    html += renderTaskItem(task);
                });
                html += '</div>';
            }
            // –ó–∞–¥–∞—á–∏ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
            if (grouped.tomorrow.length > 0) {
                html += '<div class="task-group tomorrow"><h5>‚è∞ –ù–∞ –∑–∞–≤—Ç—Ä–∞</h5>';
                grouped.tomorrow.forEach(task => {
                    html += renderTaskItem(task);
                });
                html += '</div>';
            }
            // –ó–∞–¥–∞—á–∏ –Ω–∞ –ø–æ—Ç–æ–º
            if (grouped.later.length > 0) {
                html += '<div class="task-group later"><h5>üìÖ –ü–æ–∑–∂–µ</h5>';
                grouped.later.forEach(task => {
                    html += renderTaskItem(task);
                });
                html += '</div>';
            }
            // –ó–∞–¥–∞—á–∏ –±–µ–∑ –¥–∞—Ç—ã
            if (grouped.noDate.length > 0) {
                html += '<div class="task-group no-date"><h5>üìã –ë–µ–∑ –¥–∞—Ç—ã</h5>';
                grouped.noDate.forEach(task => {
                    html += renderTaskItem(task);
                });
                html += '</div>';
            }
            container.innerHTML = html;
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –∑–∞–¥–∞—á–∏
        function renderTaskItem(task) {
            const priorityClass = task.priority === 'high' ? 'high-priority' : 
                                  task.priority === 'medium' ? 'medium-priority' : 'low-priority';
            const completedClass = task.completed ? 'completed' : '';
            return `
                <div class="task-item ${priorityClass} ${completedClass}">
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})"></div>
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                        ${task.due_date ? `<div class="task-due-date">${formatDate(task.due_date)}</div>` : ''}
                    </div>
                </div>
            `;
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å—Ç—Ä–µ—á –ø—Ä–æ–µ–∫—Ç–∞
        async function loadProjectEvents(projectId) {
            try {
                const response = await fetch(`/api/events?user_id=${currentUser.user_id}`);
                if (response.ok) {
                    const allEvents = await response.json();
                    const projectEvents = allEvents.filter(event => event.project_id === projectId);
                    renderProjectEvents(projectId, projectEvents);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å—Ç—Ä–µ—á:', response.status);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å—Ç—Ä–µ—á:', error);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å—Ç—Ä–µ—á –ø—Ä–æ–µ–∫—Ç–∞
        function renderProjectEvents(projectId, events) {
            const container = document.getElementById(`events-container-${projectId}`);
            if (!events || events.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">–ù–µ—Ç –≤—Å—Ç—Ä–µ—á –≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ</p>';
                return;
            }
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å—Ç—Ä–µ—á–∏ –ø–æ –¥–∞—Ç–µ
            events.sort((a, b) => new Date(a.start_at) - new Date(b.start_at));
            let html = '';
            events.forEach(event => {
                html += `
                    <div class="event-item">
                        <div class="event-time">${formatDateTime(event.start_at)}</div>
                        <div class="event-title">${event.title}</div>
                        ${event.location ? `<div class="event-location">üìç ${event.location}</div>` : ''}
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞
        async function loadProjectShopping(projectId) {
            try {
                const response = await fetch(`/api/shopping-by-lists?user_id=${currentUser.user_id}`);
                if (response.ok) {
                    const allShopping = await response.json();
                    const projectShopping = allShopping.filter(item => item.project_id === projectId);
                    renderProjectShopping(projectId, projectShopping);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫:', response.status);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫—É–ø–æ–∫:', error);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–∫—É–ø–æ–∫ –ø—Ä–æ–µ–∫—Ç–∞
        function renderProjectShopping(projectId, shopping) {
            const container = document.getElementById(`shopping-container-${projectId}`);
            if (!shopping || shopping.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">–ù–µ—Ç –ø–æ–∫—É–ø–æ–∫ –≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ</p>';
                return;
            }
            let html = '';
            shopping.forEach(item => {
                html += `
                    <div class="shopping-item ${item.purchased ? 'completed' : ''}">
                        <div class="item-checkbox ${item.purchased ? 'checked' : ''}" onclick="toggleShoppingItem(${item.id})"></div>
                        <div class="item-content">
                            <div class="item-name">${item.name}</div>
                            <div class="item-details">
                                <span class="item-quantity">${item.quantity} —à—Ç.</span>
                                ${item.price ? `<span class="item-price">${item.price}‚ÇΩ</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞ (–∑–∞–≥–ª—É—à–∫–∞)
        function loadProjectArticles(projectId) {
            const container = document.getElementById(`articles-container-${projectId}`);
            container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">–°—Ç–∞—Ç—å–∏ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã</p>';
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
        function updateProjectCounts(projectId) {
            const tasksCount = document.getElementById(`tasks-container-${projectId}`).querySelectorAll('.task-item').length;
            const eventsCount = document.getElementById(`events-container-${projectId}`).querySelectorAll('.event-item').length;
            const shoppingCount = document.getElementById(`shopping-container-${projectId}`).querySelectorAll('.shopping-item').length;
            document.getElementById(`tasks-count-${projectId}`).textContent = tasksCount;
            document.getElementById(`events-count-${projectId}`).textContent = eventsCount;
            document.getElementById(`shopping-count-${projectId}`).textContent = shoppingCount;
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫ –≤ —Ç–∞–±–µ
            const totalCount = tasksCount + eventsCount + shoppingCount;
            document.getElementById(`count-${projectId}`).textContent = totalCount;
        }
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        function showEmptyState() {
            const tabsHeader = document.getElementById('tabs-header');
            const tabsContent = document.getElementById('tabs-content');
            tabsHeader.innerHTML = `
                <div class="tab-item empty-tab">
                    <div class="tab-color" style="background-color: #95a5a6;"></div>
                    <span class="tab-title">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</span>
                </div>
            `;
            tabsContent.innerHTML = `
                <div class="tab-content active">
                    <div class="empty-state">
                        <div class="empty-icon">üìÅ</div>
                        <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</h3>
                        <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –∑–∞–¥–∞—á–∞–º–∏, –≤—Å—Ç—Ä–µ—á–∞–º–∏ –∏ –ø–æ–∫—É–ø–∫–∞–º–∏</p>
                        <a href="/dashboard/create-project.html" class="btn btn-primary">
                            <span>+</span>
                            –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
                        </a>
                    </div>
                </div>
            `;
        }
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
        async function toggleTask(taskId) {
            try {
                const response = await fetch(`/api/tasks/${taskId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.user_id
                    })
                });
                if (response.ok) {
                    loadProjectData(currentProjectId); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∑–∞–¥–∞—á–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
            }
        }
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏
        async function toggleShoppingItem(itemId) {
            try {
                const response = await fetch(`/api/shopping/${itemId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.user_id
                    })
                });
                if (response.ok) {
                    loadProjectData(currentProjectId); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏:', error);
            }
        }
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU');
        }
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU');
        }
        // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        document.addEventListener('navigationLoaded', function() {
            console.log('–ù–∞–≤–∏–≥–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            const user = Auth.getCurrentUser();
            if (user) {
                updateUserInfo(user);
                if (!currentUser) {
                    currentUser = user;
                    loadProjects();
                }
            }
        });
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        Auth.initAuthenticatedPage();
        // –¢–∞–∫–∂–µ –ø–æ–ø—Ä–æ–±—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM –≥–æ—Ç–æ–≤, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É');
            setTimeout(initPage, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è Auth
        });
    </script>
</body>
</html>