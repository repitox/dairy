<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ - Dashboard</title>
        <link rel="preload" href="/api/navigation?category=main" as="fetch" crossorigin>
    <link rel="stylesheet" href="dashboard-styles.css">
        <link rel="stylesheet" href="navigation-api-simple.css">
<style>
        .settings-container {
            max-width: 1200px;
        }
        .settings-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .settings-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-primary);
        }
        .settings-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .settings-description {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0;
        }
        .settings-content {
            padding: 20px;
        }
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-light);
        }
        .setting-item:last-child {
            border-bottom: none;
        }
        .setting-info {
            flex: 1;
        }
        .setting-label {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0 0 3px 0;
        }
        .setting-hint {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 0;
        }
        .setting-control {
            margin-left: 20px;
        }
        .save-button {
            background: var(--tg-blue);
            color: var(--text-inverse);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all var(--transition-fast);
            margin-top: 20px;
        }
        .save-button:hover {
            background: var(--tg-blue-dark);
            transform: translateY(-1px);
        }
        .save-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .notification {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .notification.success {
            background: rgba(77, 255, 136, 0.1);
            color: var(--success);
            border: 1px solid rgba(77, 255, 136, 0.3);
        }
        .notification.error {
            background: rgba(255, 107, 122, 0.1);
            color: var(--error);
            border: 1px solid rgba(255, 107, 122, 0.3);
        }
        .user-info-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .user-stat {
            text-align: center;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-light);
        }
        .user-stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-blue);
            margin: 0;
        }
        .user-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 5px 0 0 0;
        }
        .danger-zone {
            border-color: var(--error);
        }
        .danger-zone .settings-header {
            background: rgba(255, 107, 122, 0.1);
            border-bottom-color: var(--error);
        }
        .danger-button {
            background: var(--error);
            color: var(--text-inverse);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all var(--transition-fast);
        }
        .danger-button:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
        <!-- API –Ω–∞–≤–∏–≥–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
<div class="settings-container">
        <div id="notification" class="notification"></div>
        <!-- –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å -->
        <div class="settings-section">
            <div class="settings-header">
                <h3 class="settings-title">
                    <span>üåç</span>
                    –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å
                </h3>
                <p class="settings-description">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–∞—Ç</p>
            </div>
            <div class="settings-content">
                <div class="setting-item">
                    <div class="setting-info">
                        <p class="setting-label">–¢–µ–∫—É—â–∏–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å</p>
                        <p class="setting-hint" id="current-timezone">UTC+0</p>
                    </div>
                    <div class="setting-control">
                        <button class="save-button" onclick="autoDetectTimezone()" style="margin: 0; padding: 8px 16px; font-size: 14px;">
                            üåç –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
                        </button>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <p class="setting-label">–í—ã–±–æ—Ä —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞</p>
                        <p class="setting-hint">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏</p>
                    </div>
                    <div class="setting-control">
                        <select id="timezone-select" style="padding: 8px 12px; border: 1px solid var(--border-medium); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px;">
                            <option value="-12">UTC-12</option>
                            <option value="-11">UTC-11</option>
                            <option value="-10">UTC-10</option>
                            <option value="-9">UTC-9</option>
                            <option value="-8">UTC-8</option>
                            <option value="-7">UTC-7</option>
                            <option value="-6">UTC-6</option>
                            <option value="-5">UTC-5</option>
                            <option value="-4">UTC-4</option>
                            <option value="-3">UTC-3</option>
                            <option value="-2">UTC-2</option>
                            <option value="-1">UTC-1</option>
                            <option value="0">UTC+0</option>
                            <option value="1">UTC+1</option>
                            <option value="2">UTC+2</option>
                            <option value="3">UTC+3 (–ú–æ—Å–∫–≤–∞)</option>
                            <option value="4">UTC+4</option>
                            <option value="5">UTC+5</option>
                            <option value="6">UTC+6</option>
                            <option value="7">UTC+7</option>
                            <option value="8">UTC+8</option>
                            <option value="9">UTC+9</option>
                            <option value="10">UTC+10</option>
                            <option value="11">UTC+11</option>
                            <option value="12">UTC+12</option>
                        </select>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <p class="setting-label">–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è</p>
                        <p class="setting-hint" id="current-time">--:--:--</p>
                    </div>
                    <div class="setting-control">
                        <span style="font-size: 12px; color: var(--text-secondary);">–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
        <div class="settings-section">
            <div class="settings-header">
                <h3 class="settings-title">
                    <span>üë§</span>
                    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                </h3>
                <p class="settings-description">–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –¥–∞–Ω–Ω—ã–µ</p>
            </div>
            <div class="settings-content">
                <div class="user-info-section">
                    <div class="user-stat">
                        <p class="user-stat-number" id="tasks-total">0</p>
                        <p class="user-stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</p>
                    </div>
                    <div class="user-stat">
                        <p class="user-stat-number" id="tasks-completed">0</p>
                        <p class="user-stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</p>
                    </div>
                    <div class="user-stat">
                        <p class="user-stat-number" id="events-total">0</p>
                        <p class="user-stat-label">–í—Å—Ç—Ä–µ—á</p>
                    </div>
                    <div class="user-stat">
                        <p class="user-stat-number" id="shopping-total">0</p>
                        <p class="user-stat-label">–ü–æ–∫—É–ø–æ–∫</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div class="settings-section">
            <div class="settings-header">
                <h3 class="settings-title">
                    <span>üîî</span>
                    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                </h3>
                <p class="settings-description">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π</p>
            </div>
            <div class="settings-content">
                <div class="setting-item">
                    <div class="setting-info">
                        <p class="setting-label">Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</p>
                        <p class="setting-hint">–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ email</p>
                    </div>
                    <div class="setting-control">
                        <label class="switch">
                            <input type="checkbox" id="email-notifications">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <p class="setting-label">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –∑–∞–¥–∞—á–∞—Ö</p>
                        <p class="setting-hint">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–∏–±–ª–∏–∂–∞—é—â–∏—Ö—Å—è –¥–µ–¥–ª–∞–π–Ω–∞—Ö</p>
                    </div>
                    <div class="setting-control">
                        <label class="switch">
                            <input type="checkbox" id="task-reminders">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <!-- –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞ -->
        <div class="settings-section danger-zone">
            <div class="settings-header">
                <h3 class="settings-title">
                    <span>‚ö†Ô∏è</span>
                    –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞
                </h3>
                <p class="settings-description">–ù–µ–æ–±—Ä–∞—Ç–∏–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏</p>
            </div>
            <div class="settings-content">
                <div class="setting-item">
                    <div class="setting-info">
                        <p class="setting-label">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</p>
                        <p class="setting-hint">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏, –≤—Å—Ç—Ä–µ—á–∏ –∏ –ø–æ–∫—É–ø–∫–∏</p>
                    </div>
                    <div class="setting-control">
                        <button class="danger-button" onclick="clearAllData()">
                            –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <button class="save-button" id="save-settings" onclick="saveSettings()">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        </button>
    </div>
    <script src="auth.js"></script>
        <script src="navigation-api-loader.js"></script>
<script src="navigation.js"></script>
    <script src="datetime-utils.js?v=5"></script>
    <script>
        // Callback –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.onUserLoaded = function(user) {
            loadSettings();
            loadUserStats();
            setupEventListeners(); // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            initTimezoneSettings(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
        };
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        Auth.initAuthenticatedPage();
        let currentSettings = {
            theme: 'auto',
            emailNotifications: false,
            taskReminders: true
        };
        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        async function loadSettings() {
            try {
                const user = Auth.getCurrentUser();
                if (!user) {
                    console.error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫');
                    return;
                }
                console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', user.id);
                const response = await fetch(`/api/settings?user_id=${user.id}`);
                if (response.ok) {
                    const settings = await response.json();
                    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', settings);
                    currentSettings = { ...currentSettings, ...settings };
                    applySettings();
                } else {
                    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ');
                    // –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ (–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                applySettings(); // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            }
        }
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
        function applySettings() {
            console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:', currentSettings);
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É —á–µ—Ä–µ–∑ ThemeManager (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏)
            const applyTheme = () => {
                if (window.setTheme) {
                    window.setTheme(currentSettings.theme);
                    console.log(`‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ —Ç–µ–º–∞: ${currentSettings.theme}`);
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä —Ç–µ–º—ã –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã
                    setTimeout(() => {
                        updateThemeSelector();
                    }, 50);
                } else {
                    console.log('‚è≥ ThemeManager –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤, –ø–æ–≤—Ç–æ—Ä—è–µ–º —á–µ—Ä–µ–∑ 100–º—Å');
                    setTimeout(applyTheme, 100);
                }
            };
            applyTheme();
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            document.getElementById('email-notifications').checked = currentSettings.emailNotifications;
            document.getElementById('task-reminders').checked = currentSettings.taskReminders;
        }
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —Ç–µ–º—ã
        function updateThemeSelector() {
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
                console.log(`üîÑ –£–±—Ä–∞–ª–∏ active —É –∫–Ω–æ–ø–∫–∏: ${option.dataset.theme}`);
                if (option.dataset.theme === currentSettings.theme) {
                    option.classList.add('active');
                    console.log(`‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ —Ç–µ–º—ã: ${currentSettings.theme}`);
                }
            });
        }
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        async function saveSettings() {
            try {
                const user = Auth.getCurrentUser();
                if (!user) {
                    console.error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                // –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                const settings = {
                    user_id: user.id,
                    email_notifications: document.getElementById('email-notifications').checked,
                    task_reminders: document.getElementById('task-reminders').checked
                };
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –æ—Ç–¥–µ–ª—å–Ω–æ
                await saveTimezone();
                console.log('–°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:', settings);
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                if (response.ok) {
                    const result = await response.json();
                    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', result);
                    showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
                    currentSettings = {
                        emailNotifications: settings.email_notifications,
                        taskReminders: settings.task_reminders
                    };
                } else {
                    const errorText = await response.text();
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status, errorText);
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${response.status}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
            }
        }
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserStats() {
            try {
                const user = Auth.getCurrentUser();
                if (!user) return;
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
                const [tasksResponse, eventsResponse, shoppingResponse] = await Promise.all([
                    fetch(`/api/tasks?user_id=${user.id}`),
                    fetch(`/api/events?user_id=${user.id}`),
                    fetch(`/api/shopping?user_id=${user.id}`)
                ]);
                if (tasksResponse.ok) {
                    const tasks = await tasksResponse.json();
                    document.getElementById('tasks-total').textContent = tasks.length;
                    document.getElementById('tasks-completed').textContent = 
                        tasks.filter(task => task.completed).length;
                }
                if (eventsResponse.ok) {
                    const events = await eventsResponse.json();
                    document.getElementById('events-total').textContent = events.length;
                }
                if (shoppingResponse.ok) {
                    const shopping = await shoppingResponse.json();
                    document.getElementById('shopping-total').textContent = shopping.length;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }
        // –§—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            console.log('üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π...');
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ç–µ–º—ã
            const themeOptions = document.querySelectorAll('.theme-option');
            console.log(`üé® –ù–∞–π–¥–µ–Ω–æ –∫–Ω–æ–ø–æ–∫ —Ç–µ–º: ${themeOptions.length}`);
            if (themeOptions.length === 0) {
                console.log('‚è≥ –ö–Ω–æ–ø–∫–∏ —Ç–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø–æ–≤—Ç–æ—Ä—è–µ–º —á–µ—Ä–µ–∑ 100–º—Å...');
                setTimeout(setupEventListeners, 100);
                return;
            }
            themeOptions.forEach(option => {
                console.log(`üìù –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–µ–º—ã: ${option.dataset.theme}`);
                option.addEventListener('click', async () => {
                    console.log(`üé® –ö–ª–∏–∫ –ø–æ —Ç–µ–º–µ: ${option.dataset.theme}`);
                    console.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è:`, currentSettings);
                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    currentSettings.theme = option.dataset.theme;
                    console.log(`üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:`, currentSettings);
                    // –û–±–Ω–æ–≤–ª—è–µ–º active –∫–ª–∞—Å—Å—ã
                    updateThemeSelector();
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É —á–µ—Ä–µ–∑ ThemeManager
                    const applyTheme = () => {
                        if (window.setTheme) {
                            window.setTheme(currentSettings.theme);
                            console.log(`‚úÖ –¢–µ–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞: ${currentSettings.theme}`);
                        } else {
                            console.log('‚è≥ ThemeManager –Ω–µ –≥–æ—Ç–æ–≤, –ø–æ–≤—Ç–æ—Ä—è–µ–º...');
                            setTimeout(applyTheme, 100);
                        }
                    };
                    applyTheme();
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–º—ã
                    console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...');
                    await saveSettings();
                });
            });
            console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
        }
        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        async function clearAllData() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }
            try {
                const user = Auth.getCurrentUser();
                if (!user) return;
                const response = await fetch('/api/clear-all-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user_id: user.id })
                });
                if (response.ok) {
                    showNotification('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã', 'success');
                    loadUserStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }
        // ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ß–ê–°–û–í–´–ú–ò –ü–û–Ø–°–ê–ú–ò =====
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DateTimeUtils –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
        async function initTimezoneSettings() {
            try {
                if (!window.DateTimeUtils) {
                    console.error('DateTimeUtils –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                    return;
                }
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º DateTimeUtils
                await window.DateTimeUtils.init();
                console.log('DateTimeUtils –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
                await loadTimezoneSettings();
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞:', error);
            }
        }
        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
        async function loadTimezoneSettings() {
            try {
                let userTimezone;
                if (typeof window.DateTimeUtils.getUserTimezone === 'function') {
                    userTimezone = window.DateTimeUtils.getUserTimezone();
                } else {
                    userTimezone = window.DateTimeUtils.userTimezone !== null ? window.DateTimeUtils.userTimezone : 0;
                }
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å:', userTimezone);
                document.getElementById('current-timezone').textContent = `UTC${userTimezone >= 0 ? '+' : ''}${userTimezone}`;
                document.getElementById('timezone-select').value = userTimezone;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞:', error);
            }
        }
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        function updateCurrentTime() {
            if (!window.DateTimeUtils) {
                return;
            }
            let userTimezone;
            if (typeof window.DateTimeUtils.getUserTimezone === 'function') {
                userTimezone = window.DateTimeUtils.getUserTimezone();
            } else {
                userTimezone = window.DateTimeUtils.userTimezone !== null ? window.DateTimeUtils.userTimezone : 0;
            }
            // –ü–æ–ª—É—á–∞–µ–º UTC –≤—Ä–µ–º—è
            const now = new Date();
            const utcTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60 * 1000));
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –∫ UTC
            const userTime = new Date(utcTime.getTime() + (userTimezone * 60 * 60 * 1000));
            document.getElementById('current-time').textContent = userTime.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
        async function autoDetectTimezone() {
            if (!window.DateTimeUtils) {
                showNotification('DateTimeUtils –Ω–µ –≥–æ—Ç–æ–≤', 'error');
                return;
            }
            let detectedTz;
            if (typeof window.DateTimeUtils.detectUserTimezone === 'function') {
                detectedTz = window.DateTimeUtils.detectUserTimezone();
            } else {
                // Fallback - –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
                const offset = -new Date().getTimezoneOffset() / 60;
                detectedTz = Math.round(offset);
            }
            document.getElementById('timezone-select').value = detectedTz;
            showNotification(`–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å: UTC${detectedTz >= 0 ? '+' : ''}${detectedTz}`, 'success');
        }
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
        async function saveTimezone() {
            try {
                if (!window.DateTimeUtils) {
                    showNotification('DateTimeUtils –Ω–µ –≥–æ—Ç–æ–≤', 'error');
                    return;
                }
                const selectedTz = parseInt(document.getElementById('timezone-select').value);
                let success = false;
                if (typeof window.DateTimeUtils.setUserTimezone === 'function') {
                    success = await window.DateTimeUtils.setUserTimezone(selectedTz);
                } else {
                    // Fallback - –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ API
                    try {
                        const user = Auth.getCurrentUser();
                        if (user) {
                            const response = await fetch('/api/user/timezone', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    user_id: user.id,
                                    timezone: selectedTz
                                })
                            });
                            if (response.ok) {
                                window.DateTimeUtils.userTimezone = selectedTz;
                                success = true;
                            }
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ fallback —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                    }
                }
                if (success) {
                    showNotification('–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
                    await loadTimezoneSettings();
                } else {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞', 'error');
            }
        }
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
        function onTimezoneChange() {
            const selectedTz = parseInt(document.getElementById('timezone-select').value);
            document.getElementById('current-timezone').textContent = `UTC${selectedTz >= 0 ? '+' : ''}${selectedTz}`;
        }
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
        document.addEventListener('DOMContentLoaded', function() {
            const timezoneSelect = document.getElementById('timezone-select');
            if (timezoneSelect) {
                timezoneSelect.addEventListener('change', onTimezoneChange);
            }
        });
    </script>
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-medium);
            transition: var(--transition-fast);
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition-fast);
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--tg-blue);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</body>
</html>