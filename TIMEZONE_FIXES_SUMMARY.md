# Исправления работы с часовыми поясами

## Проблемы, которые были исправлены

### 1. **Сохранение дат в БД**
**Проблема**: Даты сохранялись в БД в том виде, в котором их вводил пользователь (в его часовом поясе), а не в UTC.

**Исправление**: 
- Создан модуль `app/utils/datetime_utils.py` с функциями конвертации
- API теперь конвертирует пользовательские даты в UTC перед сохранением в БД
- Исправлены API endpoints: `/api/tasks` и `/api/events`

### 2. **Отображение дат пользователю**
**Проблема**: Даты отображались как есть из БД, без учета часового пояса пользователя.

**Исправление**:
- API теперь возвращает дополнительные поля с конвертированными датами:
  - `due_date_display` - полная дата в часовом поясе пользователя
  - `due_date_relative` - относительная дата ("Сегодня", "Завтра", и т.д.)
  - `start_at_display`, `end_at_display` - для событий
- Обновлены страницы dashboard и WebApp для использования новых полей

### 3. **Напоминания от бота**
**Проблема**: Время в напоминаниях отображалось неправильно.

**Исправление**:
- Обновлен `app/telegram/reminders.py`
- Время в напоминаниях теперь конвертируется в часовой пояс пользователя

## Внесенные изменения

### Новые файлы:
1. `app/utils/__init__.py` - пакет утилит
2. `app/utils/datetime_utils.py` - утилиты для работы с датами и часовыми поясами
3. `dashboard/timezone-test.html` - страница для тестирования исправлений
4. `test_timezone_fix.py` - тесты для проверки работы утилит

### Измененные файлы:

#### Backend (API):
- `app/api/tasks.py` - добавлена конвертация дат в UTC при сохранении и в пользовательский часовой пояс при отображении
- `app/api/events.py` - аналогичные изменения для событий
- `app/telegram/reminders.py` - исправлено отображение времени в напоминаниях

#### Dashboard:
- `dashboard/datetime-utils.js` - улучшена конвертация UTC дат
- `dashboard/tasks.html` - использование новых полей с конвертированными датами
- `dashboard/meetings.html` - аналогичные изменения для событий
- `dashboard/add-task.html` - упрощена логика (API сам конвертирует)
- `dashboard/task-detail.html` - исправлено отображение и редактирование дат

#### WebApp:
- `static/index.html` - использование новых полей с конвертированными датами
- `static/datetime-utils.js` - уже содержал правильную логику

## Принцип работы

### Сохранение:
1. Пользователь вводит дату в своем часовом поясе (например, "15.07.2024 14:30" в Москве UTC+3)
2. Frontend отправляет дату в API как есть
3. API получает часовой пояс пользователя из настроек
4. API конвертирует дату в UTC ("15.07.2024 11:30") и сохраняет в БД

### Отображение:
1. API загружает UTC дату из БД ("15.07.2024 11:30")
2. API получает часовой пояс пользователя из настроек
3. API конвертирует UTC дату в часовой пояс пользователя ("15.07.2024 14:30")
4. API возвращает как исходную UTC дату, так и конвертированные варианты
5. Frontend использует конвертированные даты для отображения

## Тестирование

### Автоматические тесты:
```bash
python test_timezone_fix.py
```

### Ручное тестирование:
1. Откройте `dashboard/timezone-test.html`
2. Создайте задачу или событие с датой
3. Проверьте, что дата сохраняется и отображается правильно
4. Проверьте работу в разных часовых поясах

### Проверка напоминаний:
1. Создайте событие на ближайшее время (через 60 минут)
2. Дождитесь напоминания от бота
3. Проверьте, что время в напоминании соответствует вашему часовому поясу

## Совместимость

Все изменения обратно совместимы:
- Если API не может конвертировать дату, используется fallback к старой логике
- Если новые поля недоступны, используются исходные даты
- Старые данные в БД продолжают работать

## Настройка часового пояса

Пользователи могут настроить свой часовой пояс:
- Dashboard: `/dashboard/timezone-settings.html`
- WebApp: `/static/timezone-settings.html`
- Автоопределение при первом запуске

## Поддерживаемые форматы

- Полные даты с временем: `2024-07-15T14:30:00`
- Даты без времени: `2024-07-15` (время устанавливается в 00:00)
- ISO формат с Z: `2024-07-15T14:30:00Z`
- Относительные даты: "Сегодня", "Завтра", "3 дн. назад"

## Часовые пояса

Поддерживаются смещения от UTC-12 до UTC+14:
- Отрицательные: UTC-8 (Калифорния), UTC-5 (Нью-Йорк)
- Положительные: UTC+3 (Москва), UTC+9 (Токио)
- Нулевой: UTC+0 (Лондон, Дублин)