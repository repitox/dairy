# üîÑ –°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π - –†–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### üéØ –ì–ª–∞–≤–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
- **`run_full_migration.py`** - –ü–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)
- **`user_restructure_migration.py`** - –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
- **`rollback_migration.py`** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
- **`update_code_after_migration.py`** - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **`test_migration.py`** - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π

### üìÇ –ü–æ—ç—Ç–∞–ø–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (`scripts/`)
1. **`20250118_140000_user_restructure_step1_add_id.py`** - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è `id`
2. **`20250118_141000_user_restructure_step2_temp_columns.py`** - –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
3. **`20250118_142000_user_restructure_step3_switch_columns.py`** - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫
4. **`20250118_143000_user_restructure_step4_finalize.py`** - –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ü–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
```bash
python migrations/run_full_migration.py
```

### –ü–æ—ç—Ç–∞–ø–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
```bash
# 1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
python migrations/test_migration.py

# 2. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
python migrations/user_restructure_migration.py

# 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
python migrations/update_code_after_migration.py
```

### –û—Ç–∫–∞—Ç –≤ —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º
```bash
python migrations/rollback_migration.py
```

## üìä –ß—Ç–æ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è

### –î–æ –º–∏–≥—Ä–∞—Ü–∏–∏
```sql
-- –¢–∞–±–ª–∏—Ü–∞ users
CREATE TABLE users (
    user_id BIGINT PRIMARY KEY,  -- Telegram ID
    first_name TEXT,
    username TEXT,
    registered_at TEXT,
    theme TEXT
);

-- –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ user_id
CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    user_id BIGINT,  -- –°—Å—ã–ª–∫–∞ –Ω–∞ users.user_id
    title TEXT,
    ...
);
```

### –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
```sql
-- –¢–∞–±–ª–∏—Ü–∞ users
CREATE TABLE users (
    id SERIAL PRIMARY KEY,       -- –ê–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–π ID
    telegram_id BIGINT UNIQUE,   -- Telegram ID (–±—ã–≤—à–∏–π user_id)
    first_name TEXT,
    username TEXT,
    registered_at TEXT,
    theme TEXT
);

-- –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ id
CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    user_id INTEGER,             -- –°—Å—ã–ª–∫–∞ –Ω–∞ users.id
    title TEXT,
    ...,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

## üîß –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ç–∞–±–ª–∏—Ü—ã

### –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
- **`users`** - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `id`, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ `user_id` ‚Üí `telegram_id`

### –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (10 —à—Ç.)
- `events` - –ø–æ–ª–µ `user_id`
- `notes` - –ø–æ–ª–µ `user_id`
- `project_members` - –ø–æ–ª–µ `user_id`
- `projects` - –ø–æ–ª–µ `owner_id`
- `purchases` - –ø–æ–ª–µ `user_id`
- `reminder_logs` - –ø–æ–ª–µ `user_id`
- `shopping` - –ø–æ–ª–µ `user_id`
- `shopping_lists` - –ø–æ–ª–µ `user_id`
- `tasks` - –ø–æ–ª–µ `user_id`
- `user_settings` - –ø–æ–ª–µ `user_id`

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

### –ü–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π
- ‚úÖ **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** —Å–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ë–î
- ‚úÖ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ –ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –≤ —Ä–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
- ‚úÖ –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–æ–ø–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –£–≤–µ–¥–æ–º–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏

### –í–æ –≤—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚è±Ô∏è –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è: 5-15 –º–∏–Ω—É—Ç
- üö´ –ù–ï –ø—Ä–µ—Ä—ã–≤–∞–π—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏
- üìù –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –≤—Å–µ –ª–æ–≥–∏
- üîç –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ–± –æ—à–∏–±–∫–∞—Ö

### –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
- ‚úÖ –í—ã–ø–æ–ª–Ω–∏—Ç–µ —á–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤
- ‚úÖ –£–≤–µ–¥–æ–º–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è

## üîÑ –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞

–í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º:
1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ** –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç: `python migrations/rollback_migration.py`
3. –ò–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ë–î
4. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º
5. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **`docs/USER_RESTRUCTURE_PLAN.md`** - –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏
- **`docs/MIGRATION_QUICK_START.md`** - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- **`docs/MIGRATION_ROLLBACK.md`** - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ—Ç–∫–∞—Ç—É
- **`docs/POST_MIGRATION_CHECKLIST.md`** - –ß–µ–∫-–ª–∏—Å—Ç –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (—Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

1. **–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è** - –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–º ID
2. **–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö** - –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ –¥–ª—è –≤—Å–µ—Ö —Å–≤—è–∑–µ–π
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–æ—Å—Ç—É –¥–∞–Ω–Ω—ã—Ö
5. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –ë–î

## üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:
```bash
# –¢–µ—Å—Ç –Ω–∞ –∫–æ–ø–∏–∏ –¥–∞–Ω–Ω—ã—Ö
python migrations/test_migration.py

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
python -c "
from db import get_conn
with get_conn() as conn:
    with conn.cursor() as cur:
        cur.execute('SELECT COUNT(*) FROM users')
        print(f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {cur.fetchone()[0]}')
        
        cur.execute('SELECT COUNT(*) FROM tasks')
        print(f'–ó–∞–¥–∞—á: {cur.fetchone()[0]}')
"
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ–ª–Ω—ã–µ –ª–æ–≥–∏ –æ—à–∏–±–æ–∫
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –æ—Ç–∫–∞—Ç –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
3. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–∏—á–∏–Ω—ã
4. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–æ–±–ª–µ–º—ã
5. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é

---

**–ì–æ—Ç–æ–≤—ã –∫ –º–∏–≥—Ä–∞—Ü–∏–∏? –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –∏ –±—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã!** üöÄ