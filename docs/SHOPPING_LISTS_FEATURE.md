# Система списков покупок

## Обзор

Реализована система списков покупок для dashboard части приложения. Теперь пользователи могут:
- Создавать списки покупок и привязывать их к проектам
- Добавлять товары в списки с дополнительными полями
- Просматривать покупки, сгруппированные по спискам
- Управлять списками и товарами

## Структура БД

### Таблица `shopping_lists`
```sql
CREATE TABLE shopping_lists (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    project_id INTEGER NOT NULL,
    user_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);
```

### Обновления таблицы `purchases`
Добавлены новые поля:
- `shopping_list_id INTEGER` - связь со списком покупок
- `url TEXT` - ссылка на сайт товара
- `comment TEXT` - комментарий к товару

## API Endpoints

### Списки покупок
- `GET /api/shopping-lists?user_id={id}` - получить все списки пользователя
- `POST /api/shopping-lists` - создать новый список
- `GET /api/shopping-lists/{list_id}?user_id={id}` - получить список по ID
- `PUT /api/shopping-lists/{list_id}` - обновить список
- `DELETE /api/shopping-lists/{list_id}?user_id={id}` - удалить список

### Покупки
- `GET /api/shopping-by-lists?user_id={id}` - получить товары, сгруппированные по спискам
- Существующие API для покупок обновлены для поддержки новых полей

## Страницы

### 1. `/dashboard/shopping.html`
- Обновлена для отображения покупок, сгруппированных по спискам
- Добавлены кнопки для создания списков и товаров
- Реализована логика фильтрации по статусам

### 2. `/dashboard/shopping-add.html`
- Новая страница для добавления товаров
- Поля: название, количество, цена, ссылка, комментарий
- Выбор списка покупок
- Переключатель статуса "куплено/не куплено"

### 3. `/dashboard/shopping-list-create.html`
- Новая страница для создания списков покупок
- Поля: название списка, проект
- Валидация прав доступа к проекту

## UI Компоненты

### Добавлены в UI Kit:
- `.shopping-list` - контейнер для списка покупок
- `.list-header` - заголовок списка с названием и статистикой
- `.shopping-item` - элемент товара в списке
- `.status-toggle` - переключатель статуса товара
- `.form-card` - карточка формы
- `.form-row` - строка формы с колонками
- `.status-checkbox` - чекбокс для статуса

### Обновлены стили:
- Добавлены адаптивные стили для мобильных устройств
- Стили для форм и элементов управления
- Анимации и переходы

## Функции базы данных

### Новые функции в `db.py`:
- `get_user_shopping_lists(user_id)` - получить списки пользователя
- `create_shopping_list(user_id, name, project_id)` - создать список
- `get_shopping_list(list_id, user_id)` - получить список по ID
- `update_shopping_list(list_id, user_id, name, project_id)` - обновить список
- `delete_shopping_list(list_id, user_id)` - удалить список
- `get_shopping_items_by_lists(user_id)` - получить товары по спискам

### Обновленные функции:
- `add_shopping_item()` - добавлены параметры для новых полей
- `update_shopping_item()` - добавлены параметры для новых полей
- `get_shopping_items()` - обновлен для получения новых полей

## Миграция

Выполнена миграция `20241220_120006_create_shopping_lists_table`:
- Создана таблица `shopping_lists`
- Добавлены новые поля в таблицу `purchases`
- Созданы дефолтные списки для существующих пользователей
- Привязаны существующие покупки к дефолтным спискам

## Особенности реализации

1. **Группировка по спискам**: Товары отображаются сгруппированными по спискам в одном потоке
2. **Валидация доступа**: Проверка прав доступа к проектам при создании/редактировании списков
3. **Дефолтные списки**: Для существующих пользователей автоматически создаются дефолтные списки
4. **Адаптивность**: Все новые компоненты адаптированы для мобильных устройств
5. **Интеграция с UI Kit**: Все компоненты добавлены в UI Kit для переиспользования

## Файлы изменений

### Новые файлы:
- `/migrations/scripts/20241220_120006_create_shopping_lists_table.py`
- `/dashboard/shopping-add.html`
- `/dashboard/shopping-list-create.html`
- `/docs/SHOPPING_LISTS_FEATURE.md`

### Измененные файлы:
- `/dashboard/shopping.html` - обновлена для работы со списками
- `/dashboard/ui-kit.html` - добавлены новые компоненты
- `/dashboard/ui-components.css` - добавлены стили для списков покупок
- `/db.py` - добавлены функции для работы со списками
- `/bot.py` - добавлены API endpoints для списков
- `/server_migrate.py` - добавлена функция миграции

## Тестирование

Система полностью готова к работе:
- Миграция выполнена успешно
- Все API endpoints работают
- UI компоненты интегрированы
- Адаптивная верстка реализована

Для тестирования:
1. Перейти на `/dashboard/shopping.html`
2. Создать новый список покупок
3. Добавить товары в список
4. Проверить группировку и фильтрацию