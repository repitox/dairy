# Рефакторинг Backend'а

## Проблемы до рефакторинга

1. **bot.py (4130 строк)** - огромный файл с дублированным кодом
2. **db.py (3581 строка)** - все функции БД в одном файле
3. Отсутствие системы тестирования
4. Смешение ответственностей
5. Дублирование кода в bot.py

## Новая архитектура

### Структура проекта

```
app/
├── __init__.py
├── main.py                    # Основное FastAPI приложение
├── core/
│   ├── __init__.py
│   └── config.py             # Конфигурация приложения
├── database/
│   ├── __init__.py
│   ├── connection.py         # Подключение к БД
│   ├── init.py              # Инициализация БД
│   ├── models/              # Модели данных
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── project.py
│   │   ├── shopping.py
│   │   ├── event.py
│   │   └── task.py
│   └── repositories/        # Репозитории для работы с БД
│       ├── __init__.py
│       ├── user_repository.py
│       └── shopping_repository.py
├── api/                     # API endpoints
│   ├── __init__.py
│   ├── auth.py
│   ├── shopping.py
│   ├── events.py
│   ├── tasks.py
│   ├── projects.py
│   ├── notes.py
│   └── dashboard.py
└── telegram/               # Telegram бот
    ├── __init__.py
    ├── bot.py             # Настройка бота
    ├── handlers.py        # Обработчики команд
    ├── reminders.py       # Система напоминаний
    └── webhook.py         # Webhook для Telegram

tests/                     # Тесты
├── __init__.py
├── conftest.py           # Конфигурация pytest
├── api/
│   ├── test_auth.py
│   └── test_shopping.py
├── database/
└── telegram/
```

## Преимущества новой архитектуры

### 1. Разделение ответственностей
- **API слой** - только обработка HTTP запросов
- **Репозитории** - работа с базой данных
- **Модели** - структуры данных
- **Telegram** - логика бота отдельно

### 2. Тестируемость
- Каждый компонент можно тестировать изолированно
- Async тесты с httpx
- Фикстуры для тестовых данных
- Покрытие кода

### 3. Масштабируемость
- Легко добавлять новые API endpoints
- Простое расширение функциональности
- Четкая структура проекта

### 4. Поддерживаемость
- Небольшие файлы (< 200 строк)
- Понятная структура
- Отсутствие дублирования кода

## Система тестирования

### Современные подходы к тестированию FastAPI

1. **Async тестирование с httpx**
   ```python
   @pytest.mark.asyncio
   async def test_api_endpoint(client: AsyncClient):
       response = await client.get("/api/endpoint")
       assert response.status_code == 200
   ```

2. **Фикстуры для тестовых данных**
   ```python
   @pytest.fixture
   def test_user_data():
       return {"telegram_id": 123, "name": "Test"}
   ```

3. **Тестовая база данных**
   - SQLite для быстрых тестов
   - Изоляция тестов
   - Автоматическая очистка

4. **Покрытие кода**
   - pytest-cov для анализа покрытия
   - Минимум 80% покрытия
   - HTML отчеты

### Запуск тестов

```bash
# Установка зависимостей для тестирования
pip install -r requirements-test.txt

# Запуск всех тестов
pytest

# Запуск с покрытием
pytest --cov=app --cov-report=html

# Запуск конкретного теста
pytest tests/api/test_shopping.py::test_add_shopping_item
```

## Миграция

### Этапы миграции

1. **Этап 1** - Создание новой структуры (✅ Выполнено)
2. **Этап 2** - Перенос API endpoints
3. **Этап 3** - Перенос остальных репозиториев
4. **Этап 4** - Полное покрытие тестами
5. **Этап 5** - Замена старых файлов

### Совместимость

- Старые файлы остаются для совместимости
- Новое приложение запускается через `main_refactored.py`
- Постепенный перенос функциональности

## Следующие шаги

1. Завершить перенос всех API endpoints
2. Создать репозитории для событий, задач, проектов
3. Добавить интеграционные тесты
4. Настроить CI/CD для автоматического запуска тестов
5. Провести нагрузочное тестирование

## Команды для разработки

```bash
# Запуск нового приложения
python main_refactored.py

# Запуск тестов
pytest

# Проверка покрытия
pytest --cov=app

# Линтинг кода
flake8 app/
black app/
```