# üîÑ –°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –º–µ–∂–¥—É –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–æ–π (Docker) –∏ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–æ–º (NetAngels).

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
migrations/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ migration_manager.py    # –û—Å–Ω–æ–≤–Ω–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–π
‚îî‚îÄ‚îÄ scripts/               # –°–∫—Ä–∏–ø—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–π
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ 20241220_120000_initial_schema.py
    ‚îú‚îÄ‚îÄ 20241220_120001_add_extended_fields.py
    ‚îú‚îÄ‚îÄ 20241220_120002_create_purchases_table.py
    ‚îî‚îÄ‚îÄ 20241220_120003_default_user_settings.py

deploy_sync.py             # –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ª–æ–∫–∞–ª <-> –ø—Ä–æ–¥–∞–∫—à–Ω
server_migrate.py          # –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π (–ª–æ–∫–∞–ª –∏ –ø—Ä–æ–¥–∞–∫—à–Ω)
python deploy_sync.py status

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î —Å –ø—Ä–æ–¥–∞–∫—à–Ω
python deploy_sync.py sync

# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
python deploy_sync.py create --name add_new_field

# –°–æ–∑–¥–∞—Ç—å –¥–∞–º–ø—ã —Å—Ö–µ–º –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
python deploy_sync.py dump
```

### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ NetAngels

1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª `server_migrate.py` –Ω–∞ —Å–µ—Ä–≤–µ—Ä
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
python3 server_migrate.py status

# –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
python3 server_migrate.py migrate
```

## üìù –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞

```bash
python deploy_sync.py create --name add_user_avatar
```

–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç —Ñ–∞–π–ª `migrations/scripts/YYYYMMDD_HHMMSS_add_user_avatar.py`

### 2. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```python
"""
–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
"""

def up(cursor):
    """–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é"""
    
    cursor.execute("""
        ALTER TABLE users 
        ADD COLUMN avatar_url TEXT;
    """)
    
    cursor.execute("""
        CREATE INDEX IF NOT EXISTS idx_users_avatar 
        ON users(avatar_url);
    """)
    
    print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ avatar_url")


def down(cursor):
    """–û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é"""
    
    cursor.execute("DROP INDEX IF EXISTS idx_users_avatar;")
    cursor.execute("ALTER TABLE users DROP COLUMN IF EXISTS avatar_url;")
    
    print("‚úÖ –ü–æ–ª–µ avatar_url —É–¥–∞–ª–µ–Ω–æ")
```

### 3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
python deploy_sync.py sync

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
python3 server_migrate.py migrate
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### –õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î (Docker)
```
postgresql://postgres:password@localhost:5432/telegram_app
```

### –ü—Ä–æ–¥–∞–∫—à–Ω –ë–î (NetAngels)
```
Host: postgres.c107597.h2
Database: c107597_rptx_na4u_ru
User: c107597_rptx_na4u_ru
Password: ZiKceXoydixol93
Port: 5432
```

## üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

–°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—É `schema_migrations` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π:

```sql
CREATE TABLE schema_migrations (
    id SERIAL PRIMARY KEY,
    version VARCHAR(255) UNIQUE NOT NULL,
    name TEXT NOT NULL,
    executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    checksum TEXT
);
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç
- –ö–∞–∂–¥–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
- –í–µ–¥—ë—Ç—Å—è –ª–æ–≥ –≤—Å–µ—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π

## üìã –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

1. **20241220_120000_initial_schema** - –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–π —Å—Ö–µ–º—ã –ë–î
2. **20241220_120001_add_extended_fields** - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π –∏ –∏–Ω–¥–µ–∫—Å–æ–≤
3. **20241220_120002_create_purchases_table** - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã purchases
4. **20241220_120003_default_user_settings** - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è

1. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ —Å Docker
2. –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ª–æ–∫–∞–ª—å–Ω–æ
4. –ó–∞–≥—Ä—É–∑–∫–∞ `server_migrate.py` –Ω–∞ —Å–µ—Ä–≤–µ—Ä
5. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω
6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

## üÜò –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
python deploy_sync.py status
```

### –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤ —Ñ–∞–π–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏ up() –∏ down() –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
```

### –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
```python
# –í migration_manager.py –µ—Å—Ç—å –º–µ—Ç–æ–¥ rollback_migration()
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω!
```

## üìà –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è:

- –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ `migrations/scripts/`
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏–º–µ–Ω–∏: `YYYYMMDD_HHMMSS_description.py`
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ `up()` –∏ `down()`
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

## üéØ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. **–ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏–π
2. **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å**: –û–¥–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è = –æ–¥–Ω–æ –ª–æ–≥–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
3. **–û–±—Ä–∞—Ç–∏–º–æ—Å—Ç—å**: –í—Å–µ–≥–¥–∞ —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `down()`
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ
5. **–ë—ç–∫–∞–ø—ã**: –î–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω