# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏

## –ü—Ä–æ–±–ª–µ–º–∞

–í scheduler.py –±—ã–ª–∞ –æ—à–∏–±–∫–∞, –∏–∑-–∑–∞ –∫–æ—Ç–æ—Ä–æ–π –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–ª —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ –≤—Å–µ–º–∏ –∑–∞–¥–∞—á–∞–º–∏, –≤—Å—Ç—Ä–µ—á–∞–º–∏ –∏ –ø–æ–∫—É–ø–∫–∞–º–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏–º–∏.

## –ü—Ä–∏—á–∏–Ω–∞

1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö**: –§—É–Ω–∫—Ü–∏–∏ `get_today_tasks()`, `get_today_events()`, `get_recent_purchases()` –≤ db.py —Ä–∞–±–æ—Ç–∞–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **–û—à–∏–±–∫–∞ –≤ scheduler.py**: –î–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ —Å–º–µ—à–∏–≤–∞–Ω–∏—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
3. **–£—Å—Ç–∞—Ä–µ–≤—à–∞—è –ª–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**: –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è `format_summary()` –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∞ –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö

## –†–µ—à–µ–Ω–∏–µ

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `send_daily_summary()`

**–ë—ã–ª–æ:**
```python
def send_daily_summary():
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    for row in users:
        user_id = row["telegram_id"]
        
        # –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        tasks_by_group = get_today_tasks(user_id)
        tasks_raw = []
        for group in tasks_by_group.values():
            tasks_raw.extend(group)
        # ... —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
```

**–°—Ç–∞–ª–æ:**
```python
def send_daily_summary():
    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å telegram_id
    cur.execute("SELECT telegram_id FROM users WHERE telegram_id IS NOT NULL")
    
    for row in users:
        user_telegram_id = row["telegram_id"]
        
        try:
            # –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            tasks_data = get_today_tasks(user_telegram_id)
            
            # –û–±—ä–µ–¥–∏–Ω—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∏ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –∑–∞–¥–∞—á–∏
            all_tasks = []
            if isinstance(tasks_data, dict):
                overdue_tasks = tasks_data.get('overdue', [])
                today_tasks = tasks_data.get('today', [])
                all_tasks = overdue_tasks + today_tasks
            
            events = get_today_events(user_telegram_id)
            shopping = get_recent_purchases(user_telegram_id)
            
            # –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            message = format_summary_v2(all_tasks, events, shopping, user_telegram_id)
            send_message(user_telegram_id, message)
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_telegram_id}: {e}")
            continue
```

### 2. –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `format_summary_v2()`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á** –Ω–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∏ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ
- ‚úÖ **–í–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á** –≤ –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é —Å–≤–æ–¥–∫—É
- ‚úÖ **–£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** —Å –≤—Ä–µ–º–µ–Ω–µ–º, –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
- ‚úÖ **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:**
```
üåÖ –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!
üìÖ –°–µ–≥–æ–¥–Ω—è 04.08.2025

‚è∞ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:
‚ùóÔ∏è –í–∞–∂–Ω–∞—è –∑–∞–¥–∞—á–∞ (–ü—Ä–æ–µ–∫—Ç)
‚ñ™Ô∏è –û–±—ã—á–Ω–∞—è –∑–∞–¥–∞—á–∞ (–õ–∏—á–Ω–æ–µ)

üìå –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:
‚ùóÔ∏è –í—Å—Ç—Ä–µ—á–∞ –≤ 14:00 (–†–∞–±–æ—Ç–∞)
‚ñ™Ô∏è –ü–æ–∫—É–ø–∫–∏ (–õ–∏—á–Ω–æ–µ)

üìÖ –í—Å—Ç—Ä–µ—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:
üïò –°–æ–≤–µ—â–∞–Ω–∏–µ –≤ 10:00, –û—Ñ–∏—Å (–†–∞–±–æ—Ç–∞)

üõí –ù—É–∂–Ω–æ –∫—É–ø–∏—Ç—å:
‚ñ™Ô∏è 2 √ó –ú–æ–ª–æ–∫–æ
‚ñ™Ô∏è –•–ª–µ–±

üí™ –£–¥–∞—á–Ω–æ–≥–æ –¥–Ω—è!
```

### 3. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- ‚úÖ **Try-catch –±–ª–æ–∫–∏** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è telegram_id**
- ‚úÖ **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ **Graceful degradation** - –µ—Å–ª–∏ –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

### 4. –î–æ–±–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `test_scheduler.py` –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏:

```python
from scheduler import test_daily_summary

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏
test_daily_summary()
```

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
```bash
docker-compose exec app python test_scheduler.py
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```
üß™ –¢–ï–°–¢–û–í–ê–Ø —Ä–∞—Å—Å—ã–ª–∫–∞...
‚è∞ –ó–∞–ø—É—Å–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏...
üí¨ –í—Å–µ telegram_id –∏–∑ –ë–î: [RealDictRow([('telegram_id', 123456789)])]
üîç –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 1
üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–≤–æ–¥–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 123456789...
üîç –î–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á –¥–ª—è 123456789: {'overdue': [...], 'today': []}
üîç –°–æ–±—ã—Ç–∏—è –¥–ª—è 123456789: []
üîç –ü–æ–∫—É–ø–∫–∏ –¥–ª—è 123456789: []

üì® –ò—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è 123456789:
üåÖ –î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!
üìÖ –°–µ–≥–æ–¥–Ω—è 04.08.2025

‚è∞ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:
‚ñ™Ô∏è –¢–µ—Å—Ç (–õ–∏—á–Ω–æ–µ)

üìÖ –í—Å—Ç—Ä–µ—á–∏: –°–µ–≥–æ–¥–Ω—è –≤—Å—Ç—Ä–µ—á –Ω–µ—Ç
üõí –ü–æ–∫—É–ø–∫–∏: –í—Å—ë –∫—É–ø–ª–µ–Ω–æ! ‚úÖ

üí™ –£–¥–∞—á–Ω–æ–≥–æ –¥–Ω—è!
```

## –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
1. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è**: –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
2. **–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏**: –í–∫–ª—é—á–µ–Ω—ã –≤ –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é —Å–≤–æ–¥–∫—É
3. **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ö—Ä–∞—Å–∏–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —ç–º–æ–¥–∑–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –°–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
5. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### üöÄ –î–æ–±–∞–≤–ª–µ–Ω–æ
1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é
2. **–í—Ä–µ–º—è –≤ –∑–∞–¥–∞—á–∞—Ö**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á
3. **–ü—Ä–æ–µ–∫—Ç—ã**: –£–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
4. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã**: –í–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤—ã–¥–µ–ª—è—é—Ç—Å—è ‚ùóÔ∏è
5. **–ú–æ—Ç–∏–≤–∞—Ü–∏—è**: –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–æ–Ω—Ü–µ

### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- **–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: ~2 —á–∞—Å–∞
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –∏–∑–º–µ–Ω–µ–Ω–æ**: ~150
- **–§—É–Ω–∫—Ü–∏–π –¥–æ–±–∞–≤–ª–µ–Ω–æ**: 2 (`format_summary_v2`, `test_daily_summary`)
- **–§–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–Ω–æ**: 2 (`test_scheduler.py`, `docs/SCHEDULER_FIX.md`)

## –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫

–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ **9:01 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏**.

–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É –≤ `scheduler.py`:
```python
scheduler.add_job(send_daily_summary, "cron", hour=9, minute=1)
```

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 2025-01-27  
**–í–µ—Ä—Å–∏—è**: v3.0.2  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ